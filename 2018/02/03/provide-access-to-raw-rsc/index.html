<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>Item-15 Provide access to raw resource in resource-managing classes - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>Item-15 Provide access to raw resource in resource-managing classes</h1>
  </div>
<div class="meta">
  <div>2018-02-03 00:00</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>Each RAII class should offer a way to get at the resource it manages.</p>
<!-- toc -->
<p>From time to time, some APIs require access to raw resources, so it is a good habit to design the resource-managing classes in such a way that it provides access to raw resources. For example, suppose there's a function we'd like to use with <code>Investment</code> objects, which is managed by smart pointer:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">int</span> <span style="color:#75af00">daysHeld</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Investment</span> <span style="color:#f92672">*</span><span style="color:#111">pi</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// return number of days investment has been held
</span><span style="color:#75715e"></span>
<span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">tr1</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">shared_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">Investment</span><span style="color:#f92672">&gt;</span> <span style="color:#111">pInv</span><span style="color:#111">(</span><span style="color:#111">createInvestment</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// item 13
</span></code></pre></td></tr></table>
</div>
</div><p>Since <code>dayHeld</code> wants a raw <code>Investment*</code> pointer, if passing an object of type <code>tr1::shared_ptr&lt;Investment&gt;</code>, the code won't compile:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">ind</span> <span style="color:#111">days</span> <span style="color:#f92672">=</span> <span style="color:#111">daysHeld</span><span style="color:#111">(</span><span style="color:#111">pInv</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// error
</span></code></pre></td></tr></table>
</div>
</div><p>We need to find a way to get the access to the raw resources, and generally there are two ways:</p>
<ol>
<li>Implicit conversion (convenient for clients)</li>
<li>Explicit conversion (generally preferred)</li>
</ol>
<h1 id="implicit-conversion">Implicit conversion</h1>
<p>Pointer dereferencing operators (<code>operator-&gt;</code> and <code>operator*</code>) are implicit conversion to the underlying raw pointers, which is virtually provided by all smart pointer classes. Suppose there's a member function <code>bool isTaxFree()</code> inside the class <code>Investment</code>, and we can access the member function like this:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">bool</span> <span style="color:#111">taxable1</span> <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#111">(</span><span style="color:#111">pInv</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">isTaxFree</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// access resource via operator-&gt;
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">bool</span> <span style="color:#111">taxable2</span> <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#111">(</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">pInv</span><span style="color:#111">)</span><span style="color:#111">.</span><span style="color:#111">isTaxFree</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// access resource via operator*
</span></code></pre></td></tr></table>
</div>
</div><p>When it is necessary to get at the raw resource inside an RAII object, another way of conversion is through an <em>implicit conversion function</em>. Consider following RAII class for fonts:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">FontHandle</span> <span style="color:#75af00">getFont</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// from C API
</span><span style="color:#75715e"></span><span style="color:#00a8c8">void</span> <span style="color:#75af00">releaseFont</span><span style="color:#111">(</span><span style="color:#111">FontHandle</span> <span style="color:#111">fh</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// from the same C API
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">Font</span> <span style="color:#111">{</span>   <span style="color:#75715e">// self-defined RAII class
</span><span style="color:#75715e"></span><span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">explicit</span> <span style="color:#111">Font</span><span style="color:#111">(</span><span style="color:#111">FontHanlde</span> <span style="color:#111">fh</span><span style="color:#111">)</span>  <span style="color:#75715e">// acquire resource
</span><span style="color:#75715e"></span>    <span style="color:#f92672">:</span> <span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">fh</span><span style="color:#111">)</span>                       <span style="color:#75715e">// use pass-by-value because the C API does
</span><span style="color:#75715e"></span>    <span style="color:#111">{</span><span style="color:#111">}</span>
    <span style="color:#f92672">~</span><span style="color:#111">Font</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#111">releaseFont</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>   <span style="color:#75715e">// release resource
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">operator</span> <span style="color:#75af00">FontHandle</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span> <span style="color:#111">{</span><span style="color:#00a8c8">return</span> <span style="color:#111">f</span><span style="color:#111">;</span><span style="color:#111">}</span>  <span style="color:#75715e">// implicit conversion function
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">FontHandle</span> <span style="color:#111">f</span><span style="color:#111">;</span>                 <span style="color:#75715e">// the raw font resource
</span><span style="color:#75715e"></span><span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>This makes calling into the following C API easy and natural:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#75af00">changeFontSize</span><span style="color:#111">(</span><span style="color:#111">FontHandle</span> <span style="color:#111">f</span><span style="color:#111">,</span> <span style="color:#00a8c8">int</span> <span style="color:#111">newSize</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// the C API
</span><span style="color:#75715e"></span>
<span style="color:#111">Font</span> <span style="color:#75af00">f</span><span style="color:#111">(</span><span style="color:#111">getFont</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#00a8c8">int</span> <span style="color:#111">newFontSize</span><span style="color:#111">;</span>
<span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">changeFontSize</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#111">,</span> <span style="color:#111">newFontSize</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// implicitly convert Font to FontHandle
</span></code></pre></td></tr></table>
</div>
</div><p>However, the downsize is that implicit conversions increase the chance of errors - a <code>FontHandle</code> may be created when a <code>Font</code> is really intended:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">Font</span> <span style="color:#75af00">f1</span><span style="color:#111">(</span><span style="color:#111">getFont</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">FontHandle</span> <span style="color:#111">f2</span> <span style="color:#f92672">=</span> <span style="color:#111">f1</span><span style="color:#111">;</span>  <span style="color:#75715e">// meant to copy a Font object but implicitly converted f1 into 
</span><span style="color:#75715e"></span>                     <span style="color:#75715e">// FontHandle, and copied the underlying resource
</span></code></pre></td></tr></table>
</div>
</div><h1 id="explicit-conversion">Explicit conversion</h1>
<p>In order to avoid unintended implicit conversion, an explicit conversion function like <code>get</code> is a preferable path. We can exchange the implicit convertion function to following explicit one:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Font</span> <span style="color:#111">{</span>
<span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">FontHandle</span> <span style="color:#111">get</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#111">f</span><span style="color:#111">;</span> <span style="color:#111">}</span>  <span style="color:#75715e">// explicit conversion function
</span><span style="color:#75715e"></span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
<span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#75715e">// and use it like this:
</span><span style="color:#75715e"></span><span style="color:#111">changeFontSize</span><span style="color:#111">(</span><span style="color:#111">f</span><span style="color:#111">.</span><span style="color:#111">get</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">newFontSize</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// explicitly convert Font to FontHandle
</span></code></pre></td></tr></table>
</div>
</div><p>Both explicit conversion and implicit conversion make sense, and the preference depends on the specific task and the circumstances in which the RAII class performs, as long as one adheres to item 18's advice: to make interfaces easy to use correctly and hard to use incorrectly.</p></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
