<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>Item-28 Avoid returning handles to object internals - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>Item-28 Avoid returning handles to object internals</h1>
  </div>
<div class="meta">
  <div>2018-02-16 12:26</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>Avoid returning handles to object internals to increase encapsulation, help <code>const</code> member functions act <code>const</code>, and minimize the creation of dangling handles.</p>
<p>References, pointers, and iterators are all <em>handlers</em> (ways to get at other objects), and returning a handle to an object's internals always runs the risk of</p>
<ol>
<li>compromising an object's encapsulation</li>
<li>making <code>const</code> member functions act like non-<code>const</code> ones, allowing an object's state to be modified</li>
<li>leading to dangling handles</li>
</ol>
<p>To see how handlers result in these resks, let's see an example.<br>
Suppose we're working with a rectangle class, represented by its upper left corner and lower right corner. To keep a <code>Rectangle</code> object small, we decide that the corner points should be stored in an auxiliary struct that the <code>Rectangle</code> points to:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Point</span> <span style="color:#111">{</span>  <span style="color:#75715e">// class representing points
</span><span style="color:#75715e"></span><span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">Point</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">x</span><span style="color:#111">,</span> <span style="color:#00a8c8">int</span> <span style="color:#111">y</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#00a8c8">void</span> <span style="color:#111">setX</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">newVal</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">void</span> <span style="color:#75af00">setY</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">newVal</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">struct</span> <span style="color:#75af00">RectData</span> <span style="color:#111">{</span>  <span style="color:#75715e">// Rectangle corner point data
</span><span style="color:#75715e"></span>    <span style="color:#111">Point</span> <span style="color:#111">ulhc</span><span style="color:#111">;</span>    <span style="color:#75715e">// &#34;upper left-hand corner&#34;
</span><span style="color:#75715e"></span>    <span style="color:#111">Point</span> <span style="color:#111">lrhc</span><span style="color:#111">;</span>    <span style="color:#75715e">// &#34;lower right-hand corner&#34;
</span><span style="color:#75715e"></span><span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Rectangle</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">Point</span><span style="color:#f92672">&amp;</span> <span style="color:#111">upperLeft</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#111">pData</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">ulhc</span><span style="color:#111">;</span> <span style="color:#111">}</span>
    <span style="color:#111">Point</span><span style="color:#f92672">&amp;</span> <span style="color:#111">lowerRight</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#111">pData</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">lrhc</span><span style="color:#111">;</span> <span style="color:#111">}</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">tr1</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">shared_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">RectData</span><span style="color:#f92672">&gt;</span> <span style="color:#111">pData</span><span style="color:#111">;</span> <span style="color:#75715e">// see item 13 for tr1::shared_ptr
</span><span style="color:#75715e"></span>    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>As item 20 suggests that  passing user-defined types by reference is typically more efficient than passing them by value, the two public member functions return references to the underlying <code>Point</code> ojects. Yet this design is wrong, for it's self-contradictory:</p>
<ul>
<li>
<p>on the one side, the two member functions are declared <code>const</code>, indicating read-only access level of the point they return</p>
</li>
<li>
<p>on the other side, returning handles to private internal data lets callers be able to modify that internal data:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">Point</span> <span style="color:#75af00">coord1</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">Point</span> <span style="color:#75af00">coord3</span><span style="color:#111">(</span><span style="color:#ae81ff">100</span><span style="color:#111">,</span> <span style="color:#ae81ff">100</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#00a8c8">const</span> <span style="color:#111">Rectangle</span> <span style="color:#75af00">rec</span><span style="color:#111">(</span><span style="color:#111">coord1</span><span style="color:#111">,</span> <span style="color:#111">coord2</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// rec is a const rectangle from (0,0) to (100,100)
</span><span style="color:#75715e"></span><span style="color:#111">rec</span><span style="color:#111">.</span><span style="color:#111">upperLeft</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">.</span><span style="color:#111">setX</span><span style="color:#111">(</span><span style="color:#ae81ff">50</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// now (50,0) to (100,100)
</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>Apparently, by returning handles to the <em>private</em> <code>ulhc</code> and <code>lrhc</code> through the <em>public</em> member functions <code>upperLeft</code> and <code>lowerRight</code>, the overall access level of data member goes to <code>public</code>, and the encapsulation decreases. This makes the risk 1 above.</p>
<p>The second risk comes from the fact that if a <code>const</code> member function returns a reference (or any other handles) to data associated with an object that is stored outside the object itself, the caller of the function can modify that data due to its fallout of the limitation of bitwise constness (item 3).</p>
<p>You may think the two risks above may be eliminated by applying <code>const</code> to the return types:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Rectangle</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#00a8c8">const</span> <span style="color:#111">Point</span><span style="color:#f92672">&amp;</span> <span style="color:#111">upperLeft</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#111">pData</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">ulhc</span><span style="color:#111">;</span> <span style="color:#111">}</span>
    <span style="color:#00a8c8">const</span> <span style="color:#111">Point</span><span style="color:#f92672">&amp;</span> <span style="color:#111">lowerRight</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#111">pData</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">lrhc</span><span style="color:#111">;</span> <span style="color:#111">}</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>With this altered design, the 2 problems above are indeed solved. Even so, the dangling handles in risk 3 are still possible.</p>
<blockquote>
<p>Dangling handles: handles that refer to parts of objects that don't exist any longer.</p>
</blockquote>
<p>In fact, function return values are the most common source of dangling handles. Consider a function that returns the bounding box for a GUI object in the form of a rectangle:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">GUIObject</span> <span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span><span style="color:#111">;</span>
<span style="color:#00a8c8">const</span> <span style="color:#111">Rectangle</span> <span style="color:#75af00">boundingBox</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">GUIObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">obj</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// returns a rectangle by value; see item 3 for why return type is const
</span></code></pre></td></tr></table>
</div>
</div><p>If client use this function like this:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">GUIObject</span> <span style="color:#f92672">*</span><span style="color:#111">pgo</span><span style="color:#111">;</span>  <span style="color:#75715e">// make pgo point to some GUIObject
</span><span style="color:#75715e"></span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">const</span> <span style="color:#111">Point</span> <span style="color:#f92672">*</span><span style="color:#111">pUpperLeft</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#111">(</span><span style="color:#111">boundingBox</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">pgo</span><span style="color:#111">)</span><span style="color:#111">.</span><span style="color:#111">upperLeft</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// get a ptr to the upper left point of its bounding box
</span></code></pre></td></tr></table>
</div>
</div><p>This is a good example for dangling handle. The call to <code>boundingBox</code> will return a new, temporary <code>Rectangle</code> object. Let's call it <em>temp</em>. <code>upperLeft</code> will then be called on <em>temp</em>, and that call will return a reference to an internal part of <em>temp</em> (i.e., the upperLeft corner point), to which <code>pUpperLeft</code> will then point. The tragedy comes at the end of the statement, when <code>boundongBox</code>'s return value <em>temp</em> is destroyed, and then it indirectly leads to the destruction of <em>temp</em>&lsquo;s upperLeft corner point, leaving <code>pUpperLeft</code> pointing to an object that no longer exists.</p>
<p>As long as a handle is being returned, we run the risk that the handle will outlive the object it refers to. But this doesn't mean we should <em>never</em> have a member function that returns a handle. Sometimes we have to - an exception is <code>operator[]</code> in <code>string</code> and <code>vector</code>, which works by returning references to the data in the containers (item 3), and that data will be destroyed when the containers themselves are.</p>
<blockquote>
<p>P.S.: by the way, we generally think of an object's &ldquo;internals&rdquo; as its data members, but member functions not accessible to the general public (<code>private</code> and <code>protected</code> ones) are part of an object's internals, too. Thus it's important not to return handles to them (i.e., never have a member function return a pointer to a less accessible member function), otherwise the access level will be that of the more accessible function, just like how the risk 1 shows us.</p>
</blockquote></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
