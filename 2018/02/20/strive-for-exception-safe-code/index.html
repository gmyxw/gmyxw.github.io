<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>Item-29 Strive for exception-safe code - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>Item-29 Strive for exception-safe code</h1>
  </div>
<div class="meta">
  <div>2018-02-20 18:23</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>Exception-safe functions leak no resources and allow no data structures to become corrupted, even when exceptions are thrown. Such functions offer the basic, strong, and nothrow guarantees.</p>
<!-- toc -->
<p>For exception-safe functions, there are two requirements when an exception is thrown:</p>
<ol>
<li>Leak no resources</li>
<li>Don't allow data structures to become corrupted</li>
</ol>
<p>Specifically, from the perspective of data structure corruption, exception-safe functions must offer one of three guarantees below from the weakest to the strongest:</p>
<ol>
<li>The <strong>basic guarantee</strong> promises that if an exception is thrown, everything in the program remains in a valid state - all class invariants are satisfied, but the exact state of the program may not be predictable.</li>
<li>The <strong>strong guarantee</strong> promises that if an exception is thrown, the state of the program is unchanged - calls to such functions are <em>atomic</em> in the sense that if they succeed, they successd completely, and if they fail, the program state is as if they'd never been called.</li>
<li>The <strong>nothrow guarantee</strong> promises never to throw exceptions - all operators on built-in types (e.g., <code>int</code>s, pointers, etc.) are nothrow. This is a critical building block of exception-safe code.</li>
</ol>
<h1 id="example">Example</h1>
<p>With all these terminologies bear in mind, let's see an example representing exception-unsafe style. Suppose there's a class for GUI menus with background images, and it will be used in a threaded environment, so it has a mutex for concurrency control:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">PrettyMenu</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#00a8c8">void</span> <span style="color:#111">changeBackGround</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">istream</span><span style="color:#f92672">&amp;</span> <span style="color:#111">imgSrc</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// change background image
</span><span style="color:#75715e"></span><span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">Mutex</span> <span style="color:#111">mutex</span><span style="color:#111">;</span>      <span style="color:#75715e">// mutex for this obejct
</span><span style="color:#75715e"></span>    <span style="color:#111">Image</span> <span style="color:#f92672">*</span><span style="color:#111">bgImage</span><span style="color:#111">;</span>   <span style="color:#75715e">// current background image
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">int</span> <span style="color:#111">imageChanges</span><span style="color:#111">;</span> <span style="color:#75715e">// # of times image has been changed
</span><span style="color:#75715e"></span><span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#111">PrettyMenu</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">changeBackground</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">istream</span><span style="color:#f92672">&amp;</span> <span style="color:#111">imgSrc</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#111">mutex</span><span style="color:#111">)</span><span style="color:#111">;</span>   <span style="color:#75715e">// acquire mutex (item 14)
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">delete</span> <span style="color:#111">bgImage</span><span style="color:#111">;</span> <span style="color:#75715e">// get rid of old background
</span><span style="color:#75715e"></span>    <span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">imageChanges</span><span style="color:#111">;</span> <span style="color:#75715e">// update image change count
</span><span style="color:#75715e"></span>    <span style="color:#111">bgImage</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">Image</span><span style="color:#111">(</span><span style="color:#111">imgSrc</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// install new background
</span><span style="color:#75715e"></span>    <span style="color:#111">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#111">mutex</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// release mutex 
</span><span style="color:#75715e"></span><span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Firstly, the code above is likely to encounter resource leak, because if the <code>new Image(imgSrc)</code> expression yields an exception, the call to <code>unlock</code> never gets executed, and the mutex is held forever.</p>
<p>Secondly, this function guarantees none of the 3 promises in terms of data structure corruption above: when <code>new Image(Src)</code> throws, <code>bgImage</code> is left pointing to a deleted object, and <code>imageChanges</code> has been increamented before the new image has been installed, resulting to invalid object state.</p>
<h2 id="resource-leak">Resource leak</h2>
<p>To address the resource leak issue, we can use objects to manage resources (item 13), and take advantage of <code>Lock</code> class to ensure that mutexes are released in a timely fashion (item 14):</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#111">PrettyMenu</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">changeBackground</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">istream</span><span style="color:#f92672">&amp;</span> <span style="color:#111">imgSrc</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">Lock</span> <span style="color:#75af00">ml</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#111">mutex</span><span style="color:#111">)</span><span style="color:#111">;</span>   <span style="color:#75715e">// item 14: acquire mutex and ensure its later release
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">delete</span> <span style="color:#111">bgImage</span><span style="color:#111">;</span> 
    <span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">imageChanges</span><span style="color:#111">;</span> <span style="color:#75715e">// update image change count
</span><span style="color:#75715e"></span>    <span style="color:#111">bgImage</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">Image</span><span style="color:#111">(</span><span style="color:#111">imgSrc</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// install new background
</span><span style="color:#75715e"></span><span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="data-structure-corruption">Data structure corruption</h2>
<p>To address the issue of data structure corruption, we may need to determine which guarantee to offer. As a general rule,</p>
<blockquote>
<p>we want to offer <em>the strongest</em> guarantee that's <em>practical</em>.</p>
</blockquote>
<p>Note the word <em>practical</em>. We definitely want to offer nothrow guarantee for every functions we write, but it's hard to keep such a promise - to name a common exception: anything using dynamically allocated memory (e.g., all STL containers) runs the risk of a <code>bad_alloc</code> exception if it can't find enough memory to satisfy a request (item 49). For most functions, the choice for us is between the basic and strong guarantees.</p>
<p>In the case of <code>changeBackground</code>, <em>almost</em> offering the strong guarantee is not difficult:</p>
<ul>
<li>firstly, we change the type of <code>bgImage</code> data member in <code>PrettyMunu</code> from a built-in <code>Image*</code> pointer to smart pointer such as <code>tr1::shraed_ptr</code> (item 13), which benefits us with
<ol>
<li>preventing resource leaks</li>
<li>offering strong exception safety guarantee</li>
</ol>
</li>
<li>secondly, we reorder the statements so that we don't increment <code>imageChanges</code> until the image has been changed.</li>
</ul>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">PrettyMenu</span> <span style="color:#111">{</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">tr1</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">shared_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">Imgae</span><span style="color:#f92672">&gt;</span> <span style="color:#111">bgImage</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#111">PrettyMenu</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">changeBackground</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">istream</span><span style="color:#f92672">&amp;</span> <span style="color:#111">imgSrc</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">Lock</span> <span style="color:#75af00">ml</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#111">mutex</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">bgImage</span><span style="color:#111">.</span><span style="color:#111">reset</span><span style="color:#111">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">Image</span><span style="color:#111">(</span><span style="color:#111">imgSrc</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// replace bgImage&#39;s internal pointer with the
</span><span style="color:#75715e"></span>                                      <span style="color:#75715e">// result of the &#34;new Image&#34; expression
</span><span style="color:#75715e"></span>    <span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">imageChanges</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Note how the use of resource magangement object (i.e., the smart pointer here) helps:</p>
<ol>
<li>The <code>tr1::shared_ptr::reset</code> function will be called only if its parameter (the result of <code>new Image(imgSrc)</code>) is successfully created</li>
<li>The <code>delete</code> operation for the old image is inside the <code>reset</code>, so if the <code>reset</code> function is never entered (the program somehow fails to create new image), the deletion of the old image will never take place</li>
<li>As a result, the deletion takes place only if the new image is successfully created</li>
<li>We don't need to manually <code>delete</code> the old image, and the length of <code>changeBackground</code> reduces</li>
</ol>
<p>After these two changes, <code>changeBackground</code> <em>almost</em> offer the strong exception safety guarantee. The only weakness now is the parameter <code>imgSrc</code>: if the <code>Image</code> constructor throws an exception, it's possible that the read marker for the input stream has been moved, which is a change in state visible to the rest of the program, leading to offering only the basic exception safety guarantee.</p>
<h3 id="copy-and-swap-strategy">Copy-and-<code>swap</code> strategy</h3>
<p>There actually is a general design strategy for offering the strong guarantee:</p>
<blockquote>
<p><strong>copy and swap</strong> strategy:<br>
Make a copy of the object we want to modify, then make all needed changes to the copy;</p>
</blockquote>
<ul>
<li>If all the changes have been successfully completed, swap the modified object with the original in a non-throwing operation (item 25);</li>
<li>If any of the modifying operations throws an exception, the original object remains unchanged.</li>
</ul>
<p>The strategy is usually implemented by putting all the per-object data from the &ldquo;real&rdquo; object into a separate implementation object, then giving the real object a pointer to its implementation object (know as the &ldquo;pimpl idiom&rdquo;, item 31). For <code>PrettyMenu</code>, it would look something like this:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">struct</span> <span style="color:#75af00">PMImpl</span> <span style="color:#111">{</span>  <span style="color:#75715e">// PMIpml = &#34;PrettyMenu Impl.&#34;
</span><span style="color:#75715e"></span>    <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">tr1</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">shared_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">Image</span><span style="color:#f92672">&gt;</span> <span style="color:#111">bgImage</span><span style="color:#111">;</span> 
    <span style="color:#00a8c8">int</span> <span style="color:#111">imageChanges</span><span style="color:#111">;</span> 
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#00a8c8">class</span> <span style="color:#75af00">PrettyMenu</span> <span style="color:#111">{</span>
<span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">Mutex</span> <span style="color:#111">mutex</span><span style="color:#111">;</span>
    <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">tr1</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">shared_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">PMImpl</span><span style="color:#f92672">&gt;</span> <span style="color:#111">pImpl</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#111">PrettyMenu</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">changeBackground</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">istream</span><span style="color:#f92672">&amp;</span> <span style="color:#111">imgSrc</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">using</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">swap</span><span style="color:#111">;</span>  <span style="color:#75715e">// item 25
</span><span style="color:#75715e"></span>    <span style="color:#111">Lock</span> <span style="color:#75af00">ml</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#111">mutex</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// acquire the mutex
</span><span style="color:#75715e"></span>    
    <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">tr1</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">shared_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">PMImpl</span><span style="color:#f92672">&gt;</span> <span style="color:#111">pNew</span><span style="color:#111">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">PMImpl</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">pImpl</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// copy obj. data
</span><span style="color:#75715e"></span>    <span style="color:#111">pNew</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">bgImage</span><span style="color:#111">.</span><span style="color:#111">reset</span><span style="color:#111">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">Image</span><span style="color:#111">(</span><span style="color:#111">imgSrc</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// modify the copy
</span><span style="color:#75715e"></span>    <span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">pNew</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">imageChanges</span><span style="color:#111">;</span>
    <span style="color:#111">swap</span><span style="color:#111">(</span><span style="color:#111">pImpl</span><span style="color:#111">,</span> <span style="color:#111">pNew</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// swap the new data into place
</span><span style="color:#75715e"></span><span style="color:#111">}</span> <span style="color:#75715e">// release the mutex
</span></code></pre></td></tr></table>
</div>
</div><p>We don't have to make the struct <code>PMImpl</code> as a class, because the encapsulation of <code>PrettyMenu</code> data is assured by <code>pImpl</code> being private, and it is more convenient to use struct. If desired, <code>PMImpl</code> could be nested inside <code>PrettyMenu</code> when considering packaging issues.</p>
<h3 id="side-effects-and-efficiency">Side effects and efficiency</h3>
<p>Even with the help of copy-and-<code>swap</code> strategy, there are two possible reasons that downgrade the overall exception safety level from strong to basic: <em>side effects</em> and <em>efficiency</em>.</p>
<h4 id="1-side-effects">1. Side effects</h4>
<p>Suppose <code>someFunc</code> uses copy-and-<code>swap</code> and includes calls to two other functions, <code>f1</code> and <code>f2</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#75af00">someFunc</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>    <span style="color:#75715e">// make copy of local state
</span><span style="color:#75715e"></span>    <span style="color:#111">f1</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">f2</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>    <span style="color:#75715e">// swap modified state into place
</span><span style="color:#75715e"></span><span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Apparently, if <code>f1</code> or <code>f2</code> is less than strongly exception-safe, it will be hard for <code>someFunc</code> to be strong exception-safe. For example, suppose <code>f1</code> offers only the basic guarantee, in order to offer the strong guarantee for <code>someFunc</code>, we have to write code to determine the state of the entire program before calling <code>f1</code>, catch all exceptions from <code>f1</code>, and then store the original state. It's complicated, but it's doable. However, even if <code>f1</code> and <code>f2</code> are both strongly exception safe, as long as there are side effects on non-local data, it's much harder to offer the strong guarantee.</p>
<p>For example, if a side effect of calling <code>f1</code> is that a database is modified, and there is, in general, no way to undo a database modification that has already been committed; so after successfully calling <code>f1</code>, if <code>f2</code> then throws an exception, the state of the program is not the same as it was when calling <code>someFunc</code>, even though <code>f2</code> didn't change anything.</p>
<h4 id="2-efficiency">2. Efficiency</h4>
<p>Copy and <code>swap</code> strategy requires making a copy of each object to be modified, which takes time and space we may be unable or unwilling to make available. It's just not practical 100% of the time when we want to offer the strong guarantee.</p>
<p>When it's not, we'll have to offer the basic guarantee. In practice, we can usually offer the strong guarantee for some functions, but the const in efficiency or complexity will make it untenable for many others. For those functions, the basic guarantee is a perfectly resonable choice, as long as we've made a reasonable effort to offer the strong guarantee whenever it's practical.</p>
<h1 id="in-practice">In practice</h1>
<p>A software system is either exception-safe or it's not. There's no such thing as a partially exception-safe system. If a system has even a single function that's not exception-safe, the system as a whole is not exception-safe. Unfortunately, much C++ legacy code was written without exception safety in mind, so many system incorporating legacy code today are not exception-safe.</p>
<p>There's no reason to perpetuate this state of affairs. When writing new code or modifying existing code, think carefully about how to make it exception-safe:</p>
<ol>
<li>begin by using objects to manage resources to prevent resource leaks</li>
<li>follow by determining which of the three exception safety guarantees is the strongest we cound practically offer for each function, settling for no guarantee only if calls to legacy code leave us no choice.</li>
<li>Document our decisions, both for clients of our functions and for future maintainers - a function's exception-safety guaranteee is a visible part of its interface, so we should choose it as deliberately as we choose all other aspects of a function's interface.</li>
</ol></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
