<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>Item-30 Understand ins and outs of inlining - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>Item-30 Understand ins and outs of inlining</h1>
  </div>
<div class="meta">
  <div>2018-02-21 00:00</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>Limit most inlining to small, frequently called functions to facilitate debugging and binary upgradability, minimize potential code bloat, and maximize the chances of greater program speed.</p>
<!-- toc -->
<h1 id="performance-benifits">Performance benifits</h1>
<p>Inline functions have some wonderful advantages:</p>
<ol>
<li>They act like functions.</li>
<li>Yet we call them without having to incur the overhead of a function call.</li>
<li>Compilers might perfom context-specific optimizations (such as stretches of the code) on the body of the inline function thanks to the lack &ldquo;outlined&rdquo; function call</li>
<li>If an inline function body is <em>very</em> short, the code generated for the function body may be smaller than the code generated for a function call, leading to <em>smaller</em> object code and a higher instruction cache hit rate.</li>
</ol>
<p>However, on the other hand, it is also likely to increase the size of our object code. Overzealous inlining can give rise to programs too big for the available space on machines with limited memory. Even with virtual memory, inline-induced code bloat can lead to additional paging, a reduced instruction cache hit rate, and the performance penalties that accompany these things.</p>
<h1 id="details-on-inline-functions">Details on inline functions</h1>
<p>There are two ways to give such a request: implicitly or explicitly:</p>
<ol>
<li>
<p>Implicitly inline request</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Person</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#00a8c8">int</span> <span style="color:#111">age</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#111">theAge</span><span style="color:#111">;</span> <span style="color:#111">}</span> <span style="color:#75715e">// an implicit inline request
</span><span style="color:#75715e"></span>    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">int</span> <span style="color:#111">theAge</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Apart from the member functions, we can also define friend functions inside classes (item 46), resulting to implicitly inline declaration.</p>
</li>
<li>
<p>Explicitly inline request (and its relationship with template)</p>
<p>We can explicitly daclare an inline function with the <code>inline</code> keyword, such as how the standard <code>max</code> template from <code>&lt;algorithm&gt;</code> is implemeted:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>   <span style="color:#75715e">// an explicit inline
</span><span style="color:#75715e"></span><span style="color:#00a8c8">inline</span> <span style="color:#00a8c8">const</span> <span style="color:#111">T</span><span style="color:#f92672">&amp;</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">max</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">T</span><span style="color:#f92672">&amp;</span> <span style="color:#111">a</span><span style="color:#111">,</span> <span style="color:#00a8c8">const</span> <span style="color:#111">T</span><span style="color:#f92672">&amp;</span> <span style="color:#111">b</span><span style="color:#111">)</span> <span style="color:#75715e">// request:: std::max is preceded by &#34;inline&#34;
</span><span style="color:#75715e"></span><span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#111">a</span> <span style="color:#f92672">&lt;</span> <span style="color:#111">b</span> <span style="color:#f92672">?</span> <span style="color:#111">b</span> <span style="color:#111">:</span> <span style="color:#111">a</span><span style="color:#111">;</span><span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>It's true that both template and inline functions are typically defined in header files, but this doesn't mean that function templates must be inline. In fact, template instantiation is independent of inlining:</p>
<ul>
<li>inline functions must typically be in header files, because most build environments do inlining during compilation. In order to replace a function call with the body of the called function, compilers must know waht the function looks like <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>.</li>
<li>templates are typically in header file, because compilers need to know what a template looks like in order to instantiate it when it's used <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>.</li>
</ul>
<p>Thus, when we're writing a template:</p>
<ul>
<li>if we belive that all the functions instantiated from the template should be inlined, declare the template <code>inline</code> just like what's done with the <code>std::max</code> implamentation above;</li>
<li>if we have no reason to want inlined after considering its cost and potential code bloat (which is particularly important for template authors - see item 44), avoid declaring the template inline (either explicitly or implicitly)</li>
</ul>
</li>
</ol>
<h2 id="causes-of-un-inlined-inline-function">Causes of un-inlined inline function</h2>
<p>Bear in mind that <code>inline</code> is a <em>request</em> to compilers, rather than a command, so compilers may ignore it. Whether a given inline function is actually inlined depends on the build environment we're using - primarily on the compiler, and most compilers have a diagnostic level that will result in a warning (item 53) if they fail to inline a function we've asked them to. When they refuse to inline a function, the typical reasons may be:</p>
<ol>
<li>compilers deem the function too complicated (e.g., those containing loogs or are recursive)</li>
<li>the function is virtual (<code>virtual</code> means runtime, while <code>inline</code> usually happens before execution)</li>
<li>when the program will take the address of an inline function:</li>
</ol>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">inline</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">f</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span> <span style="color:#75715e">// assume compilers are willing to inline calls to f
</span><span style="color:#75715e"></span><span style="color:#00a8c8">void</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">pf</span><span style="color:#111">)</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#111">f</span><span style="color:#111">;</span>    <span style="color:#75715e">// pf points to f
</span><span style="color:#75715e"></span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>                 <span style="color:#75715e">// this call will be inlined, for it&#39;s a &#34;normal&#34; call
</span><span style="color:#75715e"></span><span style="color:#111">pf</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>                <span style="color:#75715e">// this call probably won&#39;t be, for it&#39;s through a function pointer
</span></code></pre></td></tr></table>
</div>
</div><h2 id="inline-constructors-and-destructors">Inline constructors and destructors?</h2>
<p>Note that even if we never use function pointers, sometimes compilers will generate those pointers: compilers may generate out-of-line copies of constructors and destructors so that they can get pointers to those functions for use during construction and destruction of objects in arrays. Let alone that constructors and destructors are often worse candidates of inlining than a casual examination would indicate:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Base</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">string</span> <span style="color:#111">bm1</span><span style="color:#111">,</span> <span style="color:#111">bm2</span><span style="color:#111">;</span>  <span style="color:#75715e">// base members 1 and 2
</span><span style="color:#75715e"></span><span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Derived</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">Base</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">Derived</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">{</span><span style="color:#111">}</span>   <span style="color:#75715e">// Derived&#39;s ctor is empty, or is it?
</span><span style="color:#75715e"></span>    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">string</span> <span style="color:#111">dm1</span><span style="color:#111">,</span> <span style="color:#111">dm2</span><span style="color:#111">,</span> <span style="color:#111">dm3</span><span style="color:#111">;</span>  <span style="color:#75715e">// derived members 1,2,3
</span><span style="color:#75715e"></span><span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The constructor of <code>Derived</code> seems empty, so it may seem a good candidate for inlining. But looks can be deceiving:</p>
<blockquote>
<p>C++ makes various guarantees about object construction and corresponding destruction. To name a few: when we create an object, each base class of and each data member in that object is automatically constructed; if an exception is thrown during construction, any parts of the object that have already been fully constructed are automatically destroyed. Similar but reverse process will occur when an object is destroyed.</p>
</blockquote>
<p>Therefore, in the example above, extra code will be generated by compilers and added into the empty <code>Derived</code> constructor in order to offer those guarantees, ending up with some code equivalent to the following conceptual implementation (the real one will certainly be more sophisticated):</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">Derived</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">Derived</span><span style="color:#111">(</span><span style="color:#111">)</span>  <span style="color:#75715e">// conceptual impl. of &#34;empty&#34; Derived ctor
</span><span style="color:#75715e"></span><span style="color:#111">{</span>
    <span style="color:#111">Base</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">Base</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// init. Base part
</span><span style="color:#75715e"></span>
    <span style="color:#00a8c8">try</span> <span style="color:#111">{</span> <span style="color:#111">dm1</span><span style="color:#111">.</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">string</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span> <span style="color:#75715e">// try to construct dm1
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">catch</span> <span style="color:#111">(</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">)</span> <span style="color:#111">{</span>       <span style="color:#75715e">// if it throws
</span><span style="color:#75715e"></span>        <span style="color:#111">Base</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">Base</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// destroy base class part and
</span><span style="color:#75715e"></span>        <span style="color:#00a8c8">throw</span><span style="color:#111">;</span>          <span style="color:#75715e">// propagate the exception
</span><span style="color:#75715e"></span>    <span style="color:#111">}</span>

    <span style="color:#00a8c8">try</span> <span style="color:#111">{</span> <span style="color:#111">dm2</span><span style="color:#111">.</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">string</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span><span style="color:#111">}</span> <span style="color:#75715e">// try to construct dm2
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">catch</span><span style="color:#111">(</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">)</span> <span style="color:#111">{</span>                      <span style="color:#75715e">// if it throws
</span><span style="color:#75715e"></span>        <span style="color:#111">dm1</span><span style="color:#111">.</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">string</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>   <span style="color:#75715e">// destroy dm1,
</span><span style="color:#75715e"></span>        <span style="color:#111">Base</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">Base</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>                <span style="color:#75715e">// destroy base class part
</span><span style="color:#75715e"></span>        <span style="color:#00a8c8">throw</span><span style="color:#111">;</span>                        <span style="color:#75715e">// and propagate the exception
</span><span style="color:#75715e"></span>    <span style="color:#111">}</span>

    <span style="color:#00a8c8">try</span> <span style="color:#111">{</span> <span style="color:#111">dm3</span><span style="color:#111">.</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">string</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span><span style="color:#111">}</span>  <span style="color:#75715e">// try to construct dm3
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">catch</span><span style="color:#111">(</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">)</span> <span style="color:#111">{</span>                       <span style="color:#75715e">// if it throws
</span><span style="color:#75715e"></span>        <span style="color:#111">dm1</span><span style="color:#111">.</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">string</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>    <span style="color:#75715e">// destroy dm1,
</span><span style="color:#75715e"></span>        <span style="color:#111">dm1</span><span style="color:#111">.</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">string</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>    <span style="color:#75715e">// destroy dm2,
</span><span style="color:#75715e"></span>        <span style="color:#111">Base</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">Base</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>                 <span style="color:#75715e">// destroy base class part
</span><span style="color:#75715e"></span>        <span style="color:#00a8c8">throw</span><span style="color:#111">;</span>                         <span style="color:#75715e">// and propagate the exception
</span><span style="color:#75715e"></span>    <span style="color:#111">}</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The same reasoning applies to the <code>Base</code> constructor, so if <code>Base</code>'s constructor is inlined, and <code>string</code> constructor also happens to be inlined, the <code>Derived</code> constructor will gain <em>five</em> copies of <code>string</code>'s constructor, one for each of the five strings in a <code>Derived</code> object - that is a big code bloat. Similar considerations apply to <code>Derived</code>'s destructor.</p>
<h1 id="other-costs-of-inlining">Other costs of inlining</h1>
<p>Apart from the cost of possible code bloat, there are other impact of declaring functions <code>inline</code>:</p>
<ol>
<li><strong>on binary upgradability</strong>: for library designers, it's impossible to provide binary upgrades to the client visible inline functions in a library, after clients of the library compile the body of <code>inline</code> function <code>f</code> into their application. Once the imlementation of <code>f</code> changes, all clients who've used <code>f</code> must recompile.</li>
<li><strong>on debugging</strong>: most debuggers have trouble with inline functions: after all, it is hard to set a breakpoint in a function that isn't there<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>.</li>
</ol>
<h1 id="to-inline-or-not-to-inline">To inline or not to inline?</h1>
<p>In summary, the logical strategy of determining which functions should be declared inline and which should not:</p>
<ul>
<li>initially don't inline anything</li>
<li>detect those functions that must be inline (item 46) or are truly trivial (such as <code>Person::age</code> in this item), inline them cautiously as a hand-applied optimization</li>
<li>as the empirically determined rule of 80-20 suggests: identify the 20% of your code that can increase your program's overall performance, and try to tweak those critical functions with <code>inline</code> or other techniques</li>
</ul>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>There are exceptions: some build environments can inline during linking, and a few can actually inline at runtime (e.g., managed environments based on the .NET Common Language Infrastructure - <code>CLI</code>). Of course, such exceptions are not the rule, and inlining in most C++ programs is a compile-time activity. <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>Again, some build environments perform template instantiation during linking. However, compile-time instantiation is more common. <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p>Some build environments manage to support debugging of inlined functions, but many environments simply disable inlining for debug builds. <a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
