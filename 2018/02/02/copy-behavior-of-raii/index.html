<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>Item-14 Copy behavior in resource-managing classes - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>Item-14 Copy behavior in resource-managing classes</h1>
  </div>
<div class="meta">
  <div>2018-02-02 13:27</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>Copying an RAII object entails copying the resource it manages, so the copying behavior of the resource determines the copying behavior of the RAII object.</p>
<!-- toc -->
<p>We can use <code>auto_ptr</code> and <code>tr1::shared_ptr</code> to manage heap-based resources, as introduced in item 13. However, not all resources are heap-based, and for such resources, we need to create our own resource-managing classes to deal with a general question:</p>
<blockquote>
<p>what should happen when an RAII object is copied?</p>
</blockquote>
<p>Mostly, there are 4 possibal choices:</p>
<h1 id="1-prohibit-copying">1. Prohibit copying</h1>
<p>In some cases, it makes no sense to allow RAII objects to be copied, so we should prohibit it. As explained in item 6, we declare the copying operations <code>private</code> without definition. A good example is class <code>Mutex</code>, which is synchronization primitives and comes with two functions <code>lock</code> and <code>unlock</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#111">Mutex</span> <span style="color:#f92672">*</span><span style="color:#111">pm</span><span style="color:#111">)</span><span style="color:#111">;</span>   <span style="color:#75715e">// lock mutex pointed to by pm
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">void</span> <span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#111">Mutex</span> <span style="color:#f92672">*</span><span style="color:#111">pm</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// unlock the mutex
</span></code></pre></td></tr></table>
</div>
</div><p>We should not forget to unlock a <code>Mutex</code> we've locked, and it rarely makes sense to have &ldquo;copies&rdquo; of synchronization privitives, so we can create an uncopyable class to manage the locks:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Lock</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">private</span> <span style="color:#111">Uncopyable</span> <span style="color:#111">{</span> <span style="color:#75715e">// prohibit copying, see item 6
</span><span style="color:#75715e"></span><span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">explicit</span> <span style="color:#111">Lock</span><span style="color:#111">(</span><span style="color:#111">Mutex</span> <span style="color:#f92672">*</span><span style="color:#111">pm</span><span style="color:#111">)</span>
    <span style="color:#f92672">:</span> <span style="color:#111">mutexPtr</span><span style="color:#111">(</span><span style="color:#111">pm</span><span style="color:#111">)</span>
    <span style="color:#111">{</span> <span style="color:#111">lock</span><span style="color:#111">(</span><span style="color:#111">mutexPtr</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>  <span style="color:#75715e">// acquire resource
</span><span style="color:#75715e"></span>
    <span style="color:#f92672">~</span><span style="color:#111">Lock</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#111">unlock</span><span style="color:#111">(</span><span style="color:#111">mutexPtr</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>  <span style="color:#75715e">// release resource
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">Mutex</span> <span style="color:#f92672">*</span><span style="color:#111">mutexPtr</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>And we can use <code>Lock</code> in the conventional RAII fashion:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">Mutex</span> <span style="color:#111">m</span><span style="color:#111">;</span>  <span style="color:#75715e">// define the mutex
</span><span style="color:#75715e"></span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>



<span style="color:#111">{</span>                  <span style="color:#75715e">// create block to define critical section
</span><span style="color:#75715e"></span>    <span style="color:#111">Lock</span> <span style="color:#75af00">ml</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#111">m</span><span style="color:#111">)</span><span style="color:#111">;</span>   <span style="color:#75715e">// lock the mutex
</span><span style="color:#75715e"></span>    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>            <span style="color:#75715e">// perform critical section operations
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// Lock ml2(ml);  this is prohibited behavior!
</span><span style="color:#75715e"></span><span style="color:#111">}</span>                  <span style="color:#75715e">// automatically unlock mutex at end of block
</span><span style="color:#75715e"></span> 
</code></pre></td></tr></table>
</div>
</div><h1 id="2-reference-count-the-underlying-resource">2. Reference-count the underlying resource</h1>
<p>Sometimes it's desirable to hold on to a resource until the last object using it has been destroyed. We could implement reference-counting copying behavior by containing a <code>tr1::shared_ptr</code> data member, but in some cases we may have to customize the behavior when the reference count goes to zero, for the default behavior is to call <code>delete</code>.</p>
<p>The way we customize <code>tr1::shared_ptr</code> is to specify a &ldquo;deleter&rdquo; - a function or function object to be called when the reference count goes to zero (<code>auto_ptr</code> does not give us this privilege), which is an optional second parameter to the <code>tr1::shared_ptr</code> constructor:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Lock</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">explicit</span> <span style="color:#111">Lock</span><span style="color:#111">(</span><span style="color:#111">Mutex</span> <span style="color:#f92672">*</span><span style="color:#111">pm</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// init shared_ptr with the Mutex
</span><span style="color:#75715e"></span>    <span style="color:#f92672">:</span> <span style="color:#111">mutexPtr</span><span style="color:#111">(</span><span style="color:#111">pm</span><span style="color:#111">,</span> <span style="color:#111">unlock</span><span style="color:#111">)</span>     <span style="color:#75715e">// to point to and the unlock func as the deleter
</span><span style="color:#75715e"></span>    <span style="color:#111">{</span>
        <span style="color:#111">lock</span><span style="color:#111">(</span><span style="color:#111">mutexPtr</span><span style="color:#111">.</span><span style="color:#111">get</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// see item 15 for info on &#34;get&#34;
</span><span style="color:#75715e"></span>    <span style="color:#111">}</span>

<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">tr1</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">shared_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">Mutex</span><span style="color:#f92672">&gt;</span> <span style="color:#111">mutexPtr</span><span style="color:#111">;</span>  <span style="color:#75715e">// use shared_ptr instead of raw pointer
</span><span style="color:#75715e"></span><span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Since a class's destructor (both user-defined ones and compilter-generated ones) automatically invokes the destructors of the class's non-static data members, there's no need to declare a destructor for class <code>Lock</code> explicitly (item 5). We simply rely on the default compilter-generated behavior, and that's enough.</p>
<h1 id="3-copy-the-underlying-resource">3. Copy the underlying resource</h1>
<p>Sometimes we want to copy the resource-managing object as well as the resource it wraps, - that is to say, we want the resourse-managing object to perform a &ldquo;deep copy&rdquo;. A good example is the standard <code>string</code> type: in sompe implementation, a <code>string</code> type object consists of a pointer to heap memory, where the charactors making up the string are stored, and a copy is made of both the pointer and the memory it points to when such an object get copied.</p>
<h1 id="4-transfer-owenership-of-the-underlying-resource">4. Transfer owenership of the underlying resource</h1>
<p>On rere occasions, we wish only one RAII object refers to a raw resource and the ownership of the resource is transfered from the copied object to the copying object, as is the meaning of &ldquo;copy&rdquo; used by <code>auto_ptr</code>.</p>
<p>In this situation, we may have to write our own version of copying functions (copy constructor and copy assignment operator), since the default compiler-generated ones may not do what we want. In some cases, we'll also want to support generalized versions of copying functions, which is discussed in item 45.</p></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
