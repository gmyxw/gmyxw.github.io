<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>Item-25 Consider support for a non-throwing swap - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>Item-25 Consider support for a non-throwing swap</h1>
  </div>
<div class="meta">
  <div>2018-02-13 19:11</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>When <code>std::swap</code> would be inefficient for your type,provide a non-throwing <code>swap</code> member function, a non-member <code>swap</code> calling the member, and possibly a specialized <code>std::swap</code> for the case of classes (not templates).</p>
<!-- toc -->
<p><code>swap</code>, since its introduction into STL, is useful for exception-safe programming (item 29) and a common mechanism for coping with the possibility of assignment to self (item 11). Due to its importance, it should be implemented properly, which is exactly what this item explores about.</p>
<h1 id="customization">Customization</h1>
<p>By default, swapping is accomplished via the standard <code>swap</code> algorithm:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">namesapce</span> <span style="color:#111">std</span> <span style="color:#111">{</span>
    <span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>    <span style="color:#75715e">// typical implementation of std::swap
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">void</span> <span style="color:#111">swap</span><span style="color:#111">(</span><span style="color:#111">T</span><span style="color:#f92672">&amp;</span> <span style="color:#111">a</span><span style="color:#111">,</span> <span style="color:#111">T</span><span style="color:#f92672">&amp;</span> <span style="color:#111">b</span><span style="color:#111">)</span>   <span style="color:#75715e">// swaps a&#39;s and b&#39;s values
</span><span style="color:#75715e"></span>    <span style="color:#111">{</span>
        <span style="color:#111">T</span> <span style="color:#75af00">temp</span><span style="color:#111">(</span><span style="color:#111">a</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#111">a</span> <span style="color:#f92672">=</span> <span style="color:#111">b</span><span style="color:#111">;</span>
        <span style="color:#111">b</span> <span style="color:#f92672">=</span> <span style="color:#111">temp</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>As long as our types support copying (via copy constructor and copy assignment operator), the default <code>swap</code> implementation will work. However, for some types, none of these copies are really necessary. For example: there's a common design manifestation called &ldquo;pimpl idiom&rdquo; (&ldquo;pointer to implementation&rdquo;, item 31) that consisting primarily of a pointer to another type that contains the real data:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">WidgetImpl</span> <span style="color:#111">{</span>            <span style="color:#75715e">// class for Widget data
</span><span style="color:#75715e"></span><span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">int</span> <span style="color:#111">a</span><span style="color:#111">,</span> <span style="color:#111">b</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#111">;</span>
    <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">vector</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">double</span><span style="color:#f92672">&gt;</span> <span style="color:#111">v</span><span style="color:#111">;</span>    <span style="color:#75715e">// possibly lots of data:
</span><span style="color:#75715e"></span>    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>                       <span style="color:#75715e">// expensive to copy
</span><span style="color:#75715e"></span><span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Widget</span> <span style="color:#111">{</span>                    <span style="color:#75715e">// class using the pimpl idiom
</span><span style="color:#75715e"></span><span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">Widget</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Widgtet</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">Widget</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Widget</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span>  <span style="color:#75715e">//to copy a Widget,
</span><span style="color:#75715e"></span>    <span style="color:#111">{</span>                             <span style="color:#75715e">// copy its WidgetImpl object.
</span><span style="color:#75715e"></span>        <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>                       <span style="color:#75715e">// for details on operator=, see item 10, 11, 12
</span><span style="color:#75715e"></span>        <span style="color:#f92672">*</span><span style="color:#111">pImpl</span> <span style="color:#f92672">=</span> <span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">pImpl</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#111">}</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">WidgetImpl</span> <span style="color:#f92672">*</span><span style="color:#111">pImpl</span><span style="color:#111">;</span>             <span style="color:#75715e">// ptr to object with real data
</span><span style="color:#75715e"></span><span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>To swap the value of two <code>Widget</code> objects, all we need to do is swap their <code>pImpl</code> pointers instead of copying three <code>Widget</code>s as well as three underlying <code>WidgetImpl</code> objects. In order to let default <code>swap</code> know this information, we need to specialize <code>std::swap</code> for <code>Widget</code>:</p>
<p>namespace std {
template&lt;&gt;              // a specialized version of std::swap
void swap<Widget>(Widget&amp; a, Widget&amp; b)  // for when T is Widget
{
swap(a.pImpl, b.pImpl);       // won't compile here
}
}</p>
<p>The <code>template&lt;&gt;</code> at the begining says that this is a <em>total template specialization</em> for <code>std::swap</code>, and the <code>&lt;Widget&gt;</code> after the name of the function says that the specialization is for when <code>T</code> is <code>Widget</code>, so compilter knows that when the general <code>swap</code> template is applied to <code>Widget</code>s, this is the implementation to use - although we are not allowed to alter the contents of the <code>std</code> namespace, it is totally fine to specialize standard templates (like <code>swap</code>) for our own types (such as <code>Widget</code>).</p>
<p>However, this implementation won't compile, because we can't access the private <code>pImpl</code> pointers inside <code>a</code> and <code>b</code>. To solve the problem, we declare a public member function called <code>swap</code> that does the actual swapping, then specialize <code>std::swap</code> to call the member function:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Widget</span> <span style="color:#111">{</span> <span style="color:#75715e">// same as above except for the addition of the swap mem func
</span><span style="color:#75715e"></span><span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#00a8c8">void</span> <span style="color:#111">swap</span><span style="color:#111">(</span><span style="color:#111">Widget</span><span style="color:#f92672">&amp;</span> <span style="color:#111">other</span><span style="color:#111">)</span>
    <span style="color:#111">{</span>
        <span style="color:#00a8c8">using</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">swap</span><span style="color:#111">;</span>              <span style="color:#75715e">// use the std::swap
</span><span style="color:#75715e"></span>        <span style="color:#111">swap</span><span style="color:#111">(</span><span style="color:#111">pImple</span><span style="color:#111">,</span> <span style="color:#111">other</span><span style="color:#111">.</span><span style="color:#111">pImpl</span><span style="color:#111">)</span><span style="color:#111">;</span>    <span style="color:#75715e">// to swap Widgets, swap their pImpl pointers
</span><span style="color:#75715e"></span>    <span style="color:#111">}</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#00a8c8">namespace</span> <span style="color:#111">std</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span>      <span style="color:#75715e">// revised version of std::swap
</span><span style="color:#75715e"></span><span style="color:#00a8c8">void</span> <span style="color:#111">swap</span><span style="color:#f92672">&lt;</span><span style="color:#111">Widget</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">Widget</span><span style="color:#f92672">&amp;</span> <span style="color:#111">a</span><span style="color:#111">,</span> <span style="color:#111">Widget</span><span style="color:#f92672">&amp;</span> <span style="color:#111">b</span><span style="color:#111">)</span>  
<span style="color:#111">{</span>
    <span style="color:#111">a</span><span style="color:#111">.</span><span style="color:#111">swap</span><span style="color:#111">(</span><span style="color:#111">b</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// to swap Wiidgets, call their swap mem func
</span><span style="color:#75715e"></span><span style="color:#111">}</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This implementation will compile and be consistent with the STL container. However, if the <code>Widget</code> and <code>WidgetImpl</code> were class <em>template</em> instead of classes (so that we could parameterize the type of the data stored in <code>WidgetImpl</code>), things get more complicated:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">WidgetImpl</span> <span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">Widget</span> <span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>It is still easy to put a <code>swap</code> member function inside <code>Widget</code> the same way as before, but there's a trouble with the specialization for <code>std::swap</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">namespace</span> <span style="color:#111">std</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">swap</span><span style="color:#f92672">&lt;</span><span style="color:#111">Widget</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">Widget</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&amp;</span> <span style="color:#111">a</span><span style="color:#111">,</span> <span style="color:#111">Widget</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&amp;</span> <span style="color:#111">b</span><span style="color:#111">)</span>  <span style="color:#75715e">// illegal code!
</span><span style="color:#75715e"></span><span style="color:#111">{</span>
    <span style="color:#111">a</span><span style="color:#111">.</span><span style="color:#111">swap</span><span style="color:#111">(</span><span style="color:#111">b</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Apparently we're partially specializing a function template <code>std::swap</code> here, and the problem is that, although C++ allows partial specialization of class templates, it doesn't allow it for function templates (though some compilers may erroneously accept it).</p>
<p>The usual approach to &ldquo;partially specialize&rdquo; a function template is to add an overload like this:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">namespace</span> <span style="color:#111">std</span> <span style="color:#111">{</span>
    <span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>   <span style="color:#75715e">// an overloading of std::swap
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">void</span> <span style="color:#111">swap</span><span style="color:#111">(</span><span style="color:#111">Widget</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&amp;</span> <span style="color:#111">a</span><span style="color:#111">,</span> <span style="color:#111">Widget</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&amp;</span> <span style="color:#111">b</span><span style="color:#111">)</span>  <span style="color:#75715e">// note the lack of &#34;&lt;...&gt;&#34;
</span><span style="color:#75715e"></span>    <span style="color:#111">{</span>                                      <span style="color:#75715e">// after &#34;swap&#34;
</span><span style="color:#75715e"></span>        <span style="color:#111">a</span><span style="color:#111">.</span><span style="color:#111">swap</span><span style="color:#111">(</span><span style="color:#111">b</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>However, rather than overloading a common function template, what we do here is overloading a function template <code>std::swap</code> in the special <code>std</code> namesapce, where it's not allowed to add <em>new</em> templates or classes or functions or anything else into it (the contens of <code>std</code> are determined solely by the C++ standardization committee). Even though programs that cross the line will almost certainly compile and run, their behavior is undefined.</p>
<p>Thus in this case, not to declare the non-member function to be a specialization or overloading of <code>std::swap</code>, we just make a normal non-member <code>swap</code> function in <code>Widget</code>-related namespace:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">namespace</span> <span style="color:#111">WidgetStuff</span> <span style="color:#111">{</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>  <span style="color:#75715e">// templatized WidgetImpl, etc.
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span> 
    <span style="color:#00a8c8">class</span> <span style="color:#75af00">Widget</span> <span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span><span style="color:#111">;</span> <span style="color:#75715e">// including the swap member function
</span><span style="color:#75715e"></span>    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>   <span style="color:#75715e">// non-member swap function
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">void</span> <span style="color:#111">swap</span><span style="color:#111">(</span><span style="color:#111">Widget</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&amp;</span> <span style="color:#111">a</span><span style="color:#111">,</span> <span style="color:#111">Widget</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&amp;</span> <span style="color:#111">b</span><span style="color:#111">)</span>  <span style="color:#75715e">// not part of the std namespace
</span><span style="color:#75715e"></span>    <span style="color:#111">{</span>
        <span style="color:#111">a</span><span style="color:#111">.</span><span style="color:#111">swap</span><span style="color:#111">(</span><span style="color:#111">b</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
<span style="color:#111">}</span>

</code></pre></td></tr></table>
</div>
</div><p>The name lookup rules in C++ (specifically the rules known as <em>argument-dependent lookup</em> or <em>Koenig lookup</em>) will guarantee the Widget-specific version of <code>swap</code> in <code>WidgetStuff</code> will be invoked if any code calls <code>swap</code> on two <code>Widget</code> objects.</p>
<h1 id="usage">Usage</h1>
<p>Let's look from a client's point of view and see how to use the <code>swap</code>. Ideally, we want to call a T-specific version of <code>swap</code> if there is one, but to fall back on the general version in <code>std</code> if there's not. To fulfill this idea:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">doSomething</span><span style="color:#111">(</span><span style="color:#111">T</span><span style="color:#f92672">&amp;</span> <span style="color:#111">obj1</span><span style="color:#111">,</span> <span style="color:#111">T</span><span style="color:#f92672">&amp;</span> <span style="color:#111">obj2</span><span style="color:#111">)</span> 
<span style="color:#111">{</span>
    <span style="color:#00a8c8">using</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">swap</span><span style="color:#111">;</span>  <span style="color:#75715e">// make std::swap available in this function
</span><span style="color:#75715e"></span>    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#111">swap</span><span style="color:#111">(</span><span style="color:#111">obj1</span><span style="color:#111">,</span> <span style="color:#111">obj2</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// call the best swap for obejcts of type T
</span><span style="color:#75715e"></span>    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>When compilers see the call to <code>swap</code>, they search for the best <code>swap</code> to invoke - according to C++'s name lookup rules, it follows the order below:</p>
<ol>
<li>Find any T-specific <code>swap</code> at global scope or in the same namespace as the type T (if T is <code>Widget</code> in the namespace <code>WidgetStuff</code>, compilers will find <code>swap</code> in <code>WidgetStuff</code> defined above)</li>
<li>If no T-specific <code>swap</code> exists, compilers will use <code>swap</code> in <code>std</code>, thanks to the <code>using</code> declaration that makes <code>std::swap</code> visible in this function.
<ol>
<li>If there's a T-specific specialization of <code>std::swap</code>, use the specialized version</li>
<li>If not, use the general <code>swap</code> template function.</li>
</ol>
</li>
</ol>
<p>One thing worth noting is to not qualify the call like this:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">swap</span><span style="color:#111">(</span><span style="color:#111">obj1</span><span style="color:#111">,</span> <span style="color:#111">obj2</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// the wrong way to call swap
</span></code></pre></td></tr></table>
</div>
</div><p>here we force compilers to consider only the <code>swap</code> in <code>std</code> (including any template specializations), thus eliminating the possibility of getting a more appropriate T-specific version defined elsewhere. Alas, some misguided programmers (or even some standard library) <em>do</em> qualify calls to <code>swap</code> in this way. To make code work as efficiently as possible, we'd better totally specialize <code>std::swap</code> for our classes.</p>
<h1 id="summary">Summary</h1>
<p>We've discussed the default <code>swap</code>, member <code>swap</code>s, non-member <code>swap</code>s, specializations of <code>std::swap</code>, and calls to <code>swap</code>. Below is a good practice on implementing and using customized <code>swap</code>:</p>
<ol>
<li>If the default implementation of <code>swap</code> offers acceptable efficiency for our class or class template, nothing needs to be done to specialize the default <code>std::swap</code>.</li>
<li>If not (for class or template using some variation of the pimpl idiom):
<ol>
<li>offer a public <code>swap</code> member function that efficiently swaps the value of two objects of our type. This function should never throw an exception<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></li>
<li>offer a non-member <code>swap</code> in the same namespace as the class or template<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>. Have it call the <code>swap</code> member function</li>
<li>if it's a class (not a class template), specialize <code>std::swap</code> for the class. Have it also call the <code>swap</code> member function</li>
</ol>
</li>
</ol>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>One of most useful applications of <code>swap</code> is to help classes and class templates offer the strong exception-safety guarantee (See 29 for details). Generally speaking, efficiency and non-exception are two <code>swap</code> characteristics that always go hand in hand, because highly efficient <code>swap</code>s are almost always based on operations on built-in types (such as the pointers underlying the pimpl idiom), and operations on built-in types never throw exceptions. <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>The non-exception constraint can't apply to the non-member version, because the default version of <code>swap</code> is based on copy construction and copy assignment, and generally both copy functions are allowed to throw exceptions. <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
