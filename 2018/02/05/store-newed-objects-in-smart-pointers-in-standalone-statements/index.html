<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>Item-17 Store newed objects in smart pointers in standalone statements - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>Item-17 Store newed objects in smart pointers in standalone statements</h1>
  </div>
<div class="meta">
  <div>2018-02-05 18:04</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>Failure to do this can lead to subtle resource leaks when exceptions are thrown.</p>
<p>Suppose there're two functions:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">int</span> <span style="color:#75af00">priority</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// reveal processing priority
</span><span style="color:#75715e"></span><span style="color:#00a8c8">void</span> <span style="color:#75af00">processWidget</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">tr1</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">shared</span><span style="color:#f92672">&lt;</span><span style="color:#111">Widget</span><span style="color:#f92672">&gt;</span> <span style="color:#111">pw</span><span style="color:#111">,</span> <span style="color:#00a8c8">int</span> <span style="color:#111">priority</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// do some processing on a dynamically allocated `Widget` in accord with the priority above
</span></code></pre></td></tr></table>
</div>
</div><p>Apparently, following code won't compile:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">processWidget</span><span style="color:#111">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">Widget</span><span style="color:#111">,</span> <span style="color:#111">priority</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>This is because <code>tr1::shared_ptr</code>'s constructor taking a raw is <code>explicit</code>, there's no implicit conversion from the raw pointer (returned by <code>new Widget</code>) to the <code>tr1::shared_ptr</code> (required by <code>processWidget</code>).</p>
<p>However, even though the code below does compile, seems correct, and carefully uses <code>shared_ptr</code> to manage resource, it may still leak resources:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">processWidget</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">tr1</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">shared_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">Widget</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">Widget</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">priority</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>The two arguments as function parameters must be evaluated before a call to <code>processWidget</code> is generated, and the first argument actually consists of two parts:</p>
<ul>
<li>execution of the expression <code>new Widget</code></li>
<li>call to the <code>tr1::shared_ptr</code> constructor</li>
</ul>
<p>Thus, before <code>processWidget</code> can be called, following three steps must take place:</p>
<ul>
<li>Call <code>priority</code></li>
<li>Execute <code>new Widget</code></li>
<li>Call the <code>tr1::shared_ptr</code> constructor</li>
</ul>
<p>Unlike Java and C#, where function parameters are always evaluated in a particular order, C++ compilers are free to decide the order of steps above. Although <code>new Widget</code> must take place before <code>tr1::shared_ptr</code> constructor can be call (for the result of <code>new</code> operation is the argument of the smart pointer's constructor), the call to <code>priority()</code> can be performed first, second, or third. If compilers choose to perform it second (maybe for efficiency consideration):</p>
<ol>
<li>Execute <code>new Widget</code></li>
<li>Call <code>priority</code></li>
<li>Call <code>tr1::shared_ptr</code> constructor</li>
</ol>
<p>The problem here is that, once the call to <code>priority</code> yields an exception, the pointer returned from <code>new Widget</code> has not turned over to the resource-managing object, and resource leaks.</p>
<p>Luckily, it is very simple to avoid this problem: use a separate statement to create <code>Widget</code> and store it in a smart pointer, then pass the smart pointer to <code>processWidget</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">tr1</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">shared_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">Widget</span><span style="color:#f92672">&gt;</span> <span style="color:#111">pw</span><span style="color:#111">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">Widget</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// standalone statement
</span><span style="color:#75715e"></span><span style="color:#111">processWidget</span><span style="color:#111">(</span><span style="color:#111">pw</span><span style="color:#111">,</span> <span style="color:#111">priority</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// won&#39;t leak
</span></code></pre></td></tr></table>
</div>
</div><p>Now the <code>new Widget</code> expression and the call to <code>tr1::shared_ptr</code> constructor are in a different statement from the call to <code>priority</code>, compilers are not allowed to move the call to <code>priority</code> between them.</p></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
