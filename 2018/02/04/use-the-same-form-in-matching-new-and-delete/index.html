<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>Item-16 Use the same form in corresponding uses of new and delete - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>Item-16 Use the same form in corresponding uses of new and delete</h1>
  </div>
<div class="meta">
  <div>2018-02-04 00:00</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>If you use [] in a <code>new</code> expression, use [] in the corresponding <code>delete</code> expression; If not, no [] in the matching <code>delete</code> expression.</p>
<p>When employing a <code>new</code> expression, two things happen:</p>
<ol>
<li>membory is allocated (via the function <code>operator new</code>, item 49, 51)</li>
<li>one or more constructors are called for that memory</li>
</ol>
<p>When a <code>delete</code> is used, two other things happen:</p>
<ol>
<li>one or more destructors are called for the memory</li>
<li>The memory is deallocated (via the function <code>operator delete</code>, item 51)</li>
</ol>
<p>The fact is that the memory layout for single objects is generally different from the memory layout for arrays, and the memory for an array usually includes extra area for the size of the array (making it easier for <code>delete</code> to know how many destructor to call) while memory for a single object lacks this information:</p>
<table>
<thead>
<tr>
<th>Memory type</th>
<th>Memory layout</th>
</tr>
</thead>
<tbody>
<tr>
<td>Array</td>
<td>|n|Object|Object|Object|&hellip;|</td>
</tr>
<tr>
<td>Single object</td>
<td>|Object|</td>
</tr>
</tbody>
</table>
<p>When we use <code>delete</code> on a pointer, <code>delete []</code> will assumes an array is pointed to, otherwise it assumes a single object. Let's see what will happen if the uses of <code>new</code> and <code>delete</code> is not matching:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">string</span> <span style="color:#f92672">*</span><span style="color:#111">stringPtr1</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">string</span><span style="color:#111">;</span>
<span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">string</span> <span style="color:#f92672">*</span><span style="color:#111">stringPtr2</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">string</span><span style="color:#111">[</span><span style="color:#ae81ff">100</span><span style="color:#111">]</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><code>delete [] stringPtr1;</code></p>
<p>The result is undefined. <code>delete</code> will read some memory and interpret what it read as an array size, then start invoking the destructors, and it's probably not holding the objects of the type it's busy destructing at this point.</p>
</li>
<li>
<p><code>delete stringPtr2;</code></p>
<p>It's undefined behavior too. It's easy to see the expression would lead to too few destructors being called. Furthermore, it's also undefined for built-in types (which lack destructors), too.</p>
</li>
</ul>
<p>The rule is particularly important to bear in mind when writing a class containing a pointer to dynamically allocated memory and also offering multiple constructors, for we must be careful to use the same form of <code>new</code> in all the constructors to initialize the pointer member. After all, there's only one form of <code>delete</code> in the destructor.</p>
<p>The rule is also noteworthy for <code>typedef</code>-inclined:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">typedef</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">string</span> <span style="color:#111">AddressLines</span><span style="color:#111">[</span><span style="color:#ae81ff">4</span><span style="color:#111">]</span><span style="color:#111">;</span>  <span style="color:#75715e">// a person&#39;s address has 4 lines
</span><span style="color:#75715e"></span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">string</span> <span style="color:#f92672">*</span><span style="color:#111">pal</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">AddressLines</span><span style="color:#111">;</span>  <span style="color:#75715e">// return type is string*, just like &#34;new string[4]&#34; would
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">delete</span> <span style="color:#111">pal</span><span style="color:#111">;</span>     <span style="color:#75715e">// undefined!
</span><span style="color:#75715e"></span><span style="color:#00a8c8">delete</span> <span style="color:#111">[</span><span style="color:#111">]</span> <span style="color:#111">pal</span><span style="color:#111">;</span>  <span style="color:#75715e">// fine, array form of delete is the matched version
</span></code></pre></td></tr></table>
</div>
</div><p>To avoid such confusion, abstain from <code>typedef</code>s for array types. Try using <code>string</code> and <code>vector</code> from the standard C++ library (item 54) - those templates reduce the need for dynamically allocated arrays to nearly zero: for example, we may define <code>AddressLines</code> as type <code>vector&lt;string&gt;</code>.</p></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
