<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>[EMCpp]Item-16 Make Const Member Functions Thread Safe - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>[EMCpp]Item-16 Make Const Member Functions Thread Safe</h1>
  </div>
<div class="meta">
  <div>2018-07-24 10:26</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>Make <code>const</code> member functions thread safe unless we're <em>certain</em> they'll never be used in a concurrent context.</p>
<!-- toc -->
<p>Due to <code>mutable</code> member datas, <code>const</code> member functions may not be thread safe. For a classic use case for <code>mutable</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Polynomial</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">using</span> <span style="color:#111">RootsType</span> <span style="color:#f92672">=</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">vector</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">double</span><span style="color:#f92672">&gt;</span><span style="color:#111">;</span>  <span style="color:#75715e">// holding val. where poly. evals to zero
</span><span style="color:#75715e"></span>    <span style="color:#111">RootsType</span> <span style="color:#75af00">roots</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span>
    <span style="color:#111">{</span>
        <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#f92672">!</span><span style="color:#111">rootsAreValie</span><span style="color:#111">)</span> <span style="color:#111">{</span>       <span style="color:#75715e">// if cache not valid
</span><span style="color:#75715e"></span>            <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>                     <span style="color:#75715e">// compute roots, store them in rootVals
</span><span style="color:#75715e"></span>            <span style="color:#111">rootsAreValid</span> <span style="color:#f92672">=</span> <span style="color:#111">true</span><span style="color:#111">;</span> 
        <span style="color:#111">}</span>
        <span style="color:#00a8c8">return</span> <span style="color:#111">rootVals</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">mutable</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">rootsAreValid</span><span style="color:#111">{</span> <span style="color:#111">false</span> <span style="color:#111">}</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">mutable</span> <span style="color:#111">RootsType</span> <span style="color:#111">rootVals</span><span style="color:#111">{</span><span style="color:#111">}</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Here <code>roots()</code> retrieves the roots of a polynomial without changing the value of the <code>Polynomial</code> object on which it operates, so <code>const</code> declaratoin is correct. However, <code>rootVals</code> and <code>rootsAreValid</code> might be modified for the purpose of caching. Seeing the <code>const</code> interface for <code>roots()</code>, clients are perfectly reasonable to do something like this:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">Polynomial</span> <span style="color:#111">p</span><span style="color:#111">;</span>
<span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#75715e">// thread 1                   // thread 2
</span><span style="color:#75715e"></span><span style="color:#00a8c8">auto</span> <span style="color:#111">rootsOfP</span> <span style="color:#f92672">=</span> <span style="color:#111">p</span><span style="color:#111">.</span><span style="color:#111">roots</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>    <span style="color:#00a8c8">auto</span> <span style="color:#111">valsGivingZero</span> <span style="color:#f92672">=</span> <span style="color:#111">p</span><span style="color:#111">.</span><span style="color:#111">roots</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Having multiple threads perform a read operation without synchronization is safe. However, although <code>roots</code> is declared <code>const</code>, it's not thread safe: more than one threads might try to modify the data members <code>rootsAreValid</code> and <code>rootVals</code> inside <code>roots</code>, reading and writing the same memory without synchronization - which is data racing, leading to undefined behavior.</p>
<h1 id="solution-mutex">Solution: mutex</h1>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Polynomial</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">using</span> <span style="color:#111">RootsType</span> <span style="color:#f92672">=</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">vector</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">double</span><span style="color:#f92672">&gt;</span><span style="color:#111">;</span>  <span style="color:#75715e">// holding val. where poly. evals to zero
</span><span style="color:#75715e"></span>    <span style="color:#111">RootsType</span> <span style="color:#75af00">roots</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span>
    <span style="color:#111">{</span>
        <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">lock_guard</span><span style="color:#f92672">&lt;</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">mutex</span><span style="color:#f92672">&gt;</span> <span style="color:#111">g</span><span style="color:#111">(</span><span style="color:#111">m</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// lock mutex
</span><span style="color:#75715e"></span>        <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#f92672">!</span><span style="color:#111">rootsAreValie</span><span style="color:#111">)</span> <span style="color:#111">{</span>       <span style="color:#75715e">// if cache not valid
</span><span style="color:#75715e"></span>            <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>                     <span style="color:#75715e">// compute roots, store them in rootVals
</span><span style="color:#75715e"></span>            <span style="color:#111">rootsAreValid</span> <span style="color:#f92672">=</span> <span style="color:#111">true</span><span style="color:#111">;</span> 
        <span style="color:#111">}</span>
        <span style="color:#00a8c8">return</span> <span style="color:#111">rootVals</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>                                      <span style="color:#75715e">// unlock mutex
</span><span style="color:#75715e"></span>    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">mutable</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">mutex</span> <span style="color:#111">m</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">mutable</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">rootsAreValid</span><span style="color:#111">{</span> <span style="color:#111">false</span> <span style="color:#111">}</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">mutable</span> <span style="color:#111">RootsType</span> <span style="color:#111">rootVals</span><span style="color:#111">{</span><span style="color:#111">}</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>roots</code> is a <code>const</code> member function, inside which <code>std::mutex m</code> would be considered a <code>const</code> object, while <code>locking</code> and <code>unlocking</code> are non-<code>const</code> member functions, so we need to declared <code>m</code> as <code>mutable</code>.</p>
<p>Another point worth noting is that <code>std::mutex</code> can be neither copied nor moved, so a side effect of adding <code>m</code> to <code>Polynomial</code> is that <code>Polynomial</code> loses the ability to be copied and moved.</p>
<h1 id="for-a-single-variable-requiring-synchronization">For a single variable requiring synchronization</h1>
<p>Sometimes when there's only one variable or memory location requiring synchronization, <code>mutex</code> might be overkill, and we might consider <code>std::atomic</code> counter (EMCpp item 40), which is often a less expensive way to go<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Point</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#00a8c8">double</span> <span style="color:#111">distanceFromOrigin</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span> <span style="color:#00a8c8">noexcept</span>
    <span style="color:#111">{</span>
        <span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">callCount</span><span style="color:#111">;</span>   <span style="color:#75715e">// atomic increment
</span><span style="color:#75715e"></span>        <span style="color:#00a8c8">return</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">hypot</span><span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#111">,</span> <span style="color:#111">y</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">mutable</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">atomic</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">unsigned</span><span style="color:#f92672">&gt;</span> <span style="color:#111">callCount</span><span style="color:#111">{</span> <span style="color:#ae81ff">0</span> <span style="color:#111">}</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">double</span> <span style="color:#111">x</span><span style="color:#111">,</span> <span style="color:#111">y</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>The same side effect goes here: the existance of <code>callCount</code> in <code>Point</code> makes <code>Point</code> neither copyable nor movable.</p>
<h1 id="summary">Summary</h1>
<p>The point in this item: when we write a <code>const</code> member function, we might avoid the costs associated with mutexes and <code>std::stomic</code>s as well as the side effect of uncopyability as well as unmovability, if we can guarantee that there will never be more than one thread executing that member function on an object.</p>
<p>However, such threading-free scenarios are increasingly uncommon. In order to support concurrent execution, we should unsure that <code>const</code> member functions are thread safe.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>Whether it actually is less expensive depends on the hardware we're runnig on and the implementation of mutexes in our Standard Library. <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
