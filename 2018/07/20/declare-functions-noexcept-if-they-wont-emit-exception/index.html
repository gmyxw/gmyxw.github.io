<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>[EMCpp]Item-14 Declare Functions Noexcept if They Won&#39;t Emit Exception - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>[EMCpp]Item-14 Declare Functions Noexcept if They Won&#39;t Emit Exception</h1>
  </div>
<div class="meta">
  <div>2018-07-20 19:50</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>Most functions are exception-neutral, but for some, such as move operations, swap, memory deallocation functions, and destructors, <code>noexcept</code> is particularly valuable.</p>
<!-- toc -->
<h1 id="more-optimizable">More optimizable</h1>
<p>For functions that won't produce exceptions, we have C++98 style as well as C++11 style:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">int</span> <span style="color:#75af00">f</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">x</span><span style="color:#111">)</span> <span style="color:#00a8c8">throw</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>   <span style="color:#75715e">// C++98 style
</span><span style="color:#75715e"></span><span style="color:#00a8c8">int</span> <span style="color:#75af00">f</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">x</span><span style="color:#111">)</span> <span style="color:#00a8c8">noexcept</span><span style="color:#111">;</span>  <span style="color:#75715e">// C++11 style
</span></code></pre></td></tr></table>
</div>
</div><p>The difference:</p>
<ol>
<li>C++98: the call stack is unwound to <code>f</code>'s caller before program execution is terminated</li>
<li>C++11: the call stack is <em>possibly</em> unwound before program execution is terminated</li>
</ol>
<p>The difference in <em>possibly</em> unwinding leads to large impact on code generation: optimizers need not keep the runtime stack in an unwindable state, and need not ensure that objects in a <code>noexcept</code> function are destroyed in the inverse order of construction, both of which optimization flexibility is lacked for <code>throw()</code>. In fact, <code>throw</code> has the same level of optimizability as functions with no exception specification.</p>
<p>For some functions, <code>noexcept</code> is even more desired. For example, calls to copy operations in C++98 will be replaced with calls to move operations in C++11, only if the move operation is declared <code>noexcept</code>. Similarly, <code>swap</code>s in the Standard Library are <code>noexcpet</code> sometimes dependends on whether uesr-defined swaps are <code>noexcept</code>. Following is the declarations for the Standard Library's <code>swap</code>s for arrays and <code>std::pair</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#111">,</span> <span style="color:#111">size_t</span> <span style="color:#111">N</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">swap</span><span style="color:#111">(</span><span style="color:#111">T</span> <span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#111">a</span><span style="color:#111">)</span><span style="color:#111">[</span><span style="color:#111">N</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">T</span> <span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#111">b</span><span style="color:#111">)</span><span style="color:#111">[</span><span style="color:#111">N</span><span style="color:#111">]</span><span style="color:#111">)</span> <span style="color:#00a8c8">noexcept</span><span style="color:#111">(</span><span style="color:#00a8c8">noexcept</span><span style="color:#111">(</span><span style="color:#111">swap</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">a</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#111">b</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T1</span><span style="color:#111">,</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">T2</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">struct</span> <span style="color:#75af00">pair</span> <span style="color:#111">{</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#00a8c8">void</span> <span style="color:#111">swap</span><span style="color:#111">(</span><span style="color:#111">pair</span><span style="color:#f92672">&amp;</span> <span style="color:#111">p</span><span style="color:#111">)</span> <span style="color:#00a8c8">noexcept</span><span style="color:#111">(</span><span style="color:#00a8c8">noexcept</span><span style="color:#111">(</span><span style="color:#111">swap</span><span style="color:#111">(</span><span style="color:#111">first</span><span style="color:#111">,</span> <span style="color:#111">p</span><span style="color:#111">.</span><span style="color:#111">first</span><span style="color:#111">)</span><span style="color:#111">)</span> <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span>
                                <span style="color:#00a8c8">noexcept</span><span style="color:#111">(</span><span style="color:#111">swap</span><span style="color:#111">(</span><span style="color:#111">second</span><span style="color:#111">,</span> <span style="color:#111">p</span><span style="color:#111">.</span><span style="color:#111">second</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>These functions are <em>conditionally</em> <code>noexcept</code>: whether they are <code>noexcept</code> depends on whether the expression inside the <code>noexcept</code> clauses are <code>noexcept</code>. The fact that swapping higher-level data structures can generally be <code>noexcept</code> only if swapping their lower-level constituents is <code>noexcept</code> should be reasonable enough to offer <code>noexcept</code> <code>swap</code> functions whenever we can.</p>
<h1 id="exception-neutral-functions">Exception Neutral Functions</h1>
<p><code>noexcept</code> is part of a function's interface, so we should declare a function <code>noexcept</code> only if we are willing to commit to a <code>noexcept</code> implementation over the long term.</p>
<p>However, most functions are <em>exception-newtral</em>: they throw no exceptions themselves, but functions they call might emit one. Such functions are never <code>noexcept</code>, because they may emit such &ldquo;just passing through&rdquo; exceptions, and thus they lack the <code>noexcept</code> designation on purpose.</p>
<p>For some other few functions, on the other hand, being <code>noexcept</code> is so important that, in C++11, they are implicitly <code>noexcept</code>: by default, all memory deallocation functions and destructors (both user-defined and compiler-generated) are <code>noexcept</code>.</p>
<h1 id="wide-contracts-vs-narrow-contracts">Wide Contracts vs Narrow Contracts</h1>
<p>A function with a wide contract has no preconditions: they can be called regardless of the state of the program, with no constraints on the arguments that callers pass it, and never exhibit undefined behavior.</p>
<p>Functions withou wide contracts have narrow contract: if a precondition is violated, results are undefined.</p>
<p>Generally, library desingers reserve <code>noexcept</code> for functions with wide contracts, so that if a precondition in a narrow contract is violated, the program may throw a  &ldquo;precondition was violated&rdquo; exception, instead of letting the program to terminate.</p>
<p>If we're writing a function with a wide contract and we know it won't emit exceptions, just declare it <code>noexcept</code>.</p>
<h1 id="backward-compatibility">Backward compatibility</h1>
<p>So much legacy code is not decalred with <code>noexcpet</code> even though they actually never emit exceptions. For the reason of backward compatibility, <code>noexcept</code> functions calling non-<code>noexcept</code> functions are permitted in C++, and compilers generally don't issue warnings about it:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#75af00">setup</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>    <span style="color:#75715e">// legacy code defined elsewhere
</span><span style="color:#75715e"></span><span style="color:#00a8c8">void</span> <span style="color:#75af00">cleanup</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// without declaring noexcept
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">void</span> <span style="color:#75af00">doWork</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">noexcept</span>
<span style="color:#111">{</span>
    <span style="color:#111">setup</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#111">clean</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
