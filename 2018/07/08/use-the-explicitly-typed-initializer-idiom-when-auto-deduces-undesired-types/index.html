<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>[EMCpp]Item-6 Use the Explicitly Typed Initializer Idiom when auto deduces undesired types - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>[EMCpp]Item-6 Use the Explicitly Typed Initializer Idiom when auto deduces undesired types</h1>
  </div>
<div class="meta">
  <div>2018-07-08 13:32</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>“Invisible” proxy types can cause <code>auto</code> to deduce the undesired type for an initializing expression, so we can adopt explicitly typed initializer idiom to force <code>auto</code> to deduce what we want.</p>
<p>Some proxy classe are designed to be apparent to clients, such as <code>std::shared_ptr</code>, and <code>std::unique_ptr</code>. Other proxy classes are designed to at more or less invisibly, such as <code>std::vector&lt;bool&gt;::reference</code>, and <code>std::bitset::reference</code>.</p>
<p>For example, suppose we have a function that takes a <code>Widget</code> and returns a <code>std::vector&lt;bool&gt;</code>, where each bool indicates whether the <code>Widget</code> offers a particular feature:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">vector</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">bool</span><span style="color:#f92672">&gt;</span> <span style="color:#111">features</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Widget</span><span style="color:#f92672">&amp;</span> <span style="color:#111">w</span><span style="color:#111">)</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Now we want to check the value of bit 5, which indicates whether the <code>Widget</code> has high priority:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">Widget</span> <span style="color:#111">w</span><span style="color:#111">;</span>
<span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">bool</span> <span style="color:#111">highPriority</span> <span style="color:#f92672">=</span> <span style="color:#111">features</span><span style="color:#111">(</span><span style="color:#111">w</span><span style="color:#111">)</span><span style="color:#111">[</span><span style="color:#ae81ff">5</span><span style="color:#111">]</span><span style="color:#111">;</span>  <span style="color:#75715e">// is w high priority ?
</span><span style="color:#75715e"></span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">processWidget</span><span style="color:#111">(</span><span style="color:#111">w</span><span style="color:#111">,</span> <span style="color:#111">highPriority</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// process w in accord with its priority
</span></code></pre></td></tr></table>
</div>
</div><p>However, if we change the explicit type for <code>highPriority</code> with <code>auto</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">auto</span> <span style="color:#111">highPriority</span> <span style="color:#f92672">=</span> <span style="color:#111">features</span><span style="color:#111">(</span><span style="color:#111">w</span><span style="color:#111">)</span><span style="color:#111">[</span><span style="color:#ae81ff">5</span><span style="color:#111">]</span><span style="color:#111">;</span>
<span style="color:#111">processWidget</span><span style="color:#111">(</span><span style="color:#111">w</span><span style="color:#111">,</span> <span style="color:#111">highPriority</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// undefined behavior! 
</span></code></pre></td></tr></table>
</div>
</div><p>The undefined behavior is caused by the fact that <code>highPriority</code> contains dangling pointer. And here is what happened:</p>
<ul>
<li><code>features</code> returns a temporary <code>std::vector&lt;bool&gt;</code> object (let's call it <em>temp</em>), which is specified to represent its <code>bool</code>s in packed form, one bit per <code>bool</code>.</li>
<li><code>operator[]</code> is invokes on <em>temp</em>, and returns a <code>std::vector&lt;bool&gt;::reference</code> object (an invisible proxy), which contains a pointer to a word in the data structure holding the bits that are managed by <code>temp</code>, plus the offset into that word corresponding to bit 5<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></li>
<li><code>auto</code> deduces <code>std::vector&lt;bool&gt;::reference</code> as the tpe of <code>highPriority</code>, and bind <code>highPriority</code> to a copy of this <code>std::vector&lt;bool&gt;::reference</code> object</li>
<li>at the end of the statement, <code>temp</code> is destroyed. Therefore, as a copy, <code>highPriority</code> contains a dangling pointer, leading to undefined behavior in the call to <code>processWidget</code>.</li>
</ul>
<p>Now is the time we adopt the explicitly typed initializer idiom: we declare a variable with <code>auto</code>, but casting the initialization expression to the type we want <code>auto</code> to deduce:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">auto</span> <span style="color:#111">highPriority</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">bool</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">features</span><span style="color:#111">(</span><span style="color:#111">w</span><span style="color:#111">)</span><span style="color:#111">[</span><span style="color:#ae81ff">5</span><span style="color:#111">]</span><span style="color:#111">)</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>At this time, the <code>std::vector&lt;bool&gt;::reference</code> object returned from <code>std::vector&lt;bool&gt;::operator[]</code> executes the conversion to <code>bool</code> it supports, and as part of that conversion, the still-valid pointer to <em>temp</em> (the <code>std::vector&lt;bool&gt;</code> object returned from <code>features</code>) is dereferenced, and the index 5 is then applied to the bits pointed to by the ponter, and the <code>bool</code> value that emerges is used to initialize <code>highPriority</code> - therefore, undefined behavior is avoided.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>C++ forbids references to bits, so in the case where <code>T</code> is <code>bool</code>, <code>operator[]</code> for <code>std::vector&lt;T&gt;</code> cannot return <code>bool&amp;</code> in packed form. That's why the proxy is introduced here to make the return value act like a <code>bool&amp;</code>. <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
