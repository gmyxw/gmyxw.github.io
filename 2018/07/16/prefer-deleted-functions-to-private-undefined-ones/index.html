<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>[EMCpp]Item-11 Prefer Deleted Functions to Private Undefined Ones - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>[EMCpp]Item-11 Prefer Deleted Functions to Private Undefined Ones</h1>
  </div>
<div class="meta">
  <div>2018-07-16 21:22</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>Any function may be deleted, including non-member functions and template instantiations.</p>
<!-- toc -->
<p>To prevent use of certain function from being called, there is a classic approach in C++98: declare that function <code>private</code> and not define them.</p>
<p>However, the fact is that this C++98 practice is really an attempt to achieve what C++11's deleted functions actually accomplish. As an emulation, it is not as good as the real thing: it doesn't work outside classes, it doesn't always work inside classes, and when it does work, it may not work until link-time.</p>
<h1 id="link-time-vs-compile-time-failure-diagnostic">Link-time vs compile-time failure diagnostic</h1>
<p>In C++98 practice, declaring functions <code>private</code> prevents clients from calling them. Due absence of function definitions, linking will fail if member functions or <code>friend</code>s of the class try to call them. Take the copy constructor in uncopyable <code>basic_ios</code> class for example:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span> <span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">charT</span><span style="color:#111">,</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">traits</span> <span style="color:#f92672">=</span> <span style="color:#111">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#111">charT</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">basic_ios</span> <span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">ios_base</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">basic_ios</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">basic_ios</span><span style="color:#f92672">&amp;</span><span style="color:#111">)</span><span style="color:#111">;</span>            <span style="color:#75715e">// not defined
</span><span style="color:#75715e"></span>    <span style="color:#111">basic_ios</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">basic_ios</span><span style="color:#f92672">&amp;</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// not defined
</span><span style="color:#75715e"></span><span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>As a comparason, deleted functions may not be used in any way, so even code that's in member and <code>friend</code> functions will fail to compile if it tries to copy <code>basic_ios</code> objects:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span> <span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">charT</span><span style="color:#111">,</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">traits</span> <span style="color:#f92672">=</span> <span style="color:#111">char_traits</span><span style="color:#f92672">&lt;</span><span style="color:#111">charT</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">basic_ios</span> <span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">ios_base</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#111">basic_ios</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">basic_ios</span><span style="color:#f92672">&amp;</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">delete</span> <span style="color:#111">;</span>
    <span style="color:#111">basic_ios</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">basic_ios</span><span style="color:#f92672">&amp;</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">delete</span><span style="color:#111">;</span>
 
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Note that by convertion, deleted functions are declared <code>public</code> instead of <code>private</code>, because C++ checks accessibility before deleted status. When client code tries to use a deleted <code>private</code> function, some compilers complain only about the function being <code>private</code>. If declaring those functions in <code>public</code>, we will get better error messages.</p>
<h1 id="disable-non-member-functions">Disable non-member functions</h1>
<p>Functions may be deleted outside classes, while <code>private</code> functions are always member functions inside some class. For example, we may use <code>delete</code> to prevent implicit numerical conversion into <code>int</code> for a non-member function <code>isLucky</code>, which takes in i
nteger and returns whether it's a lucky number:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">bool</span> <span style="color:#75af00">isLucky</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">number</span><span style="color:#111">)</span><span style="color:#111">;</span>      <span style="color:#75715e">// original function
</span><span style="color:#75715e"></span><span style="color:#00a8c8">bool</span> <span style="color:#75af00">isLucky</span><span style="color:#111">(</span><span style="color:#00a8c8">char</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">delete</span><span style="color:#111">;</span>   <span style="color:#75715e">// reject chars
</span><span style="color:#75715e"></span><span style="color:#00a8c8">bool</span> <span style="color:#75af00">isLucky</span><span style="color:#111">(</span><span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">delete</span><span style="color:#111">;</span>   <span style="color:#75715e">// reject bools
</span><span style="color:#75715e"></span><span style="color:#00a8c8">bool</span> <span style="color:#75af00">isLucky</span><span style="color:#111">(</span><span style="color:#00a8c8">double</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">delete</span><span style="color:#111">;</span> <span style="color:#75715e">// reject doubles and floats
</span></code></pre></td></tr></table>
</div>
</div><h1 id="disable-special-template-instantiations">Disable special template instantiations</h1>
<p>Suppose we want to handle specail cases of <code>void*</code> and <code>char*</code> in the <code>processProinter</code> template, we may simply delete those instantiations:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">t</span>
<span style="color:#111">emplate</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">processProinter</span><span style="color:#111">(</span><span style="color:#111">T</span><span style="color:#f92672">*</span> <span style="color:#111">ptr</span><span style="color:#111">)</span><span style="color:#111">;</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">processProinter</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">void</span><span style="color:#f92672">*</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#00a8c8">void</span><span style="color:#f92672">*</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">delete</span><span style="color:#111">;</span>
<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">processProinter</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">char</span><span style="color:#f92672">*</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#00a8c8">char</span><span style="color:#f92672">*</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">delete</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="disable-speacial-member-function-template-instanciation">Disable speacial member function template instanciation</h1>
<p>Since template specializations must be written at namespace scope, not class scope, we can't adopt the C++98 convertion to disable specialization of a member function template from being called. Delete functions, however, won't be restricted by class scope, so we can simply delete the specialization outside the class:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Widget</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
    <span style="color:#00a8c8">void</span> <span style="color:#111">processProinter</span><span style="color:#111">(</span><span style="color:#111">T</span><span style="color:#f92672">*</span> <span style="color:#111">ptr</span><span style="color:#111">)</span>
    <span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">Widget</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">processProinter</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">void</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#00a8c8">void</span><span style="color:#f92672">*</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">delete</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
