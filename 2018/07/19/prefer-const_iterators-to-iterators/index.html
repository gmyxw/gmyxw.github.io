<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>[EMCpp]Item-13 Prefer Const_iterators to Iterators - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>[EMCpp]Item-13 Prefer Const_iterators to Iterators</h1>
  </div>
<div class="meta">
  <div>2018-07-19 18:48</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>In maximally generic code, prefer non-member versions of <code>begin</code>, <code>end</code>, <code>rbegin</code>, etc., over their member function counterparts.</p>
<p>In C++98, using <code>const</code> whenever it's meaningful wasn't practical: it wasn't that easy to create them, and once we had one, the ways we could use it were limited. For example:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">vector</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">int</span><span style="color:#f92672">&gt;</span> <span style="color:#111">values</span><span style="color:#111">;</span>
<span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">vector</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">int</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">iterator</span> <span style="color:#111">it</span> <span style="color:#f92672">=</span> 
    <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">find</span><span style="color:#111">(</span><span style="color:#111">values</span><span style="color:#111">.</span><span style="color:#111">begin</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">values</span><span style="color:#111">.</span><span style="color:#111">end</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#ae81ff">1983</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">values</span><span style="color:#111">.</span><span style="color:#111">insert</span><span style="color:#111">(</span><span style="color:#111">it</span><span style="color:#111">,</span> <span style="color:#ae81ff">1998</span><span style="color:#111">)</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>The code above search for the first occurrence of 1983 (the year &ldquo;C++&rdquo; replaced &ldquo;C with Classes&rdquo;), then insert the value 1998 (first ISO C++ Standard was adopted) at that location. If no 1983 found, insert at the end of the vector. Since the code never modifies what an <code>iterator</code> points to, so acoording to the convention to use <code>const</code> whenever possible, we should use the const-iterator.</p>
<p>However, in C++98, there was no simple way to get a <code>const_iterator</code> from a non-<code>const</code> container. To work it out, we might concider using the cast like the following code, which conceptually works but probably won't compile:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">typedef</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">vector</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">int</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">iterator</span> <span style="color:#111">IterT</span><span style="color:#111">;</span>
<span style="color:#00a8c8">typedef</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">vector</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">int</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">const_iterator</span> <span style="color:#111">ConstIterT</span><span style="color:#111">;</span>

<span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">vector</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">int</span><span style="color:#f92672">&gt;</span> <span style="color:#111">values</span><span style="color:#111">;</span>
<span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">ConstIterT</span> <span style="color:#111">ci</span> <span style="color:#f92672">=</span> 
    <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">find</span><span style="color:#111">(</span><span style="color:#00a8c8">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#111">ConstIterT</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">values</span><span style="color:#111">.</span><span style="color:#111">begin</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">,</span>
              <span style="color:#00a8c8">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#111">ConstIterT</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">values</span><span style="color:#111">.</span><span style="color:#111">end</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">,</span>
              <span style="color:#ae81ff">1983</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">values</span><span style="color:#111">.</span><span style="color:#111">insert</span><span style="color:#111">(</span><span style="color:#00a8c8">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#111">IterT</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">ci</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#ae81ff">1998</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// may not compile
</span></code></pre></td></tr></table>
</div>
</div><p>The problem here is that in C++98, <code>const_iterator</code>s weren't acceptable for insertions and erasures, so we cast <code>ci</code> into its non-const version. However, in C++98, there's no portable conversion from a <code>const_iterator</code> to an <code>iterator</code><sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>, so the last statement probably won't compile. The conclusion: <code>const_iterator</code>s were so much trouble in C++98.</p>
<p>Now that we in the new world of C++11, <code>const_iterator</code>s are both easy to get and easy to use. Even for non-const containers, we get <code>cbegin</code> and <code>cend</code> to produce <code>const_iterator</code>s:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">vector</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">int</span><span style="color:#f92672">&gt;</span> <span style="color:#111">values</span><span style="color:#111">;</span>
<span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">auto</span> <span style="color:#111">it</span> <span style="color:#f92672">=</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">find</span><span style="color:#111">(</span><span style="color:#111">values</span><span style="color:#111">.</span><span style="color:#111">cbegin</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">values</span><span style="color:#111">.</span><span style="color:#111">cend</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#ae81ff">1983</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">values</span><span style="color:#111">.</span><span style="color:#111">insert</span><span style="color:#111">(</span><span style="color:#111">it</span><span style="color:#111">,</span> <span style="color:#ae81ff">1998</span><span style="color:#111">)</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="maximally-generic-support">Maximally Generic Support</h4>
<p>Taking into account that some containers and container-like data structures offer <code>begin</code> and <code>end</code> as <em>non-member</em> functions, C++11 added the non-member functions <code>begin</code> and <code>end</code> to make sure some generic library code using non-member functions is possible.</p>
<p>C++14 rectified the oversight in C++11, adding the support for <code>cbegin</code>, <code>cend</code>, <code>rbegin</code>, <code>rend</code>, <code>crbegin</code>, and <code>crend</code>. Now we could generalize the code above into a <code>findAndInsert</code> template as follow:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">C</span><span style="color:#111">,</span> <span style="color:#00a8c8">typename</span> <span style="color:#111">V</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">findAndInsert</span><span style="color:#111">(</span><span style="color:#111">C</span><span style="color:#f92672">&amp;</span> <span style="color:#111">container</span><span style="color:#111">,</span>       <span style="color:#75715e">// find first occurrence of targetVal in container
</span><span style="color:#75715e"></span>                   <span style="color:#00a8c8">const</span> <span style="color:#111">V</span><span style="color:#f92672">&amp;</span> <span style="color:#111">targetVal</span><span style="color:#111">,</span> <span style="color:#75715e">// then insert insertVal there
</span><span style="color:#75715e"></span>                   <span style="color:#00a8c8">const</span> <span style="color:#111">V</span><span style="color:#f92672">&amp;</span> <span style="color:#111">insertVal</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">using</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">cbegin</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">using</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">cend</span><span style="color:#111">;</span>

    <span style="color:#00a8c8">auto</span> <span style="color:#111">it</span> <span style="color:#f92672">=</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">find</span><span style="color:#111">(</span><span style="color:#111">cbegin</span><span style="color:#111">(</span><span style="color:#111">container</span><span style="color:#111">)</span><span style="color:#111">,</span>  <span style="color:#75715e">// non-member cbegin
</span><span style="color:#75715e"></span>                        <span style="color:#111">cend</span><span style="color:#111">(</span><span style="color:#111">container</span><span style="color:#111">)</span><span style="color:#111">,</span>    <span style="color:#75715e">// non-member cend
</span><span style="color:#75715e"></span>                        <span style="color:#111">targetVal</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">container</span><span style="color:#111">.</span><span style="color:#111">insert</span><span style="color:#111">(</span><span style="color:#111">it</span><span style="color:#111">,</span> <span style="color:#111">insertVal</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>If we're using C++11 and want to write maximally generic code, we may build our own implementation for non-member <code>cbegin</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">C</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">auto</span> <span style="color:#111">cbegin</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">C</span><span style="color:#f92672">&amp;</span> <span style="color:#111">container</span><span style="color:#111">)</span> <span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span> <span style="color:#00a8c8">decltype</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">begin</span><span style="color:#111">(</span><span style="color:#111">container</span><span style="color:#111">)</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">begin</span><span style="color:#111">(</span><span style="color:#111">container</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Point here is: through its reference-to-<code>const</code> parameter, <code>container</code>, we are invoking the non-member <code>begin</code> function (provided by C++11) on a <code>const</code> container, and this process yields a <code>const_iterator</code>. In fact, this template works even if <code>C</code> is a built-in array type<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>It's true in C++11, too. <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>For insight into how a template can be specialized for built-in arrays, consult EMCpp item 1's discussion of type deduction in templates that take reference parameters to arrays. <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
