<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>[EMCpp]Item-1 Understand Template Type Deduction - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>[EMCpp]Item-1 Understand Template Type Deduction</h1>
  </div>
<div class="meta">
  <div>2018-07-02 22:44</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>There are three sets of rules for type deduction in modern C++: one for function templates, one for <code>auto</code>, and one for <code>decltype</code>. Without a solid understanding of how deduction operates, effective programming in modern C++ is all but impossible.</p>
<!-- toc -->
<p>Since type deduction for templates is the basis of that for <code>auto</code>, it's important to truly understand the aspects of template type deduction that <code>auto</code> builds on: during template type deduction, there are three cases for parameter types:</p>
<ol>
<li>pointer type or non-universal reference type</li>
<li>universal reference type</li>
<li>neither a pointer nor a reference (value type)</li>
</ol>
<p>Moreover, there's a niche case worth knowing about, that arguments that are array or function names decay to pointers unless they're used to initialize references.</p>
<p>To tell the difference, let's think of a function template as looking like this:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">tempalte</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">ParamType</span> <span style="color:#111">param</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">expr</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// deduce T and ParamType from expr
</span></code></pre></td></tr></table>
</div>
</div><h1 id="case-1-paramtype-is-reference-or-pointer-but-not-a-universal-reference">Case 1: <code>ParamType</code> is Reference or Pointer, but not a Universal Reference</h1>
<p>The rules in this case works like this:</p>
<ol>
<li>If <code>expr</code>'s type is a reference, ignore the reference part.</li>
<li>Then pattern-match <code>expr</code>'s type against <code>ParamType</code> to determine T.</li>
</ol>
<p>For example,</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">T</span><span style="color:#f92672">&amp;</span> <span style="color:#111">param</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// param is a reference
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">int</span> <span style="color:#111">x</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">27</span><span style="color:#111">;</span>         <span style="color:#75715e">// x is an int
</span><span style="color:#75715e"></span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">int</span> <span style="color:#111">cx</span> <span style="color:#f92672">=</span> <span style="color:#111">x</span><span style="color:#111">;</span>   <span style="color:#75715e">// cx is a const int
</span><span style="color:#75715e"></span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">int</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rx</span> <span style="color:#f92672">=</span> <span style="color:#111">x</span><span style="color:#111">;</span>  <span style="color:#75715e">// rx is a refrence to x as a const int
</span><span style="color:#75715e"></span>
<span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#111">)</span><span style="color:#111">;</span>   <span style="color:#75715e">// T is int, param&#39;s type is int&amp;
</span><span style="color:#75715e"></span><span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">cx</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// T is const int, param&#39;s type is const int&amp;
</span><span style="color:#75715e"></span><span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">rx</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// T is const int, param&#39;s type is const int&amp;
</span></code></pre></td></tr></table>
</div>
</div><p>Note that even though rx's type is a reference, T is deduced to be a non-reference, because rx's reference-ness is ignored during type deduction.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">T</span><span style="color:#f92672">&amp;</span> <span style="color:#111">param</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// param is now a ref-to-const, 
</span><span style="color:#75715e"></span>                         <span style="color:#75715e">// so there&#39;s no longer a need for const to be deduced as part of T
</span><span style="color:#75715e"></span><span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// T is int, param&#39;s type is const int&amp;
</span><span style="color:#75715e"></span><span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">cx</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// T is int, param&#39;s type is const int&amp;
</span><span style="color:#75715e"></span><span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">rx</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// T is int, param&#39;s type is const int&amp;
</span></code></pre></td></tr></table>
</div>
</div><p>As before, rx's reference-ness is ignored during type deduction.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">T</span><span style="color:#f92672">*</span> <span style="color:#111">param</span><span style="color:#111">)</span><span style="color:#111">;</span>     <span style="color:#75715e">// param is now a pointer
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">int</span> <span style="color:#111">x</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">27</span><span style="color:#111">;</span>           <span style="color:#75715e">// x is an int
</span><span style="color:#75715e"></span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">int</span> <span style="color:#f92672">*</span><span style="color:#111">px</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#111">x</span><span style="color:#111">;</span>   <span style="color:#75715e">// px is a ptr to x as a const int
</span><span style="color:#75715e"></span>
<span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#111">x</span><span style="color:#111">)</span><span style="color:#111">;</span>   <span style="color:#75715e">// T is int, param&#39;s type is int*
</span><span style="color:#75715e"></span><span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">px</span><span style="color:#111">)</span><span style="color:#111">;</span>   <span style="color:#75715e">// T is const int, param&#39;s type is const int*
</span></code></pre></td></tr></table>
</div>
</div><p>As shown above, when param were a pointer (or a pointer to const), things work essentially the same way.</p>
<h1 id="case-2-paramtype-is-a-universal-reference">Case 2: <code>ParamType</code> is a Universal Reference</h1>
<p>Things are less obvious for templates taking universal reference paramters:</p>
<ol>
<li>If <code>expr</code> is an lvalue, both <code>T</code> and <code>ParamType</code> are deduced to be lvalue references.</li>
<li>If <code>expr</code> is an rvalue, the &ldquo;normal&rdquo; (i.e., case 1) rules apply.</li>
</ol>
<p>For example:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">T</span><span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> <span style="color:#111">param</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// param is now a universal reference
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">int</span> <span style="color:#111">x</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">27</span><span style="color:#111">;</span>         <span style="color:#75715e">// as before
</span><span style="color:#75715e"></span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">int</span> <span style="color:#111">cx</span> <span style="color:#f92672">=</span> <span style="color:#111">x</span><span style="color:#111">;</span>   <span style="color:#75715e">// as before
</span><span style="color:#75715e"></span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">int</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rx</span> <span style="color:#f92672">=</span> <span style="color:#111">x</span><span style="color:#111">;</span>  <span style="color:#75715e">// as before
</span><span style="color:#75715e"></span>
<span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// x is lvalue, so T is int&amp;, param&#39;s type is also int&amp;
</span><span style="color:#75715e"></span><span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">cx</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// x is lvalue, so T is const int&amp;, param&#39;s type is also const int&amp;
</span><span style="color:#75715e"></span><span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">rx</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// x is lvalue, so T is const int&amp;, param&#39;s type is also const int&amp;
</span><span style="color:#75715e"></span><span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#ae81ff">27</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// x is rvlaue, so T is int, param&#39;s type is therefore int&amp;&amp;
</span></code></pre></td></tr></table>
</div>
</div><p>EMCpp Item24 explains why these examples play out the way they do.</p>
<h1 id="case-3-paramtype-is-neither-a-pointer-nor-a-reference">Case 3: <code>ParamType</code> is Neither a Pointer nor a Reference</h1>
<p>In this case, we're dealing with pass-by-value. That means that <code>param</code> will be a new object, which motivates the rules below:</p>
<ol>
<li>As before, if <code>expr</code>'s type is a reference, ignore the reference part</li>
<li>If, after ignoring <code>expr</code>'s reference-ness, <code>expr</code> is const, ignore that, too. If it's <code>volatile</code>, also ignore that (refer to EMCpp item 40 for <code>volatile</code>).</li>
</ol>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">T</span> <span style="color:#111">param</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// param is now passed by value
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">int</span> <span style="color:#111">x</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">27</span><span style="color:#111">;</span>         <span style="color:#75715e">// as before
</span><span style="color:#75715e"></span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">int</span> <span style="color:#111">cx</span> <span style="color:#f92672">=</span> <span style="color:#111">x</span><span style="color:#111">;</span>   <span style="color:#75715e">// as before
</span><span style="color:#75715e"></span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">int</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rx</span> <span style="color:#f92672">=</span> <span style="color:#111">x</span><span style="color:#111">;</span>  <span style="color:#75715e">// as before
</span><span style="color:#75715e"></span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span><span style="color:#f92672">*</span> <span style="color:#00a8c8">const</span> <span style="color:#111">ptr</span> <span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">Fun with pointers</span><span style="color:#d88200">&#34;</span><span style="color:#111">;</span> <span style="color:#75715e">// ptr is const ptr to const obj.
</span><span style="color:#75715e"></span>
<span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// T&#39;s and param&#39;s types are both int
</span><span style="color:#75715e"></span><span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">cx</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// T&#39;s and param&#39;s types are both int
</span><span style="color:#75715e"></span><span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">rx</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// T&#39;s and param&#39;s types are both int
</span><span style="color:#75715e"></span><span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">ptr</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// T&#39;s and param&#39;s types are const char*, the constness of ptr is ignored.
</span></code></pre></td></tr></table>
</div>
</div><h1 id="array-arguments">Array Arguments</h1>
<p>Even though they sometimes seems to be interchangeable, array types are, in fact, different from pointer types. We had such equivalence illusion because, in many contexts, an array <em>decays</em> into a pointer to its first element:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#111">name</span><span style="color:#111">[</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">J.P. Briggs</span><span style="color:#d88200">&#34;</span><span style="color:#111">;</span>  <span style="color:#75715e">// name&#39;s type is const char [13]
</span><span style="color:#75715e"></span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span> <span style="color:#111">ptrToName</span> <span style="color:#f92672">=</span> <span style="color:#111">name</span><span style="color:#111">;</span>      <span style="color:#75715e">// array decays to pointer
</span></code></pre></td></tr></table>
</div>
</div><p>Array parameter declarations are treated as if they were pointer parameters, so <code>void myFunc(int param[]);</code> is equivalent to <code>void myFunc(int* param);</code>. Thus, the type of an array that's passed to a template function by value is deduced to be a pointer type:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">T</span> <span style="color:#111">param</span><span style="color:#111">)</span><span style="color:#111">;</span>

<span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">name</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// name is array, but T deduced as const char*
</span></code></pre></td></tr></table>
</div>
</div><p>Although functions can't declare parameters that are truly arrays, they <em>can</em> declare parameters that are <em>references</em> to arrays. Thus,</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">T</span><span style="color:#f92672">&amp;</span> <span style="color:#111">param</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// template with by-reference parameter
</span><span style="color:#75715e"></span>
<span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">name</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// T is deduced as array type: const char [13], type of param is const char (&amp;)[13]
</span></code></pre></td></tr></table>
</div>
</div><p>The actual type of the array includes the array size, so in this example, <code>T</code> is deduced to be <code>const char[13]</code>, and the type of <code>f</code>'s parameter (a reference to this array) is <code>const char (&amp;)[13]</code>.</p>
<p>Using this ability to declare references to arrays enables creation of a template that deduces the number of elements that an array contains:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// return size of an array as a compile-time constant.
</span><span style="color:#75715e"></span><span style="color:#75715e">// array parameter has no name because we don&#39;t care its name
</span><span style="color:#75715e"></span><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#111">,</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">size_t</span> <span style="color:#111">N</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">constexpr</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">size_t</span> <span style="color:#111">arraySize</span><span style="color:#111">(</span><span style="color:#111">T</span> <span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#111">)</span><span style="color:#111">[</span><span style="color:#111">N</span><span style="color:#111">]</span><span style="color:#111">)</span> <span style="color:#00a8c8">noexcept</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">N</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>There are two points worth noting in this declaration:</p>
<ol>
<li>
<p><code>constexpr</code>, as explained in EMCpp 15, makes the function result available during compilation, which makes it possible to declare an array with the same number of elements as a second array whose size is computed from a braced initializer:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">int</span> <span style="color:#111">keyVals</span><span style="color:#111">[</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">{</span> <span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">,</span> <span style="color:#ae81ff">7</span><span style="color:#111">,</span> <span style="color:#ae81ff">9</span><span style="color:#111">,</span> <span style="color:#ae81ff">11</span><span style="color:#111">,</span> <span style="color:#ae81ff">22</span><span style="color:#111">,</span> <span style="color:#ae81ff">35</span> <span style="color:#111">}</span><span style="color:#111">;</span>  <span style="color:#75715e">// 7 elements
</span><span style="color:#75715e"></span><span style="color:#00a8c8">int</span> <span style="color:#111">mappedVals</span><span style="color:#111">[</span><span style="color:#111">arraySize</span><span style="color:#111">(</span><span style="color:#111">keyVals</span><span style="color:#111">)</span><span style="color:#111">]</span><span style="color:#111">;</span> <span style="color:#75715e">// 7 elements
</span><span style="color:#75715e"></span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">array</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#111">arraySize</span><span style="color:#111">(</span><span style="color:#111">keyVals</span><span style="color:#111">)</span><span style="color:#f92672">&gt;</span> <span style="color:#111">values</span><span style="color:#111">;</span>  <span style="color:#75715e">// size == 7
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>noexcept</code>, as explained in EMCpp 14, helps compilers generate better code.</p>
</li>
</ol>
<h1 id="function-arguments">Function Arguments</h1>
<p>Apart from arrays, function types can decay into function pointers, too. As a result:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#75af00">someFunc</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#00a8c8">double</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// someFunc is a function, type is void(int, double)
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">f1</span><span style="color:#111">(</span><span style="color:#111">T</span> <span style="color:#111">param</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// in f1, param passed by value
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">f2</span><span style="color:#111">(</span><span style="color:#111">T</span><span style="color:#f92672">&amp;</span> <span style="color:#111">param</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// in f2, param passed by ref
</span><span style="color:#75715e"></span>
<span style="color:#111">f1</span><span style="color:#111">(</span><span style="color:#111">someFunc</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// param deduced as ptr-to-func, type is void (*)(int, double)
</span><span style="color:#75715e"></span>
<span style="color:#111">f2</span><span style="color:#111">(</span><span style="color:#111">someFunc</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// param deduced as ref-to-func, type is void (&amp;)(int, double)
</span></code></pre></td></tr></table>
</div>
</div><p>This rarely makes any difference in practice.</p></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
