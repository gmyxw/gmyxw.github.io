<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>[EMCpp]Item-21 Prefer std::make_unique and std::make_shared to Direct Use of New - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>[EMCpp]Item-21 Prefer std::make_unique and std::make_shared to Direct Use of New</h1>
  </div>
<div class="meta">
  <div>2018-08-02 18:45</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>Compared to <code>new</code>, make functions eliminate source code duplication, improve exception safety, and, for <code>std::make_shard</code> and <code>std::allocate_shared</code>, generate code that's smaller and faster.</p>
<p><em>Make functions</em> take an arbitrary set of arguments, perfect forward them to the constructor for a dynamically allocacted object, and return a smart pointer to that objet. There are three <em>make functions</em>:</p>
<ul>
<li><code>std::make_unique</code></li>
<li><code>std::make_shared</code></li>
<li><code>std::allocate_shared</code><sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></li>
</ul>
<p>According to the description above, a basic version of <code>std::make_unique</code> is simply:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#111">,</span> <span style="color:#00a8c8">typename</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span> <span style="color:#111">Ts</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">unique_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span> <span style="color:#111">make_unique</span><span style="color:#111">(</span><span style="color:#111">Ts</span><span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span> <span style="color:#111">params</span><span style="color:#111">)</span><span style="color:#111">{</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">unique_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">T</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">forward</span><span style="color:#f92672">&lt;</span><span style="color:#111">Ts</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">params</span><span style="color:#111">)</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="good-parts">Good parts</h4>
<p>There are thee reasons to prefer make functions to direct use of <code>new</code>.</p>
<ol>
<li>
<p>Eliminate code duplication</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">auto</span> <span style="color:#75af00">upw1</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">make_unique</span><span style="color:#f92672">&lt;</span><span style="color:#111">Widget</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">unique_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">Widget</span><span style="color:#f92672">&gt;</span> <span style="color:#111">upw2</span><span style="color:#111">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">Widget</span><span style="color:#111">)</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>As we can see above, using make functions avoids code duplication of the repeating type <code>Widget</code>.</p>
</li>
<li>
<p>Improve exception safety</p>
<p>Given following functions:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#75af00">processWidget</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">shared_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">Widget</span><span style="color:#f92672">&gt;</span> <span style="color:#111">spw</span><span style="color:#111">,</span> <span style="color:#00a8c8">int</span> <span style="color:#111">priority</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#00a8c8">int</span> <span style="color:#75af00">computePriority</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>then there will be potential resource leak if we directly use <code>new</code> like this:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">processWidget</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">shared_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">Widget</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">Widget</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">computePriority</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>The potential edge case comes with compilers&rsquo; translation of source code into object code: compilers may emit code to execute the operations in this order:</p>
<ol>
<li>Perform &ldquo;new Widget&rdquo;</li>
<li>Execute <code>computePriority</code></li>
<li>Run <code>std::shared_ptr</code> constructor</li>
</ol>
<p>At runtime, if <code>computePriority</code> produces an exception, the dynamically allocated Widget from Step 1 will be leaked, since it will never be stored in the <code>std::shared_ptr</code> that's supposed to start managing it in Step 3.</p>
<p>If we use <code>std::make_shared</code> instead of using <code>new</code> inside <code>std::shared_ptr</code>, there's no Step 1, so Step 2 will never be executed between a <code>new</code> operation and the construction of <code>std::shared_ptr</code>, which is thus exception-safe.</p>
</li>
<li>
<p>Smaller and faster code for <code>std::shared_ptr</code></p>
<p>Compared with direct use of <code>new</code>, the improved efficiency provided by <code>std::make_shared</code> and <code>std::allocate_shared</code> is related with its memory allocation mechanism.</p>
<ul>
<li>If we directly use <code>new</code> like this - <code>std::shared_ptr&lt;Widget&gt; spw(new Widget);</code> - there are two phaces of allocation involved:
<ul>
<li>one for <code>Widget</code> object,</li>
<li>another for the control block associated with that object.</li>
</ul>
</li>
<li>Instead, <code>auto spw = std::make_shared&lt;Widget&gt;();</code>, one allocation suffices: <code>std::make_shared</code> allocates a single chunk of memory to hold both the <code>Widget</code> object and the constrol block.
<ul>
<li>This optimization reduces the static size of the program, since the code contains only one memory allocation call</li>
<li>This operation also increases the speed of the executable code, since memory is allocated only once</li>
<li>Further more, total memory footprint is potentially reduced, since some of the bookkeeping information in the control block is obviated.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="weak-parts">Weak parts</h4>
<ol>
<li>
<p>Specify custom deleters</p>
<p>There's no way to specify a custom deleter using a make function, but using <code>new</code> is straightforward:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">auto</span> <span style="color:#111">widgetDeleter</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">(</span><span style="color:#111">Widget</span><span style="color:#f92672">*</span> <span style="color:#111">pw</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span><span style="color:#111">;</span>
<span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">unique_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">Widget</span><span style="color:#111">,</span> <span style="color:#00a8c8">decltype</span><span style="color:#111">(</span><span style="color:#111">widgettDeleter</span><span style="color:#111">)</span><span style="color:#f92672">&gt;</span> <span style="color:#111">upw</span><span style="color:#111">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">Widget</span><span style="color:#111">,</span> <span style="color:#111">widgetDeleter</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">shared_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">Widget</span><span style="color:#f92672">&gt;</span> <span style="color:#111">spw</span><span style="color:#111">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">Widget</span><span style="color:#111">,</span> <span style="color:#111">widgetDeleter</span><span style="color:#111">)</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Pass braced initializers</p>
<p>In these calls,</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">auto</span> <span style="color:#111">upv</span> <span style="color:#f92672">=</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">make_unique</span><span style="color:#f92672">&lt;</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">vector</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">int</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#ae81ff">10</span><span style="color:#111">,</span> <span style="color:#ae81ff">20</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#00a8c8">auto</span> <span style="color:#111">spv</span> <span style="color:#f92672">=</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">make_shared</span><span style="color:#f92672">&lt;</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">vector</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">int</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#ae81ff">10</span><span style="color:#111">,</span> <span style="color:#ae81ff">20</span><span style="color:#111">)</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>the resulting smart pointers point to <code>std::vector</code>s with 10 elements, each of value 20, which means within the make functions, the perfect forwarding code uses the non-<code>std::initializer_list</code> constructor. If we do want to perfect-forward a braced initializer, we use following workaround;</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">auto</span> <span style="color:#111">initList</span> <span style="color:#f92672">=</span> <span style="color:#111">{</span> <span style="color:#ae81ff">10</span><span style="color:#111">,</span> <span style="color:#ae81ff">20</span> <span style="color:#111">}</span><span style="color:#111">;</span> <span style="color:#75715e">// create std::initializer_list
</span><span style="color:#75715e"></span><span style="color:#00a8c8">auto</span> <span style="color:#111">spv</span> <span style="color:#f92672">=</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">make_shared</span><span style="color:#f92672">&lt;</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">vector</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">int</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">initList</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// create std:vector using std::initializer_list cotr
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Custom memory management or memory restriction concerns for <code>std::shared_ptr</code></p>
<p>Due to the extra control block in <code>std::shared_ptr</code>, there are two more edge cases where make functions may be ill-advised:</p>
<ul>
<li>classes with custom memory management:
<ul>
<li>if a class defines its own versions of <code>operator new</code> and <code>operator delete</code>, it implies the global memory allocation and deallocation routines for objects of this class are inappropriate.</li>
<li>class-specific routines are often designed only to allocate and deallocate chunks of memory of pricisely the size of objects of this class</li>
<li><code>std::allocate_shared</code> however requests to allocate the size of one object plus the size of a control block, so the class-specific routines are poor fit for <code>std::allocate_shared</code> and custom deleters.</li>
</ul>
</li>
<li>systems with memory concerns
<ul>
<li>when using <code>std::make_shared</code>, the memory allocation for the object and the control block is at the same time, which brings us the smaller and faster code mentioned above; however, this also means that the deallocation for the same chunk of memory has to be at the same time</li>
<li>when an object's reference count goes to zero, the object is destroyed (via its destructor), but the memory it occupies will wait to be released until the control block also gets destroyed</li>
<li>control block contains a <em>weak count</em> (a second reference count for <code>std::weak_ptr</code>); as long as the weak count is greater than zero, the control block must continue to exist</li>
<li>if the object type is quite large and the time between destrution of the last <code>std::shared_ptr</code> and the last <code>std::weak_ptr</code> is significant, a lag occurres between when an object is destroyed and when the memory this object (and its control block) occupied is freed</li>
<li>if memory is a concern, this lag will make us frown</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>Due to the reasons above, we may have to give up make function and directly use <code>new</code>, but we also want to keep our program exception-safe. Here is a workaround, take the same <code>processWidget</code> for example:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">shared_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">Widget</span><span style="color:#f92672">&gt;</span> <span style="color:#111">spw</span><span style="color:#111">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">Widget</span><span style="color:#111">,</span> <span style="color:#111">cusDel</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">processWidget</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">move</span><span style="color:#111">(</span><span style="color:#111">spw</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">computePriority</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// keep arg as rvalue, so it&#39;s move-enabled
</span></code></pre></td></tr></table>
</div>
</div><p>The <code>std::move</code> here is to make sure the argument we pass to <code>processWidget</code> is rvalue, so that expensive copy construction for a <code>std::shared_ptr</code> object, which involves atomic increment of its reference count, will be replaced by a move construction, which requires no reference count manipulation.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p><code>std::allocate_shared</code> acts just like <code>std::make_shared</code>, except its first argument is an allocator object to be used for the dynamic memory allocation. <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
