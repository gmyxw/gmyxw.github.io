<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>[EMCpp]Item-24 Distinguish Universal References From Rvalue References - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>[EMCpp]Item-24 Distinguish Universal References From Rvalue References</h1>
  </div>
<div class="meta">
  <div>2018-08-08 18:56</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>If a function template parameter has type <code>T&amp;&amp;</code> for a deduced type <code>T</code>, or if an object is declared using <code>auto&amp;&amp;</code>, the parameter or object is a <em>universal reference</em>.</p>
<p><code>T&amp;&amp;</code> has two different meanings: one is for rvalue reference, another is for universal reference. Universal references are called &ldquo;universal&rdquo;, because they can bind to virtually <em>anything</em>:</p>
<ul>
<li>bind to rvalues (behave like rvalue references <code>T&amp;&amp;</code>)</li>
<li>bind to lvalues (behave like lvalue references <code>T&amp;</code>)</li>
<li>bind to objects that is <code>const</code> or non-<code>const</code>, <code>volatile</code> or non-<code>volatile</code>, or both <code>const</code> and <code>volatile</code></li>
</ul>
<p>Universal refenrences must company with a special form (i.e., the form of &ldquo;<code>T&amp;&amp;</code>&rdquo;) after the occurrence of <em>type deduction</em>, and typically arise in two contexts: the most common case is function template parameters, while another context is <code>auto</code> declarations:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">T</span><span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> <span style="color:#111">param</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// param is a universal reference
</span><span style="color:#75715e"></span><span style="color:#00a8c8">auto</span><span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> <span style="color:#111">var2</span> <span style="color:#f92672">=</span> <span style="color:#111">var1</span><span style="color:#111">;</span>  <span style="color:#75715e">// var2 is a universal reference
</span><span style="color:#75715e"></span>
<span style="color:#111">Widget</span> <span style="color:#111">w</span><span style="color:#111">;</span>
<span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">w</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// lvalue passed to f; param&#39;s type is Widget&amp;, act as an lvalue ref.
</span><span style="color:#75715e"></span><span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">move</span><span style="color:#111">(</span><span style="color:#111">w</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// rvalue passed to f; param&#39;s type is Widget&amp;&amp;, act as an rvalue ref.
</span></code></pre></td></tr></table>
</div>
</div><p>If there's no type deduction, or if the type deduction form is incorrect (not in form of &ldquo;T&amp;&amp;&quot;), then there's no universal references:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#75af00">f</span><span style="color:#111">(</span><span style="color:#111">Widget</span><span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> <span style="color:#111">param</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// no type deduction; param is an rvalue reference
</span><span style="color:#75715e"></span><span style="color:#111">Widget</span><span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> <span style="color:#111">var1</span> <span style="color:#f92672">=</span> <span style="color:#111">Widget</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// no type deduction; param is an rvalue reference
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">vector</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> <span style="color:#111">param</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// not in precise form of T&amp;&amp;, param here is an rvalue ref.
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">f</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">T</span><span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> <span style="color:#111">param</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// not in precise form of T&amp;&amp;, param here is an rvalue ref.
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#111">,</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">Allocator</span> <span style="color:#f92672">=</span> <span style="color:#111">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span>  <span style="color:#75715e">// from C++ standards
</span><span style="color:#75715e"></span><span style="color:#00a8c8">class</span> <span style="color:#75af00">vector</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">void</span> <span style="color:#111">push_back</span><span style="color:#111">(</span><span style="color:#111">T</span><span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> <span style="color:#111">x</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// no type deduction here; x is rvalue reference;
</span><span style="color:#75715e"></span>    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>   <span style="color:#75715e">// a particular vector instantiation must have occurred prior to any call to this function
</span><span style="color:#75715e"></span><span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#111">,</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">Allocator</span> <span style="color:#f92672">=</span> <span style="color:#111">allocator</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span>  <span style="color:#75715e">// from C++ standards
</span><span style="color:#75715e"></span><span style="color:#00a8c8">class</span> <span style="color:#75af00">vector</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span><span style="color:#960050;background-color:#1e0010">.</span><span style="color:#960050;background-color:#1e0010">.</span><span style="color:#960050;background-color:#1e0010">.</span><span style="color:#960050;background-color:#1e0010"> </span><span style="color:#75af00">Args</span><span style="color:#f92672">&gt;</span>
    <span style="color:#00a8c8">void</span> <span style="color:#111">emplace_back</span><span style="color:#111">(</span><span style="color:#111">Args</span><span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span> <span style="color:#111">args</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// universal reference! because:
</span><span style="color:#75715e"></span>    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>  <span style="color:#75715e">// 1. in correct form of &#34;T&amp;&amp;&#34;; 2. type parameter Args must be deduced each time emplace_back is called
</span><span style="color:#75715e"></span><span style="color:#111">}</span>

<span style="color:#75715e">// this function can time pretty much any function execution. more information is in EMCpp item 30
</span><span style="color:#75715e"></span><span style="color:#00a8c8">auto</span> <span style="color:#111">timeFuncInvocation</span> <span style="color:#f92672">=</span>    <span style="color:#75715e">// C++14
</span><span style="color:#75715e"></span>    <span style="color:#111">[</span><span style="color:#111">]</span> <span style="color:#111">(</span><span style="color:#00a8c8">auto</span><span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> <span style="color:#111">func</span><span style="color:#111">,</span> <span style="color:#00a8c8">auto</span><span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span> <span style="color:#111">param</span><span style="color:#111">)</span>  <span style="color:#75715e">// func is a universal reference that can be bound to any callable object, lvaue or rvalue
</span><span style="color:#75715e"></span>    <span style="color:#111">{</span>   <span style="color:#75715e">// param is zero or more universal references (i.e., a universal reference parameter pack) that can be bound to any number of objects of arbitrary types
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// start timer;
</span><span style="color:#75715e"></span>        <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">forward</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">decltype</span><span style="color:#111">(</span><span style="color:#111">func</span><span style="color:#111">)</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">func</span><span style="color:#111">)</span><span style="color:#111">(</span>  <span style="color:#75715e">// invoke func on params
</span><span style="color:#75715e"></span>            <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">forward</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">decltype</span><span style="color:#111">(</span><span style="color:#111">params</span><span style="color:#111">)</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">params</span><span style="color:#111">)</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
        <span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#75715e">// stop timer and record elapsed time;
</span><span style="color:#75715e"></span>    <span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>In fact, the foundation of univeral references is a lie (an &ldquo;abstraction&rdquo;), with underlying truth being known as <em>reference collapsing</em> discussed in EMCpp Item 28. Distinguishing between rvalue references and universal references will help us read source code more accurately.</p></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
