<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>[MECpp]Item-27 Requiring or Prohibiting Heap Based Objects - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>[MECpp]Item-27 Requiring or Prohibiting Heap Based Objects</h1>
  </div>
<div class="meta">
  <div>2018-05-01 00:00</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>Techniques for requiring or prohibiting heap-based objects</p>
<!-- toc -->
<h1 id="requiring-heap-based-objects">Requiring Heap-Based Objects</h1>
<h2 id="1-the-straightforward-way">1. The straightforward way</h2>
<p>The brutle way is to declare the constructors and the destructor <code>private</code>, but this is overkill. Either one of them need to be private to ensure objects only be created on the heap. Since there are usually many constructors but only one destructor per class, a more elegant way is to make the destructor private and the constructors public, prividing privileged pseudo-destructor function (which has access to the real destructor) for clients to call, as suggested in MECpp item 26.</p>
<p>Example:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">UPNumber</span> <span style="color:#111">{</span> <span style="color:#75715e">// unlimited precision numbers that should only exist on the heap
</span><span style="color:#75715e"></span><span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">UPNumber</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">UPNumber</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">initValue</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">UPNumber</span><span style="color:#111">(</span><span style="color:#00a8c8">double</span> <span style="color:#111">initValue</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">UPNumber</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">UPNumber</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#75715e">// pseudo-destructor (a const member function, because even const obj. may be destroyed)
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">void</span> <span style="color:#75af00">destroy</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span> <span style="color:#111">{</span> <span style="color:#00a8c8">delete</span> <span style="color:#00a8c8">this</span><span style="color:#111">;</span> <span style="color:#111">}</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#f92672">~</span><span style="color:#111">UPNumber</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Clients would program like this:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">UPNumber</span> <span style="color:#111">n</span><span style="color:#111">;</span> <span style="color:#75715e">// error! (legal here, but illegal when n&#39;s dtor is implicitly invoked later)
</span><span style="color:#75715e"></span><span style="color:#111">UPNumber</span> <span style="color:#f92672">*</span><span style="color:#111">p</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">UPNumber</span><span style="color:#111">;</span> <span style="color:#75715e">// fine
</span><span style="color:#75715e"></span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">delete</span> <span style="color:#111">p</span><span style="color:#111">;</span> <span style="color:#75715e">// error! attempt to call private dtor
</span><span style="color:#75715e"></span><span style="color:#111">p</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">destroy</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// fine
</span></code></pre></td></tr></table>
</div>
</div><h2 id="2-inheritance-and-containment-friendly">2. Inheritance-and-containment friendly</h2>
<p>Restricting access to a class's destructor or constructors prevents the creation of not only non-heap objects, but also both inheritance and containment. To work this out:</p>
<ul>
<li>To be friendly for inheritance, we declare <code>protected</code> for <code>UPNumber</code>'s destructor.</li>
<li>To be friendly for containment, classes that need objects of type <code>UPNumber</code> can be modified to contain pointers to <code>UPNumber</code> object instead:</li>
</ul>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">UPNumer</span> <span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span><span style="color:#111">;</span>  <span style="color:#75715e">// declare dtor protected
</span><span style="color:#75715e"></span><span style="color:#00a8c8">class</span> <span style="color:#75af00">NonNegativeUPNumber</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">UPNumber</span> <span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span><span style="color:#111">;</span> <span style="color:#75715e">// okay to access protected members
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">Asset</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">Asset</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">initValue</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#f92672">~</span><span style="color:#111">Asset</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">UPNumber</span> <span style="color:#f92672">*</span><span style="color:#111">value</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#111">Asset</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">Asset</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">initValue</span><span style="color:#111">)</span>
<span style="color:#f92672">:</span> <span style="color:#111">value</span><span style="color:#111">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">UPNumber</span><span style="color:#111">(</span><span style="color:#111">initValue</span><span style="color:#111">)</span><span style="color:#111">)</span> <span style="color:#75715e">// fine
</span><span style="color:#75715e"></span><span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span>

<span style="color:#111">Asset</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">Asset</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span> <span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">destroy</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>  <span style="color:#75715e">// fine
</span></code></pre></td></tr></table>
</div>
</div><h2 id="3-determining-whether-an-object-is-on-the-heap">3. Determining Whether an Object is On The Heap</h2>
<p>It's hard to tell whether an object is on the heap. For example, given the class definition above, it's ligal to define a non-heap <code>NonNegativeUPNumber</code> object, which will not construct its base <code>UPNumber</code> part on the heap. There is no way to detect whether a constructor is being invoked as the base class part of a heap-based object, which means for the following contexts, it is not possible for the <code>UPNumber</code> constructor to detect the difference:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">NonNegativeUPNumber</span> <span style="color:#f92672">*</span><span style="color:#111">n1</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">NonNegativeUPNumber</span><span style="color:#111">;</span> <span style="color:#75715e">// on heap
</span><span style="color:#75715e"></span><span style="color:#111">NonNegativeUPNumber</span> <span style="color:#111">n2</span><span style="color:#111">;</span> <span style="color:#75715e">// not on heap
</span></code></pre></td></tr></table>
</div>
</div><p>Sadly, there's no portable way to determine whether an object is on the heap, and there isn't even a semi-portable way that works most of the time. Detailed dicussion on this topic could be found at <a href="http://www.aristeia.com/BookErrata/M27Comments.html">Comments on Item 27 of More Effective C++</a>.</p>
<p>We'll have to turn to unportable, implementation-dependent system calls if we absolutely have to tell whether an address is on the heap. That being the case, we'd better off trying to redesign the software so we don't need to determine whether an object is on the heap in the first place.</p>
<h2 id="4-determine-whether-its-safe-to-delete-a-pointer">4. Determine whether it's safe to delete a pointer</h2>
<p>To answer this easier question, all we need to do is to create a collection of addresses that have been returned by <code>operator new</code>. One possible solution is to provide an abstract mixin base class that offers derived classes the ability to determine whether a pointer was allocated from <code>operator new</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">HeapTracked</span> <span style="color:#111">{</span> <span style="color:#75715e">// mixin class; keeps track of ptrs returned from op. new
</span><span style="color:#75715e"></span><span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">class</span> <span style="color:#75af00">MissingAddress</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// exception class
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">virtual</span> <span style="color:#f92672">~</span><span style="color:#111">HeapTracked</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>

    <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#f92672">*</span><span style="color:#00a8c8">operator</span> <span style="color:#75af00">new</span><span style="color:#111">(</span><span style="color:#111">size_t</span> <span style="color:#111">size</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#00a8c8">operator</span> <span style="color:#75af00">delete</span><span style="color:#111">(</span><span style="color:#00a8c8">void</span> <span style="color:#f92672">*</span><span style="color:#111">ptr</span><span style="color:#111">)</span><span style="color:#111">;</span>

    <span style="color:#00a8c8">bool</span> <span style="color:#75af00">isOnHeap</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">typedef</span> <span style="color:#00a8c8">const</span> <span style="color:#00a8c8">void</span><span style="color:#f92672">*</span> <span style="color:#111">RawAddress</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">static</span> <span style="color:#111">list</span><span style="color:#f92672">&lt;</span><span style="color:#111">RawAddress</span><span style="color:#f92672">&gt;</span> <span style="color:#111">addresses</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// mandatory definition of static class member
</span><span style="color:#75715e"></span><span style="color:#111">list</span><span style="color:#f92672">&lt;</span><span style="color:#111">RawAddress</span><span style="color:#f92672">&gt;</span> <span style="color:#111">HeapTracked</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">address</span><span style="color:#111">;</span>
<span style="color:#75715e">// tho being pure virtual, dtor still needs to be defined
</span><span style="color:#75715e"></span><span style="color:#111">HEapTracked</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">HeapTracked</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#111">}</span>

<span style="color:#00a8c8">void</span> <span style="color:#f92672">*</span> <span style="color:#111">HeapTracked</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span> <span style="color:#00a8c8">new</span><span style="color:#111">(</span><span style="color:#111">size_t</span> <span style="color:#111">size</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">void</span> <span style="color:#f92672">*</span><span style="color:#111">memPtr</span> <span style="color:#f92672">=</span> <span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span> <span style="color:#00a8c8">new</span><span style="color:#111">(</span><span style="color:#111">size</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// get the memory
</span><span style="color:#75715e"></span>    <span style="color:#111">addresses</span><span style="color:#111">.</span><span style="color:#111">push_front</span><span style="color:#111">(</span><span style="color:#111">memPtr</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">memPtr</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">void</span> <span style="color:#111">HeapTracked</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span> <span style="color:#00a8c8">delete</span><span style="color:#111">(</span><span style="color:#00a8c8">void</span> <span style="color:#f92672">*</span><span style="color:#111">ptr</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#75715e">// gracefully handle null pointer
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">ptr</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#00a8c8">return</span><span style="color:#111">;</span>
    <span style="color:#111">list</span><span style="color:#f92672">&lt;</span><span style="color:#111">RawAddress</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">iterator</span> <span style="color:#111">it</span> <span style="color:#f92672">=</span> 
        <span style="color:#111">find</span><span style="color:#111">(</span><span style="color:#111">addresses</span><span style="color:#111">.</span><span style="color:#111">begin</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">addresses</span><span style="color:#111">.</span><span style="color:#111">end</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">ptr</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">it</span> <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#111">addresses</span><span style="color:#111">.</span><span style="color:#111">end</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#111">addresses</span><span style="color:#111">.</span><span style="color:#111">erase</span><span style="color:#111">(</span><span style="color:#111">it</span><span style="color:#111">)</span><span style="color:#111">;</span>     <span style="color:#75715e">// remove the entry
</span><span style="color:#75715e"></span>        <span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span> <span style="color:#00a8c8">delete</span><span style="color:#111">(</span><span style="color:#111">ptr</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// deallocate the memory
</span><span style="color:#75715e"></span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">throw</span> <span style="color:#75af00">MissingAddress</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// ptr wasn&#39;t allocated by op. new. throw an exception
</span><span style="color:#75715e"></span>    <span style="color:#111">}</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">bool</span> <span style="color:#111">HeapTracked</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">isOnHeap</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span>
<span style="color:#111">{</span>
    <span style="color:#75715e">// get a pointer to the beginning of the memory occupied by *this
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">const</span> <span style="color:#00a8c8">void</span> <span style="color:#f92672">*</span><span style="color:#111">rawAddress</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">dynamic_cast</span><span style="color:#f92672">&lt;</span><span style="color:#111">cosnt</span> <span style="color:#00a8c8">void</span><span style="color:#f92672">*</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#00a8c8">this</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">list</span><span style="color:#f92672">&lt;</span><span style="color:#111">RawAddress</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">iterator</span> <span style="color:#111">it</span> <span style="color:#f92672">=</span> 
        <span style="color:#111">find</span><span style="color:#111">(</span><span style="color:#111">addresses</span><span style="color:#111">.</span><span style="color:#111">begin</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">addresses</span><span style="color:#111">.</span><span style="color:#111">end</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">rawAddress</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">it</span> <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#111">addresses</span><span style="color:#111">.</span><span style="color:#111">end</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// return whether it was found
</span><span style="color:#75715e"></span><span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Note that <code>dynamic_cast</code> is applicable only to pointers to objects that have at least one virtual function, and <code>dynamic_cast</code>ing a pointer to <code>void*</code> (or <code>const void*</code> or <code>volatile void*</code> or <code>const volatile void*</code>) yields a pointer to the beginning of the memory for the object pointed to by the pointer. Here <code>dynamic_cast</code>ing <code>this</code> to <code>const void*</code> gives us a pointer to the beginning of the memory for the current object, which is the pointer previously returned by <code>HeapTracked::operator new</code> as long as the memory for the current object was allocated by <code>HeapTracked::operator new</code> in the first place.</p>
<p>To use this basic class, say we want to be able to determine whether a pointer to an <code>Asset</code> object points to a heap-based object, simply modify <code>Asset</code>'s class definition to specify <code>HeapTracked</code> as a base class:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Asset</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">HeapTracked</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">UPNumber</span> <span style="color:#111">value</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>And we could query <code>Asset*</code> pointers as follows:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#75af00">inventoryAsset</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Asset</span> <span style="color:#f92672">*</span><span style="color:#111">ap</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">ap</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">isOnHeap</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#111">as</span> <span style="color:#111">is</span> <span style="color:#111">a</span> <span style="color:#111">heap</span><span style="color:#f92672">-</span><span style="color:#111">based</span> <span style="color:#111">asset</span> <span style="color:#f92672">-</span><span style="color:#f92672">-</span> <span style="color:#111">inventory</span> <span style="color:#111">it</span> <span style="color:#111">as</span> <span style="color:#111">such</span>
    <span style="color:#111">}</span> 
    <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
        <span style="color:#111">ap</span> <span style="color:#111">is</span> <span style="color:#111">non</span><span style="color:#f92672">-</span><span style="color:#111">heap</span><span style="color:#f92672">-</span><span style="color:#111">based</span>  <span style="color:#111">asset</span>  <span style="color:#f92672">-</span><span style="color:#f92672">-</span> <span style="color:#111">record</span> <span style="color:#111">it</span> <span style="color:#111">that</span> <span style="color:#111">way</span>
    <span style="color:#111">}</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Since built-in types such as <code>int</code> and <code>char</code> can't inherit from anything, <code>HeapTracked</code> can't be used with these built-in types. Still, the most common reason for wanting to use a class like <code>HeapTracked</code> is to determine whether it's okay to <code>delete this</code>, and we don't want to do that with a built-in type because such types have no <code>this</code> pointer.</p>
<h1 id="prohibiting-heap-based-objects">Prohibiting Heap-Based Objects</h1>
<p>To preventing objects from being allocated on the heap, there are three cases:</p>
<ol>
<li>objects that are directly instantiated</li>
<li>objects instantiated as base class parts of derived class objects</li>
<li>objects embedded inside other objects</li>
</ol>
<h2 id="1-preventing-directly-instantiation-on-heap">1. Preventing directly instantiation on heap</h2>
<p>To prevent clients from directly instantiating objects on the heap: we can declare <code>operator new</code> (and possibly <code>operator new[]</code>) as <code>private</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">UPNumber</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#f92672">*</span><span style="color:#00a8c8">operator</span> <span style="color:#00a8c8">new</span><span style="color:#111">(</span><span style="color:#111">size_t</span> <span style="color:#111">size</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#00a8c8">operator</span> <span style="color:#75af00">delete</span><span style="color:#111">(</span><span style="color:#00a8c8">void</span> <span style="color:#f92672">*</span><span style="color:#111">ptr</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">UPNumber</span> <span style="color:#111">n1</span><span style="color:#111">;</span>  <span style="color:#75715e">// okay
</span><span style="color:#75715e"></span><span style="color:#00a8c8">static</span> <span style="color:#111">UPNumber</span> <span style="color:#111">n2</span><span style="color:#111">;</span>  <span style="color:#75715e">// okay
</span><span style="color:#75715e"></span><span style="color:#111">UPNumber</span> <span style="color:#f92672">*</span><span style="color:#111">p</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">UPNumber</span><span style="color:#111">;</span> <span style="color:#75715e">// error! attempt to call private operator new
</span></code></pre></td></tr></table>
</div>
</div><p>Declaring <code>operator new</code> private often also prevents <code>UPNumber</code> objects from being instantiated as base class parts of heap-based derived class objects, because <code>operator new</code> and <code>operator delete</code> are inherited, so if these functions aren't declared public in a derived class, that class inherits the private versions declared in its base(s):</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">UPNumber</span> <span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span><span style="color:#111">;</span> <span style="color:#75715e">// as above
</span><span style="color:#75715e"></span><span style="color:#00a8c8">class</span> <span style="color:#75af00">NonNegativeUPNumber</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">UPNumber</span> <span style="color:#111">{</span> <span style="color:#75715e">// declares no operator new
</span><span style="color:#75715e"></span>    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#111">NonNegativeUPNumber</span> <span style="color:#111">n1</span><span style="color:#111">;</span> <span style="color:#75715e">// okay
</span><span style="color:#75715e"></span><span style="color:#00a8c8">static</span> <span style="color:#111">NonNegativeUPNumber</span> <span style="color:#111">n2</span><span style="color:#111">;</span> <span style="color:#75715e">// okay
</span><span style="color:#75715e"></span><span style="color:#111">NonNegativeUPNumber</span> <span style="color:#f92672">*</span><span style="color:#111">p</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">NonNegativeUPNumber</span><span style="color:#111">;</span> <span style="color:#75715e">// error! attempt to call private operator new
</span></code></pre></td></tr></table>
</div>
</div><h2 id="2-preventing-base-class-parts-instantiated-on-heap">2. Preventing base class parts instantiated on heap</h2>
<p>However, if the derived class declares an <code>operator new</code> of its own, which will be called when allocating derived class objects on the heap, it is hard to prevent <code>UPNumber</code> base class parts from winding up there.</p>
<h2 id="3-preventing-base-class-parts-instantiated-on-heap">3. Preventing base class parts instantiated on heap</h2>
<p>Similarly, the fact that <code>UPNumber</code>'s <code>operator new</code> is private has no effect on attempts to allocate objects containing <code>UPNumber</code> objects as members:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Asset</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">Asset</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">initValue</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">UPNumber</span> <span style="color:#111">value</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#111">Asset</span> <span style="color:#f92672">*</span><span style="color:#111">pa</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">Asset</span><span style="color:#111">(</span><span style="color:#ae81ff">100</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// fine, calls Asset::operator new or ::operator new,
</span><span style="color:#75715e"></span>                             <span style="color:#75715e">// not UPNumber::operator new
</span></code></pre></td></tr></table>
</div>
</div><p>Just as there's no portable way to determine if an address is on the heap, however, there is no portable way to determine that it is not on the heap, so we can't throw an exception in the <code>UPNumber</code> constructors if a to-be-tested <code>UPNumber</code> object being constructed is on the heap. We're out of luck.</p></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
