<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>[MECpp]Item-29 Reference Counting - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>[MECpp]Item-29 Reference Counting</h1>
  </div>
<div class="meta">
  <div>2018-05-07 00:00</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>Reference counting is technique that allows multiple objects with the same value to share a sinple representation of that value.</p>
<!-- toc -->
<p>Consider a customized naive version of <code>class String;</code>: its assignment operator is implemented in a naive way:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">String</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">String</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">value</span> <span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">&#34;</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">String</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">String</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">data</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#111">String</span><span style="color:#f92672">&amp;</span> <span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">String</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#00a8c8">this</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#111">rhs</span><span style="color:#111">)</span> <span style="color:#00a8c8">return</span> <span style="color:#f92672">*</span><span style="color:#00a8c8">this</span><span style="color:#111">;</span>

    <span style="color:#00a8c8">delete</span><span style="color:#111">[</span><span style="color:#111">]</span> <span style="color:#111">data</span><span style="color:#111">;</span>
    <span style="color:#111">data</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#00a8c8">char</span><span style="color:#111">[</span><span style="color:#111">strlen</span><span style="color:#111">(</span><span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">data</span><span style="color:#111">)</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span><span style="color:#111">;</span>
    <span style="color:#111">strcpy</span><span style="color:#111">(</span><span style="color:#111">data</span><span style="color:#111">,</span> <span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">data</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">return</span> <span style="color:#f92672">*</span><span style="color:#00a8c8">this</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>When we write statement <code>a = b = c = d = e = &quot;Hello&quot;;</code> where <code>a</code>, <code>b</code>, <code>c</code>, <code>d</code> and <code>e</code> are all <code>String</code> type, we get five objects, each with the same value &ldquo;Hello&rdquo;:</p>
<pre><code>┌───┐     ┌───────┐   ┌───┐     ┌───────┐
│ a │ --&gt; │ Hello │   │ b │ --&gt; │ Hello │ 
└───┘     └───────┘   └───┘     └───────┘
┌───┐     ┌───────┐   ┌───┐     ┌───────┐
│ c │ --&gt; │ Hello │   │ d │ --&gt; │ Hello │ 
└───┘     └───────┘   └───┘     └───────┘
┌───┐     ┌───────┐
│ e │ --&gt; │ Hello │
└───┘     └───────┘
</code></pre><p>Ideally, we'd like to change the picture to look like this:</p>
<pre><code>┌───┐    
│ a ├──┐
└───┘  | 
┌───┐  | 
│ c ├──┤
└───┘  | 
┌───┐  |  ┌───────┐
│ e ├──┼─&gt;│ Hello │
└───┘  |  └───────┘
┌───┐  | 
│ e ├──┤
└───┘  │ 
┌───┐  │ 
│ e ├──┘
└───┘    
</code></pre><p>In practice, we need to keep track of how many objects are sharing - <em>refering to</em>- a value to make sure the best time to destroy or modify the value &ldquo;Hello&rdquo;, so we need to add <em>reference count</em> into the picuture:</p>
<pre><code>┌───┐    
│ a ├──┐
└───┘  | 
┌───┐  | 
│ c ├──┤
└───┘  | 
┌───┐  |  ┌───┐    ┌───────┐
│ c ├──┼─&gt;│ 5 ├───&gt;│ Hello │
└───┘  |  └───┘    └───────┘
┌───┐  | 
│ d ├──┤
└───┘  │ 
┌───┐  │ 
│ e ├──┘
└───┘    
</code></pre><h1 id="implementing-reference-counting">Implementing Reference Counting</h1>
<p>From the picture above, we can see we need one reference count per string <em>value</em>, instead of one per string <em>object</em>. This implies a decoupling between values and reference counts, leading to our first design: nesting a <code>StringValue</code> struct in the private part of <code>String</code> class, so that all the members of <code>String</code> class get full access to this inner data structure, while everybody else get denied (except friends of the class).</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">String</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">struct</span> <span style="color:#75af00">StringValue</span> <span style="color:#111">{</span> <span style="color:#75715e">// holds a reference count and a string value
</span><span style="color:#75715e"></span>        <span style="color:#111">size_t</span> <span style="color:#111">refCount</span><span style="color:#111">;</span>
        <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">data</span><span style="color:#111">;</span>
        <span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">initValue</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#f92672">~</span><span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#111">StringValue</span> <span style="color:#f92672">*</span><span style="color:#111">value</span><span style="color:#111">;</span>        <span style="color:#75715e">// value of this String
</span><span style="color:#75715e"></span><span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">StringValue</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">initValue</span><span style="color:#111">)</span>
<span style="color:#f92672">:</span> <span style="color:#111">refCount</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">data</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#00a8c8">char</span><span style="color:#111">[</span><span style="color:#111">strlen</span><span style="color:#111">(</span><span style="color:#111">initValue</span><span style="color:#111">)</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span><span style="color:#111">;</span>
    <span style="color:#111">strcpy</span><span style="color:#111">(</span><span style="color:#111">data</span><span style="color:#111">,</span> <span style="color:#111">initValue</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">StringValue</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">delete</span> <span style="color:#111">[</span><span style="color:#111">]</span> <span style="color:#111">data</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The primary purpose of <code>StringValue</code> is to provide a place to associate a particular value with a count of the number of <code>String</code> objects sharing that value, so there's need to define copy constructor or assignment operator for this inner struct, and we provide the manipulation of the <code>refCount</code> field in <code>String</code> class:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">String</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">String</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">initValue</span> <span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">&#34;</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">String</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">String</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#f92672">~</span><span style="color:#111">String</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">String</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">String</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">String</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">initValue</span><span style="color:#111">)</span>
<span style="color:#f92672">:</span> <span style="color:#111">value</span><span style="color:#111">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#111">initValue</span><span style="color:#111">)</span><span style="color:#111">)</span>
<span style="color:#111">{</span><span style="color:#111">}</span>

<span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">String</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">String</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span>
<span style="color:#f92672">:</span> <span style="color:#111">value</span><span style="color:#111">(</span><span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">value</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">refCount</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">String</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#f92672">-</span><span style="color:#f92672">-</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">refCount</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#00a8c8">delete</span> <span style="color:#111">value</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#111">String</span><span style="color:#f92672">&amp;</span> <span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">String</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">value</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">value</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">return</span> <span style="color:#f92672">*</span><span style="color:#00a8c8">this</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>

    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#f92672">-</span><span style="color:#f92672">-</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">refCount</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#75715e">// destroy *this&#39;s value
</span><span style="color:#75715e"></span>        <span style="color:#00a8c8">delete</span> <span style="color:#111">value</span><span style="color:#111">;</span>             <span style="color:#75715e">// if no one else is using it
</span><span style="color:#75715e"></span>    <span style="color:#111">}</span>

    <span style="color:#111">value</span> <span style="color:#f92672">=</span> <span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">value</span><span style="color:#111">;</span>
    <span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">refCount</span><span style="color:#111">;</span>

    <span style="color:#00a8c8">return</span> <span style="color:#f92672">*</span><span style="color:#00a8c8">this</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="copy-on-write">Copy-on-write</h1>
<p>Now comes the troublesome one: an array-bracket operator([]), which allows individual characters within strings to be read and written:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">String</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>  <span style="color:#75715e">// for const Strings
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">char</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// for non-const Strings
</span><span style="color:#75715e"></span>    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>It's straightforward to implement the const version, because it's a read-only operation:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span><span style="color:#f92672">&amp;</span> <span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#111">index</span><span style="color:#111">]</span><span style="color:#111">;</span> <span style="color:#75715e">// here&#39;s no sanity checking on index, just like C++ tradition; easy to add though
</span><span style="color:#75715e"></span><span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>However, since non-const version of <code>operator[]</code> might be called to write a character, the implementation must consider more scenario to avoid modifying the value of other <code>String</code> objects that happen to be sharing the same <code>StringValue</code> object - since there's no way for C++ compilers to tell us whether a particular use of <code>operator[]</code> is for a read or a write, we must be pessimistic and assume <em>all</em> calls to the non-const <code>operator[]</code> are for writes (Proxy classes casn help us differentiate reads from writes, see MECpp item 30.)</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">char</span><span style="color:#f92672">&amp;</span> <span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#75715e">// if sharing a value with other String obj.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// break off a separate copy of the value
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">refCount</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#f92672">-</span><span style="color:#f92672">-</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">refCount</span><span style="color:#111">;</span>
        <span style="color:#111">value</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">data</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#111">index</span><span style="color:#111">]</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This technique - to share a value with other objects until we have to write on our own copy of the value - is the well-knwon <em>copy-on-write</em>, which is a specific example of <em>lazy evaluation</em> (MECpp item 17), which is a more general approach to efficiency.</p>
<h1 id="pointers-references-and-copy-on-write">Pointers, References, and Copy-on-write</h1>
<p>Consider this code:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">String</span> <span style="color:#111">s1</span> <span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">Hello</span><span style="color:#d88200">&#34;</span><span style="color:#111">;</span>
<span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">p</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#111">s1</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span><span style="color:#111">;</span>
<span style="color:#111">Stirng</span> <span style="color:#111">s2</span> <span style="color:#f92672">=</span> <span style="color:#111">s1</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>The data structure looks like this:</p>
<pre><code>┌───┐    
│s1 ├──┐  ┌───┐    ┌───────┐
└───┘  ├─&gt;│ 2 ├───&gt;│ Hello │
┌───┐  │  └───┘    └───────┘
│s2 ├──┘              ↑
└───┘                 p
</code></pre><p>Now there is a dangerous situation, where pointer <code>p</code> modifies both <code>s1</code> and <code>s2</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#f92672">*</span><span style="color:#111">p</span> <span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">x</span><span style="color:#d88200">&#39;</span><span style="color:#111">;</span>  <span style="color:#75715e">// modifies both s1 and s2
</span></code></pre></td></tr></table>
</div>
</div><p>To eliminate the problem, we add a flag to each <code>StringValue</code> object indicating whether that object is shareable. Initially, the flag is set to <code>true</code> (indicating shareable), but turn it off whenever the non-const <code>operator[]</code> is invoked on the value represented by that object (once the flag is set to <code>false</code>, it stays that way forever).</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">String</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">struct</span> <span style="color:#75af00">StirngValue</span> <span style="color:#111">{</span>
        <span style="color:#111">size_t</span> <span style="color:#111">refCount</span><span style="color:#111">;</span>
        <span style="color:#00a8c8">bool</span> <span style="color:#111">shareable</span><span style="color:#111">;</span>  <span style="color:#75715e">// add this line
</span><span style="color:#75715e"></span>        <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">data</span><span style="color:#111">;</span>
        <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#111">}</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">StringValue</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">initValue</span><span style="color:#111">)</span>
<span style="color:#f92672">:</span> <span style="color:#111">refCount</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span><span style="color:#111">,</span>
  <span style="color:#111">shareable</span><span style="color:#111">(</span><span style="color:#111">true</span><span style="color:#111">)</span> <span style="color:#75715e">// add this line
</span><span style="color:#75715e"></span><span style="color:#111">{</span>
    <span style="color:#111">data</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#00a8c8">char</span><span style="color:#111">[</span><span style="color:#111">strlen</span><span style="color:#111">(</span><span style="color:#111">initValue</span><span style="color:#111">)</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#111">]</span><span style="color:#111">;</span>
    <span style="color:#111">strcpy</span><span style="color:#111">(</span><span style="color:#111">data</span><span style="color:#111">,</span> <span style="color:#111">initValue</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">String</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">String</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">shareable</span><span style="color:#111">)</span> <span style="color:#111">{</span>  <span style="color:#75715e">// add this checking
</span><span style="color:#75715e"></span>        <span style="color:#111">value</span> <span style="color:#f92672">=</span> <span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">value</span><span style="color:#111">;</span>
        <span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">refCount</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
        <span style="color:#111">value</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">data</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">char</span><span style="color:#f92672">&amp;</span> <span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">refCount</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#f92672">-</span><span style="color:#f92672">-</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">refCount</span><span style="color:#111">;</span>
        <span style="color:#111">value</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">data</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">shareable</span> <span style="color:#f92672">=</span> <span style="color:#111">false</span><span style="color:#111">;</span>  <span style="color:#75715e">// add this
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">return</span> <span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#111">index</span><span style="color:#111">]</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="a-reference-counting-base-class">A Reference-Counting Base class</h1>
<p>Reference counting is useful for more than just strings, so it's good practice to separate reference counting code in a context-independent manner. This leads us to the design of a base class <code>RCObject</code>. Any class wishing to take advantage of automatic reference counting may inherit from this class. Basically, for general purpose usage, <code>RCObject</code> class should include</p>
<ul>
<li>the reference count, as well as functions for incrementing and decrementing that count.</li>
<li>the code for destroying a value when it is no longer in use (count == 0)</li>
<li>a field that keeps track of whether this value is shareable, as well as functions to query this flag and set it to false</li>
</ul>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">RCObject</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">RCObject</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">RCObject</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">RCObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">RCObject</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">RCObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#f92672">~</span><span style="color:#111">RCObject</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75715e">// virtual shows this class is designed as a base class; pure virtual so that this class should be used only as a base class
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">void</span> <span style="color:#75af00">addReference</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">void</span> <span style="color:#75af00">removeReference</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    
    <span style="color:#00a8c8">void</span> <span style="color:#75af00">markUnshareable</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">bool</span> <span style="color:#75af00">isShareable</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">bool</span> <span style="color:#75af00">isShared</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>

<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">size_t</span> <span style="color:#111">refCount</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">bool</span> <span style="color:#111">shareable</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">RCObject</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">RCObject</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#f92672">:</span> <span style="color:#111">refCount</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">shareable</span><span style="color:#111">(</span><span style="color:#111">true</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#111">}</span>

<span style="color:#111">RCObject</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">RCObject</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">RCObject</span><span style="color:#f92672">&amp;</span><span style="color:#111">)</span>
<span style="color:#f92672">:</span> <span style="color:#111">refCount</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">shareable</span><span style="color:#111">(</span><span style="color:#111">true</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#111">}</span>

<span style="color:#111">RCObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">RCObject</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">RCObject</span><span style="color:#f92672">&amp;</span><span style="color:#111">)</span>
<span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#f92672">*</span><span style="color:#00a8c8">this</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#111">RCObject</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">RCObject</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#111">}</span> <span style="color:#75715e">// pure virtual dtor still need to be impl. see MECpp item 33
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">void</span> <span style="color:#111">RCObject</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">addReference</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">refCount</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#00a8c8">void</span> <span style="color:#111">RCObject</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">removeReference</span><span style="color:#111">(</span><span style="color:#111">)</span> 
<span style="color:#111">{</span> <span style="color:#00a8c8">if</span><span style="color:#111">(</span><span style="color:#f92672">-</span><span style="color:#f92672">-</span><span style="color:#111">refCount</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#00a8c8">delete</span> <span style="color:#00a8c8">this</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#00a8c8">void</span> <span style="color:#111">RCObject</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">markUnshareable</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span> <span style="color:#111">shareable</span> <span style="color:#f92672">=</span> <span style="color:#111">false</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#00a8c8">bool</span> <span style="color:#111">RCObject</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">isShareable</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span>
<span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#111">shareable</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#00a8c8">bool</span> <span style="color:#111">RCObject</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">isShared</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span>
<span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#111">refCount</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span> <span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>In this design, there are a few things worth noting:</p>
<ol>
<li>The <code>refCount</code> is set to 0 in both constructors to simplifies the set up process for the creaters of <code>RCObject</code>s when they set <code>refCount</code> to 1 themselves</li>
<li>Copy constructor sets <code>refCount</code> to 0, because this function is meant to create a new object representing a value, which is always unshared and referenced only by their creator (who will set up <code>refCount</code> properly later).</li>
<li>The assignment operator is unlikely to be called, since <code>RCObject</code> is a base class for a shared <em>value</em> object, which means in a reference counting system, it is usually the object pointing to these base-class objects that are assigned to one another, with only <code>refCount</code> being modified as a result. We don't declare assignment operator <code>private</code>, because there's a chance that someone does have a reason to allow assignment of reference-counted values(e.g., change the string value stored inside <code>StringValue</code> in the example above), so we adopt this &ldquo;do nothing&rdquo; implementation, which is exactly the right thing to do, because the assignment of value objects doesn't affect the reference count of objects pointing to either <code>lhs</code> or <code>rhs</code> of assignment operation: this base-class level assignment is meant to change <code>lhs</code>'s value, meaning all the objects pointing to <code>lhs</code> now pointing to a new value.</li>
<li>Here we use <code>delete this;</code> for <code>removeReference</code>, which is safe only if we know that <code>*this</code> is a heap object. In order to ensure this, we might need technichs discussed in MECpp item 27 to restrict <code>RCObject</code> to be created only on the heap<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>.</li>
</ol>
<p>Now taking advantage of this new reference-counting base class, we modify <code>StringValue</code> to inherit its reference counting capabilities from <code>RCObject</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">String</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">struct</span> <span style="color:#75af00">StringValue</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">RCObject</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">data</span><span style="color:#111">;</span>
        <span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">initValue</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#f92672">~</span><span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span><span style="color:#111">;</span>
<span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">StringValue</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">initValue</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">data</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#00a8c8">char</span><span style="color:#111">[</span><span style="color:#111">strlen</span><span style="color:#111">(</span><span style="color:#111">initValue</span><span style="color:#111">)</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#111">]</span><span style="color:#111">;</span>
    <span style="color:#111">strcpy</span><span style="color:#111">(</span><span style="color:#111">data</span><span style="color:#111">,</span> <span style="color:#111">initValue</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">StringValue</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">delete</span> <span style="color:#111">[</span><span style="color:#111">]</span> <span style="color:#111">data</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>After this change, <code>RCObject</code> now provide the manipulation ability of the <code>refCount</code> field, instead of <code>StringValue</code>.</p>
<h1 id="automating-reference-count-manipulations">Automating Reference Count Manipulations</h1>
<p>The <code>RCObject</code> class only gives us a place to store a reference count, as well as the member functions to manipulate the <code>refCount</code> field. However, the <em>calls</em> to these functions must still be mannually inserted in other classes: <code>String</code> copy constructor and assignment operator need to call <code>addReference</code> and <code>removeReference</code> on <code>StringValue</code> objects, which is not good practice for reuse.</p>
<p>To remove such manual works, we introduce <em>smart pointer</em> for help:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// template class for smart pointers-to-T object. T must
</span><span style="color:#75715e"></span><span style="color:#75715e">// support the RCObject interface, typically by inheriting from RCObject
</span><span style="color:#75715e"></span><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">RCPtr</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">RCPtr</span><span style="color:#111">(</span><span style="color:#111">T</span><span style="color:#f92672">*</span> <span style="color:#111">realPtr</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">RCPtr</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">RCPtr</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#f92672">~</span><span style="color:#111">RCPtr</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>

    <span style="color:#111">RCPtr</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">RCPtr</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>

    <span style="color:#111">T</span><span style="color:#f92672">*</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>
    <span style="color:#111">T</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">T</span> <span style="color:#f92672">*</span><span style="color:#111">pointee</span><span style="color:#111">;</span>  <span style="color:#75715e">// dumb pointer this object is emulating
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">void</span> <span style="color:#75af00">init</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// common init. code
</span><span style="color:#75715e"></span><span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">RCPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">RCPtr</span><span style="color:#111">(</span><span style="color:#111">T</span><span style="color:#f92672">*</span> <span style="color:#111">realPtr</span><span style="color:#111">)</span><span style="color:#f92672">:</span> <span style="color:#111">pointee</span><span style="color:#111">(</span><span style="color:#111">realPtr</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">init</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">RCPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">RCPtr</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">RCPtr</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#f92672">:</span> <span style="color:#111">pointee</span><span style="color:#111">(</span><span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">pointee</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">init</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">RCPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">init</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">pointee</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">return</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">pointee</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">isShareable</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#111">false</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#111">pointee</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">T</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">pointee</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#111">pointee</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">addReference</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// always add a new reference to the value
</span><span style="color:#75715e"></span><span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">RCPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&amp;</span> <span style="color:#111">RCPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">RCPtr</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">pointee</span> <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">pointee</span><span style="color:#111">)</span>
        <span style="color:#111">T</span> <span style="color:#f92672">*</span><span style="color:#111">oldPointee</span> <span style="color:#f92672">=</span> <span style="color:#111">pointee</span><span style="color:#111">;</span>
        <span style="color:#111">pointee</span> <span style="color:#f92672">=</span> <span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">pointee</span><span style="color:#111">;</span>
        <span style="color:#111">init</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// if possible, share it; else make own copy
</span><span style="color:#75715e"></span>        <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">oldPointee</span><span style="color:#111">)</span> <span style="color:#111">{</span>
            <span style="color:#111">oldPointee</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">removeReference</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#111">}</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">return</span> <span style="color:#f92672">*</span><span style="color:#00a8c8">this</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">RCPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">RCPtr</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">pointee</span><span style="color:#111">)</span> <span style="color:#111">pointee</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">removeReference</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">T</span><span style="color:#f92672">*</span> <span style="color:#111">RCPtr</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#111">pointee</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">T</span><span style="color:#f92672">&amp;</span> <span style="color:#111">RCPtr</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#f92672">*</span><span style="color:#111">pointee</span><span style="color:#111">;</span> <span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>There are three assumptions in this implementation:</p>
<ol>
<li><code>T</code> has a deep-copying constructor, because <code>pointee = new T(*pointee);</code> will call <code>T</code>'s copy constructor. In the example above, <code>String::StringValue</code> lack such a user-defined copy constructor, and compiler generated default copy constructor will not copy <code>char*</code> string <code>data</code> points to, so we need to add a customized version of copy constructor:</li>
</ol>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">StringValue</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">StirngValue</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">StringValue</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">data</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#00a8c8">char</span><span style="color:#111">(</span><span style="color:#111">strlen</span><span style="color:#111">(</span><span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">data</span><span style="color:#111">)</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">strcpy</span><span style="color:#111">(</span><span style="color:#111">data</span><span style="color:#111">,</span> <span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">data</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>For the same statement calling <code>T</code>'s copy constructor, we assume the type of <code>*pointee</code> is <code>T</code> rather than <code>T</code>'s derived class. If, however, chances are <code>poinee</code> might point to <code>T</code>'s derived class instances, we need to use a virtual copy constructor.</li>
<li><code>T</code> should prove all the functionality that <code>RCObject</code> does, either or not by inheriting from <code>RCObject</code>.</li>
</ol>
<h1 id="puting-everyting-together">Puting Everyting Together</h1>
<pre><code>                     ┌──────────┐  
┌──────────┐         │ RCObject │ 
│  String  │         │  class   │
│  object  │         └──────────┘
│          │              ↑ public inheritance
│ ┌─────┐  │         ┌───────────┐         ┌────────────┐
│ │RCPtr├──┼────────&gt;│StringValue├────────&gt;| Heap Memory|
│ └─────┘  │ pointer │  object   | pointer └────────────┘
└──────────┘         └───────────┘ 
</code></pre><p>The class declaration looks like this:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">RCPtr</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">RCPtr</span><span style="color:#111">(</span><span style="color:#111">T</span><span style="color:#f92672">*</span> <span style="color:#111">realPtr</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">RCPtr</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">RCPtr</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">RCPtr</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">RCPtr</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#f92672">~</span><span style="color:#111">RCPtr</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>

    <span style="color:#111">T</span><span style="color:#f92672">*</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>
    <span style="color:#111">T</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">T</span> <span style="color:#f92672">*</span><span style="color:#111">pointee</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">void</span> <span style="color:#75af00">init</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#00a8c8">class</span> <span style="color:#75af00">RCObject</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">RCObjet</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">RCObject</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">RCObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">RCObject</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">RCOBject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#f92672">~</span><span style="color:#111">RCObject</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>

    <span style="color:#00a8c8">void</span> <span style="color:#75af00">addReference</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">void</span> <span style="color:#75af00">removeReference</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>

    <span style="color:#00a8c8">void</span> <span style="color:#75af00">markUnshareable</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">bool</span> <span style="color:#75af00">isShareable</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">bool</span> <span style="color:#75af00">isShared</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">size_t</span> <span style="color:#111">refCount</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">bool</span> <span style="color:#111">shareable</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#00a8c8">class</span> <span style="color:#75af00">String</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">String</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">value</span> <span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">&#34;</span><span style="color:#111">)</span><span style="color:#111">;</span>

    <span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">char</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#75715e">// class representing string value
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">struct</span> <span style="color:#75af00">StringValue</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">RCObject</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">data</span><span style="color:#111">;</span>

        <span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">initValue</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">StringValue</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#00a8c8">void</span> <span style="color:#75af00">init</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">initValue</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#f92672">~</span><span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span><span style="color:#111">;</span>
    <span style="color:#111">RCPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">StringValue</span><span style="color:#f92672">&gt;</span> <span style="color:#111">value</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>It is worth to note that we don't need the copy constructor or assignment operator for <code>String</code> anymore: compiler-generated copy constructor for <code>Stirng</code> will automatically call the copy constructor for <code>Stirng</code>'s <code>RCPtr</code> member, and the copy constructor for <em>that</em> class will perform all the necessary manipulations of the <code>StringValue</code> object, including its reference count, and the same goes for assignment and destruction. That's why it is called <em>smart</em> pointer.</p>
<p>Now here is all the implementation:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">RCObject</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">RCObject</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#f92672">:</span> <span style="color:#111">refCount</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">shareable</span><span style="color:#111">(</span><span style="color:#111">true</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#111">}</span>

<span style="color:#111">RCObject</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">RCObject</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">RCObject</span><span style="color:#f92672">&amp;</span><span style="color:#111">)</span>
<span style="color:#f92672">:</span> <span style="color:#111">refCount</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">shareable</span><span style="color:#111">(</span><span style="color:#111">true</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#111">}</span>

<span style="color:#111">RCObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">RCObject</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">RCObject</span><span style="color:#f92672">&amp;</span><span style="color:#111">)</span>
<span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#f92672">*</span><span style="color:#00a8c8">this</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#111">RCObject</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">RCObject</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#111">}</span>

<span style="color:#00a8c8">void</span> <span style="color:#111">RCObject</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">addReference</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">refCount</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#00a8c8">void</span> <span style="color:#111">RCObject</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">removeReference</span><span style="color:#111">(</span><span style="color:#111">)</span> 
<span style="color:#111">{</span> <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#f92672">-</span><span style="color:#f92672">-</span><span style="color:#111">refCount</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#00a8c8">delete</span> <span style="color:#00a8c8">this</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#00a8c8">void</span> <span style="color:#111">RCObject</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">markUnshareable</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span> <span style="color:#111">shareable</span> <span style="color:#f92672">=</span> <span style="color:#111">false</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#00a8c8">bool</span> <span style="color:#111">RCObject</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">isShareable</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span>
<span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#111">shareable</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#00a8c8">bool</span> <span style="color:#111">RCObject</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">isShared</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span>
<span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#111">refCount</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span> <span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">RCPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">init</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">pointee</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">return</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">pointee</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">isShareable</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#111">false</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#111">pointee</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">T</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">pointee</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#111">pointee</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">addReference</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span> 
<span style="color:#111">}</span>
<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">RCPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">RCPtr</span><span style="color:#111">(</span><span style="color:#111">T</span><span style="color:#f92672">*</span> <span style="color:#111">realPtr</span><span style="color:#111">)</span><span style="color:#f92672">:</span> <span style="color:#111">pointee</span><span style="color:#111">(</span><span style="color:#111">realPtr</span><span style="color:#111">)</span>
<span style="color:#111">{</span> <span style="color:#111">init</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">RCPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">RCPtr</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">RCPtr</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#f92672">:</span> <span style="color:#111">pointee</span><span style="color:#111">(</span><span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">pointee</span><span style="color:#111">)</span>
<span style="color:#111">{</span> <span style="color:#111">init</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>


<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">RCPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&amp;</span> <span style="color:#111">RCPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">RCPtr</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">pointee</span> <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">pointee</span><span style="color:#111">)</span>
        <span style="color:#111">T</span> <span style="color:#f92672">*</span><span style="color:#111">oldPointee</span> <span style="color:#f92672">=</span> <span style="color:#111">pointee</span><span style="color:#111">;</span>
        <span style="color:#111">pointee</span> <span style="color:#f92672">=</span> <span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">pointee</span><span style="color:#111">;</span>
        <span style="color:#111">init</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// if possible, share it; else make own copy
</span><span style="color:#75715e"></span>        <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">oldPointee</span><span style="color:#111">)</span> <span style="color:#111">{</span>
            <span style="color:#111">oldPointee</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">removeReference</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#111">}</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">return</span> <span style="color:#f92672">*</span><span style="color:#00a8c8">this</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">RCPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">RCPtr</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span> <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">pointee</span><span style="color:#111">)</span> <span style="color:#111">pointee</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">removeReference</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">T</span><span style="color:#f92672">*</span> <span style="color:#111">RCPtr</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#111">pointee</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">T</span><span style="color:#f92672">&amp;</span> <span style="color:#111">RCPtr</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#f92672">*</span><span style="color:#111">pointee</span><span style="color:#111">;</span> <span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">StringValue</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">init</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">initValue</span><span style="color:#111">)</span> <span style="color:#75715e">// ctor and deep copy ctor share this same init function
</span><span style="color:#75715e"></span><span style="color:#111">{</span>
    <span style="color:#111">data</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#00a8c8">char</span><span style="color:#111">[</span><span style="color:#111">strlen</span><span style="color:#111">(</span><span style="color:#111">initValue</span><span style="color:#111">)</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#111">]</span><span style="color:#111">;</span>
    <span style="color:#111">strcpy</span><span style="color:#111">(</span><span style="color:#111">data</span><span style="color:#111">,</span> <span style="color:#111">initValue</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">StringValue</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">initValue</span><span style="color:#111">)</span>
<span style="color:#111">{</span> <span style="color:#111">init</span><span style="color:#111">(</span><span style="color:#111">initValue</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">StringValue</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">StringValue</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span>
<span style="color:#111">{</span> <span style="color:#111">init</span><span style="color:#111">(</span><span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">data</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">StringValue</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span> <span style="color:#00a8c8">delete</span> <span style="color:#111">[</span><span style="color:#111">]</span> <span style="color:#111">data</span><span style="color:#111">;</span> <span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">String</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">initValue</span><span style="color:#111">)</span>
<span style="color:#f92672">:</span> <span style="color:#111">value</span><span style="color:#111">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#111">initValue</span><span style="color:#111">)</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#111">}</span>

<span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span><span style="color:#f92672">&amp;</span> <span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span>
<span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#111">index</span><span style="color:#111">]</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#00a8c8">char</span><span style="color:#f92672">&amp;</span> <span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">isShared</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#111">value</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">StirngValue</span><span style="color:#111">(</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">data</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">markUnshareable</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#111">index</span><span style="color:#111">]</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="adding-refenrence-counting-to-existing-classes">Adding Refenrence Counting to Existing Classes</h1>
<p>Given some class <code>Widget</code> that's in a library we can't modify, and suppose we want to apply the benefits of reference counting to <code>Widget</code> without being able to inherit <code>Widget</code> from <code>RCObject</code>, we solve the problem with an additional level of indirection by adding a new class <code>CountHolder</code>, which does three jobs:</p>
<ol>
<li>Hold the reference</li>
<li>Inherit from <code>RCObject</code></li>
<li>Contain a pointer to a <code>Widget</code></li>
</ol>
<p>The only thing left to do is just an equivalent smart pointer as <code>RCPtr</code>, and we call it <code>RCIPtr</code>, where &ldquo;I&rdquo; stands for &ldquo;indirect&rdquo;. Thus, we get someting like this:</p>
<pre><code>                     ┌──────────┐  
┌──────────┐         │ RCObject │ 
│ RCWidget │         │  class   │
│  object  │         └──────────┘
│ ┌──────┐ │              ↑ public inheritance
│ |RCIPtr| │         ┌───────────┐         ┌─────────────┐
│ |Object├─┼────────&gt;│CountHolder├────────&gt;|Widget Object|
│ └──────┘ │ pointer │  object   | pointer └─────────────┘
└──────────┘         └───────────┘ 
</code></pre><p>Since here <code>CountHolder</code> is just an implementation detial of <code>RCIPtr</code>, we can simply nested it inside <code>RCIPtr</code>, just as how <code>StringValue</code> relates with <code>String</code>.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">RCIPtr</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">RCIPtr</span><span style="color:#111">(</span><span style="color:#111">T</span><span style="color:#f92672">*</span> <span style="color:#111">realPtr</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">RCIPtr</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">RCIPtr</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#f92672">~</span><span style="color:#111">RCIPtr</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>

    <span style="color:#111">RCIPtr</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">RCIPtr</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>

    <span style="color:#111">T</span><span style="color:#f92672">*</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>
    <span style="color:#111">T</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>

    <span style="color:#111">RCObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">getRCObject</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// give clients access
</span><span style="color:#75715e"></span>    <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#f92672">*</span><span style="color:#111">counter</span><span style="color:#111">;</span> <span style="color:#111">}</span>      <span style="color:#75715e">// isShared, etc.
</span><span style="color:#75715e"></span><span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">struct</span> <span style="color:#75af00">CountHolder</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">RCObject</span> <span style="color:#111">{</span>
        <span style="color:#f92672">~</span><span style="color:#111">CountHolder</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#00a8c8">delete</span> <span style="color:#111">pointee</span><span style="color:#111">;</span> <span style="color:#111">}</span>
        <span style="color:#111">T</span> <span style="color:#f92672">*</span><span style="color:#111">pointee</span><span style="color:#111">;</span>
    <span style="color:#111">}</span><span style="color:#111">;</span>
    <span style="color:#111">CountHolder</span> <span style="color:#f92672">*</span><span style="color:#111">counter</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">void</span> <span style="color:#75af00">init</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">RCIPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">init</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">counter</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">iShareable</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#111">false</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#111">T</span> <span style="color:#f92672">*</span><span style="color:#111">oldValue</span> <span style="color:#f92672">=</span> <span style="color:#111">counter</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">pointee</span><span style="color:#111">;</span>
        <span style="color:#111">counter</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">CountHolder</span><span style="color:#111">;</span>
        <span style="color:#111">counter</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">pointee</span> <span style="color:#f92672">=</span> <span style="color:#111">oldValue</span> <span style="color:#f92672">?</span> <span style="color:#00a8c8">new</span> <span style="color:#111">T</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">oldValue</span><span style="color:#111">)</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#111">counter</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">addReference</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">RCIPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">RCIPtr</span><span style="color:#111">(</span><span style="color:#111">T</span><span style="color:#f92672">*</span> <span style="color:#111">realPtr</span><span style="color:#111">)</span>
<span style="color:#f92672">:</span> <span style="color:#111">counter</span><span style="color:#111">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">CountHolder</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">counter</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">ponitee</span> <span style="color:#f92672">=</span> <span style="color:#111">realPtr</span><span style="color:#111">;</span>
    <span style="color:#111">init</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">RCIPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">RCIPtr</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">RCIPtr</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span>
<span style="color:#f92672">:</span> <span style="color:#111">counter</span><span style="color:#111">(</span><span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">counter</span><span style="color:#111">)</span>
<span style="color:#111">{</span> <span style="color:#111">init</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">RCIPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">RCIPtr</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span> <span style="color:#111">counter</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">removeReference</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">RCIPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&amp;</span> <span style="color:#111">RCIPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">RCIPtr</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">counter</span> <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">counter</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#111">counter</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">removeReference</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#111">counter</span> <span style="color:#f92672">=</span> <span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">counter</span><span style="color:#111">;</span>
        <span style="color:#111">init</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">return</span> <span style="color:#f92672">*</span><span style="color:#00a8c8">this</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">T</span><span style="color:#f92672">*</span> <span style="color:#111">RCIPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span>
<span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#111">counter</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">pointee</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">T</span><span style="color:#f92672">&amp;</span> <span style="color:#111">RCIPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span>
<span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#111">counter</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">pointee</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Then, for a library class <code>Widget</code> with following interface:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Widget</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">Widget</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">size</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">Widget</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Widget</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#f92672">~</span><span style="color:#111">Widget</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>

    <span style="color:#111">Widge</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Widget</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>

    <span style="color:#00a8c8">void</span> <span style="color:#75af00">doThis</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">int</span> <span style="color:#75af00">showThat</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>We can implementing wrapper <code>RCWidget</code> by simply forwarding the call through underlying <code>RCIPtr</code> to a <code>Widget</code>object:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">RCWidget</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">RCWidget</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">size</span><span style="color:#111">)</span><span style="color:#f92672">:</span> <span style="color:#111">value</span><span style="color:#111">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">Widget</span><span style="color:#111">(</span><span style="color:#111">size</span><span style="color:#111">)</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#111">}</span>

    <span style="color:#00a8c8">void</span> <span style="color:#75af00">doThis</span><span style="color:#111">(</span><span style="color:#111">)</span>
    <span style="color:#111">{</span>
        <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">value</span><span style="color:#111">.</span><span style="color:#111">getRCObject</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">.</span><span style="color:#111">isShared</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span> <span style="color:#111">{</span>
            <span style="color:#111">value</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">Widget</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">value</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#111">}</span>
        <span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">doThis</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">int</span> <span style="color:#75af00">showThat</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">showThat</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">RCIPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">Widget</span><span style="color:#f92672">&gt;</span> <span style="color:#111">value</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>As with <code>Stirng</code> class, there's no need to write copy constructor, assignment operator, or destructor, because the default versions do the right thing.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>In this example, we guarantee the value objects should be created only via <code>new</code> by declaring <code>StringValue</code> as <code>private</code> in <code>String</code>, so only <code>String</code> can create <code>StringValue</code> objects and the auther of the <code>String</code> class is able to ensure all such objects are allocated via <code>new</code>. <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
