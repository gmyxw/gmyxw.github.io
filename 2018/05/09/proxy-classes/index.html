<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>[MECpp]Item-30 Proxy Classes - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>[MECpp]Item-30 Proxy Classes</h1>
  </div>
<div class="meta">
  <div>2018-05-09 00:00</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>Objects that stand for other objects are often called <em>proxy objects</em> (or <em>surrogates</em>), and the classes that give rise to proxy objects are often called <em>proxy classes</em>, which is useful for implementing multidimensional arrays, differentiating lvalue/rvalue, and suppressing implicit conversions.</p>
<!-- toc -->
<h1 id="implementing-two-dimensional-arrays">Implementing Two-Dimensional Arrays</h1>
<p>Consider this statement:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">int</span> <span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#ae81ff">10</span><span style="color:#111">]</span><span style="color:#111">[</span><span style="color:#ae81ff">20</span><span style="color:#111">]</span><span style="color:#111">;</span>
<span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">cout</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#ae81ff">3</span><span style="color:#111">]</span><span style="color:#111">[</span><span style="color:#ae81ff">6</span><span style="color:#111">]</span><span style="color:#111">;</span> <span style="color:#75715e">// fine
</span></code></pre></td></tr></table>
</div>
</div><p>We want to create a general 2D array supporting operations such as <code>data[3][6]</code>. However, there's no such thing as a <code>operator[][]</code> in C++. The reason it is legal to write code above that appears to use <code>operator[][]</code> is because the variable <code>data</code> is not really a two-dimensinal array at all, but a 10-element one-dimensional array, each element of which is itself a 20-element array. So the expression <code>data[3][6]</code> really means <code>(data[3])[6]</code> - the seventh element of the array that is the fourth element of <code>data</code>.</p>
<p>Playing the same trick as above, we can define our <code>Array2D</code> class by overloading <code>operator[]</code> to return an object of a new class, <code>Array1D</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">Array2D</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">class</span> <span style="color:#75af00">Array1D</span> <span style="color:#111">{</span>
    <span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
        <span style="color:#111">T</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#00a8c8">const</span> <span style="color:#111">T</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>
    <span style="color:#111">}</span><span style="color:#111">;</span>

    <span style="color:#111">Array1D</span> <span style="color:#00a8c8">operator</span><span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">const</span> <span style="color:#111">Array1D</span> <span style="color:#00a8c8">operator</span><span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Then it is legal to write code like this:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">Array2D</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">float</span><span style="color:#f92672">&gt;</span> <span style="color:#111">data</span><span style="color:#111">(</span><span style="color:#ae81ff">10</span><span style="color:#111">,</span> <span style="color:#ae81ff">20</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">cout</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#ae81ff">3</span><span style="color:#111">]</span><span style="color:#111">[</span><span style="color:#ae81ff">6</span><span style="color:#111">]</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Conceptually intances of <code>Array1D</code> class (which is a <em>proxy class</em>) do not exist for clients of <code>Array2D</code>. Such clients program as if they were using real, live two-dimensional arrays.</p>
<h1 id="distinguishing-reads-from-writes-via-operator">Distinguishing Reads from Writes via operator[]</h1>
<p><code>operator[]</code> can be called in two different contexts:</p>
<ol>
<li><em>rvalue</em> usage for read</li>
<li><em>lvalue</em> usage for write</li>
</ol>
<p>In general, using an object as an lvalue means using it such that it might be modified, and using it as rvalue means using it such that it cannot be modified.</p>
<p>From MECpp item 29 reference counting, we can see reads can be much less expensive than writes - writes of reference-counted object may involve copying an entire data structure, while reads never require more than the simple returning of a value - so it will save a lot to differentiate lvalue usage from rvalue usage. However, it is impossible to tell whether <code>operator[]</code> is beeing invoked in an lvalue or an rvalue context from within <code>operator[]</code> - <code>operator[]</code> alone does not have the ability to determine the calling context.</p>
<p>The solution: we <em>delay</em> our lvalue-vs-rvalue actions until we see how the result of <code>operator[]</code> is used - by using proxy class to postpone our decision until <em>after</em> <code>operator[]</code> has returned (lazy evaluation, see MECpp item 7):</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">String</span> <span style="color:#111">{</span>   <span style="color:#75715e">// reference-counted strings
</span><span style="color:#75715e"></span><span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>

    <span style="color:#00a8c8">class</span> <span style="color:#75af00">CharProxy</span> <span style="color:#111">{</span>   <span style="color:#75715e">// proxy fro string chars
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
        <span style="color:#111">CharProxy</span><span style="color:#111">(</span><span style="color:#111">String</span><span style="color:#f92672">&amp;</span> <span style="color:#111">str</span><span style="color:#111">,</span> <span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// creation
</span><span style="color:#75715e"></span>        <span style="color:#111">CharProxy</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">CharProxy</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// lvalue uses
</span><span style="color:#75715e"></span>        <span style="color:#111">CharProxy</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">char</span> <span style="color:#111">c</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// lvalue uses
</span><span style="color:#75715e"></span>        <span style="color:#00a8c8">operator</span> <span style="color:#75af00">char</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span> <span style="color:#75715e">// rvalue uses
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
        <span style="color:#111">String</span><span style="color:#f92672">&amp;</span> <span style="color:#111">theString</span><span style="color:#111">;</span>  <span style="color:#75715e">// string this proxy pertains to        
</span><span style="color:#75715e"></span>        <span style="color:#00a8c8">int</span> <span style="color:#111">charIndex</span><span style="color:#111">;</span>  <span style="color:#75715e">// char within that string this proxy stands for
</span><span style="color:#75715e"></span>    <span style="color:#111">}</span><span style="color:#111">;</span>

    <span style="color:#00a8c8">const</span> <span style="color:#111">CharProxy</span> <span style="color:#00a8c8">operator</span><span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span> <span style="color:#75715e">// for const Strings
</span><span style="color:#75715e"></span>    <span style="color:#111">CharProxy</span> <span style="color:#00a8c8">operator</span><span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// for non-const Strings
</span><span style="color:#75715e"></span>    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#00a8c8">friend</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">CharProxy</span><span style="color:#111">;</span> <span style="color:#75715e">// CharProxy need access to private data member: value
</span><span style="color:#75715e"></span><span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">RCPtr</span><span style="color:#f92672">&lt;</span><span style="color:#111">StringValue</span><span style="color:#f92672">&gt;</span> <span style="color:#111">value</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Now let's see how it works. Given reference-counted stirngs using proxies above <code>String s1, s2;</code>,</p>
<h2 id="for-rvalue-usage">For rvalue usage</h2>
<p>Consider this statement <code>cout &lt;&lt; s1[5];</code>: <code>s1[5]</code> yields a <code>CharProxy</code> object, and compiler implicitly converts this <code>CharProxy</code> into <code>char</code> using the conversion operator declared in the <code>CharProxy</code> class. This is representitive of the <em>CharProxy-to-char</em> conversion that takes place for all <code>CharProxy</code> objects used as rvalues.</p>
<h2 id="for-lvalue-usage">For lvalue usage</h2>
<p>Lvalue usage is handled differently:</p>
<p>Say, for statement <code>s2[5] = 'x';</code>, the expression <code>s2[5]</code> yields a <code>CharProxy</code> object, which is the target of an assignment, so the assignment operator in the <code>CharProxy</code> class will be called - this is the crucial postponed step to differentiate writes from reads. Inside this <code>CharProxy</code> assignment operator, we know the string character for which the proxy stands is being used as an lvalue.</p>
<p>Similarly, the statement <code>s1[3] = s2[7];</code> calls the assignment operator for two <code>CharProxy</code> objects, and inside the operator, we know the object on the left is being used as an lvalue and the object on the right as an rvalue.</p>
<p>Now that we know exactly the context in which caller invokes the <code>operator[]</code>, it is easy to implement them:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">const</span> <span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">CharProxy</span> <span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span>
<span style="color:#111">{</span>
    <span style="color:#75715e">// return a const proxy
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Because CharProxy::operator= isn&#39;t a const member function,
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// the returned proxies can&#39;t be used as the target of assignment, and this behavior is exactly what we want for const version of operator[]
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">CharProxy</span><span style="color:#111">(</span><span style="color:#00a8c8">const_cast</span><span style="color:#f92672">&lt;</span><span style="color:#111">String</span><span style="color:#f92672">&amp;</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#00a8c8">this</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">index</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">CharProxy</span> <span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">return</span> <span style="color:#75af00">CharProxy</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#00a8c8">this</span><span style="color:#111">,</span> <span style="color:#111">index</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">CharProxy</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">CharProxy</span><span style="color:#111">(</span><span style="color:#111">String</span><span style="color:#f92672">&amp;</span> <span style="color:#111">str</span><span style="color:#111">,</span> <span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span>
<span style="color:#f92672">:</span> <span style="color:#111">theString</span><span style="color:#111">(</span><span style="color:#111">str</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">charIndex</span><span style="color:#111">(</span><span style="color:#111">index</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#111">}</span>

<span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">CharProxy</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span> <span style="color:#00a8c8">char</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">theString</span><span style="color:#111">.</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#111">charIndex</span><span style="color:#111">]</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">CharProxy</span><span style="color:#f92672">&amp;</span> <span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">CharProxy</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">CharProxy</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">theString</span><span style="color:#111">.</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">isShared</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span>
    <span style="color:#111">{</span>
        <span style="color:#111">theString</span><span style="color:#111">.</span><span style="color:#111">value</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#111">theString</span><span style="color:#111">.</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">data</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#111">theString</span><span style="color:#111">.</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#111">charIndex</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> 
        <span style="color:#111">rhs</span><span style="color:#111">.</span><span style="color:#111">theString</span><span style="color:#111">.</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#111">charIndex</span><span style="color:#111">]</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">return</span> <span style="color:#f92672">*</span><span style="color:#00a8c8">this</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">CharProxy</span><span style="color:#f92672">&amp;</span> <span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">CharProxy</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">char</span> <span style="color:#111">c</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">theString</span><span style="color:#111">.</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">isShared</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span>
    <span style="color:#111">{</span>
        <span style="color:#111">theString</span><span style="color:#111">.</span><span style="color:#111">value</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#111">theString</span><span style="color:#111">.</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">data</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#111">theString</span><span style="color:#111">.</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#111">charIndex</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">c</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">return</span> <span style="color:#f92672">*</span><span style="color:#00a8c8">this</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="preventing-implicit-conversions-in-single-argument-constructor">Preventing implicit conversions in single-argument constructor</h1>
<p>Refer to MECpp item 5.</p>
<h1 id="limitations">Limitations</h1>
<ol>
<li>
<p>Taking the address</p>
<p>In general, taking the address of a proxy yields a different type of pointer than does taking the address of a real object. Thus, the statement <code>char *p = &amp;s1[1];</code> will cause error. To eliminate the problem, we'll have to overload the address-of operators for <code>CharProxy</code> class:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">String</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#00a8c8">class</span> <span style="color:#75af00">CharProxy</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">&amp;</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">&amp;</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>
        <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#111">}</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span> <span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">CharProxy</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#f92672">&amp;</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#111">(</span><span style="color:#111">theString</span><span style="color:#111">.</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#111">charIndex</span><span style="color:#111">]</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
<span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span> <span style="color:#111">String</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">CharProxy</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#f92672">&amp;</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">theString</span><span style="color:#111">.</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">isShared</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span>
    <span style="color:#111">{</span>
        <span style="color:#111">theString</span><span style="color:#111">.</span><span style="color:#111">value</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">StringValue</span><span style="color:#111">(</span><span style="color:#111">theString</span><span style="color:#111">.</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">data</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#111">theString</span><span style="color:#111">.</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">markUnshareable</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span> 
    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#111">(</span><span style="color:#111">theString</span><span style="color:#111">.</span><span style="color:#111">value</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">data</span><span style="color:#111">[</span><span style="color:#111">charIndex</span><span style="color:#111">]</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Integrating with templates</p>
<p>If we have a template for reference-counted arrays that use proxy classes to distringuish lvalue and rvalue invocations of operator[]:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">Array</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">class</span> <span style="color:#75af00">Proxy</span> <span style="color:#111">{</span>
    <span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
        <span style="color:#111">Proxy</span><span style="color:#111">(</span><span style="color:#111">Array</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&amp;</span> <span style="color:#111">array</span><span style="color:#111">,</span> <span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#111">Proxy</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">T</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#00a8c8">operator</span> <span style="color:#75af00">T</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>
        <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#111">}</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">const</span> <span style="color:#111">Proxy</span> <span style="color:#00a8c8">operator</span><span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>
    <span style="color:#111">Proxy</span> <span style="color:#00a8c8">operator</span><span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Then for <code>Array&lt;int&gt; intArray;</code>, we can't make statement such as <code>intArray[5] += 5;</code> or <code>++intArray[5];</code>, since <code>operator+=</code> and <code>operator++</code> is not defined for proxy objects. To solve this problem, we have to define each of these functions for the <code>Array&lt;T&gt;::Proxy</code>, which, unfortunately, is a lot of work.</p>
<p>Similarly, we can't invoke member functions on real objects through  proxies. For an array taking <code>Rational</code> as elements (<code>Array&lt;Rational&gt; array;</code>), there is no way to invoke <code>Rational</code>'s member function like this:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">cout</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#111">array</span><span style="color:#111">[</span><span style="color:#ae81ff">4</span><span style="color:#111">]</span><span style="color:#111">.</span><span style="color:#111">numerator</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// error!
</span><span style="color:#75715e"></span><span style="color:#00a8c8">int</span> <span style="color:#111">denom</span> <span style="color:#f92672">=</span> <span style="color:#111">array</span><span style="color:#111">[</span><span style="color:#ae81ff">22</span><span style="color:#111">]</span><span style="color:#111">.</span><span style="color:#111">denominator</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// error!
</span></code></pre></td></tr></table>
</div>
</div><p>The solution is similar: we need to overload these functions so that they also apply to proxies.</p>
</li>
<li>
<p>Passed to functions taking references to non-const objects</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#75af00">swap</span><span style="color:#111">(</span><span style="color:#00a8c8">char</span><span style="color:#f92672">&amp;</span> <span style="color:#111">a</span><span style="color:#111">,</span> <span style="color:#00a8c8">char</span><span style="color:#f92672">&amp;</span> <span style="color:#111">b</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">String</span> <span style="color:#111">s</span> <span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">+C+</span><span style="color:#d88200">&#34;</span><span style="color:#111">;</span>
<span style="color:#111">swap</span><span style="color:#111">(</span><span style="color:#111">s</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span><span style="color:#111">,</span> <span style="color:#111">s</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// won&#39;t compile
</span></code></pre></td></tr></table>
</div>
</div><p>A <code>CharProxy</code> may be implicitly converted into a <code>char</code>, but there is no conversion function to a <code>char&amp;</code>. Further more, the <code>char</code> to which it may be converted can't be bound to swap's <code>char&amp;</code> parameters, because that <code>char</code> is a temporary object (<code>operator char</code> returns by value,) and, as MECpp item 19 explains, temporary objects are refused to be bound to non-const reference parameters.</p>
</li>
<li>
<p>Implicit type conversions</p>
<p>The process where a proxy object implicitly converted into the real object it stands for, a user-defined conversion function is invoked. As MECpp item 5 explains, only one user-defined conversion function is used by compiler when implicitly converting a parameter at a call site into the type needed by the corresponding function parameter.</p>
</li>
</ol></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
