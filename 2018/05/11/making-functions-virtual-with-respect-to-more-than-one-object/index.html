<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>[MECpp]Item-31 Making Functions Virtual With Respect to More Than One Object - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>[MECpp]Item-31 Making Functions Virtual With Respect to More Than One Object</h1>
  </div>
<div class="meta">
  <div>2018-05-11 00:00</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>A virtual function call is termed a &ldquo;message dispatch.&rdquo; A call that acts virtual on multiple parameters is called <em>multiple dispatch</em>, which is not directly supported in C++. Several resolutions exist, but none is without its disadvantages.</p>
<p>For example, considering we are writing a video game involving space ships, space stations, and asteroids:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">GameObject</span> <span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span><span style="color:#111">;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">SpaceShip</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">GameObject</span> <span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span><span style="color:#111">;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">SpaceStation</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">GameObject</span> <span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span><span style="color:#111">;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">Asteroid</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">GameObjecct</span> <span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>When one <code>GameObject</code> collides with another, we call a function depending on <em>both</em> their dynamic types:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#75af00">checkForCollision</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">object1</span><span style="color:#111">,</span> <span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">object2</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">theyJustCollided</span><span style="color:#111">(</span><span style="color:#111">object1</span><span style="color:#111">,</span> <span style="color:#111">object2</span><span style="color:#111">)</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#111">processCollision</span><span style="color:#111">(</span><span style="color:#111">object1</span><span style="color:#111">,</span> <span style="color:#111">object2</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
        <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#111">}</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Now comes the <em>double dispatch</em>: since collisions betwenn different <code>GameObject</code> effects the environment differently, we want <code>processCollision</code> to act virtual on both <code>object1</code> and <code>object2</code>, but C++ only offers virtual support for one parameter, like <code>object1.processCollision(object2)</code>. We must come up with some approaches ourselves instead of relyin on compilers.</p>
<h1 id="using-virtual-function-and-rtti">Using Virtual Function and RTTI</h1>
<p>We need double dispatch, so we can use virtual functions for first half of what we need, and use chains of <code>if-then-else</code>s for rest half:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">GameObject</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#111">collide</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">otherObject</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#00a8c8">class</span> <span style="color:#75af00">SpaceShip</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">GameObject</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#111">collide</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">otherObject</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// if colliding with an object of unknown type
</span><span style="color:#75715e"></span><span style="color:#75715e">// throw an exception of this type:
</span><span style="color:#75715e"></span><span style="color:#00a8c8">class</span> <span style="color:#75af00">CollisionWithUnknownObject</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">CollisionWithUnknownObject</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">whatWeHit</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#00a8c8">void</span> <span style="color:#111">SpaceShip</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">collide</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">otherObject</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">const</span> <span style="color:#111">type_info</span><span style="color:#f92672">&amp;</span> <span style="color:#111">objectType</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">typeid</span><span style="color:#111">(</span><span style="color:#111">otherObject</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">objectType</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#00a8c8">typeid</span><span style="color:#111">(</span><span style="color:#111">SpaceShip</span><span style="color:#111">)</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#111">SpaceShip</span><span style="color:#f92672">&amp;</span> <span style="color:#111">ss</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#111">SpaceShip</span><span style="color:#f92672">&amp;</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">otherObject</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#111">process</span> <span style="color:#111">a</span> <span style="color:#111">SpaceShip</span><span style="color:#f92672">-</span><span style="color:#111">SpaceShip</span> <span style="color:#111">collision</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">else</span> <span style="color:#75af00">if</span> <span style="color:#111">(</span><span style="color:#111">objectType</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#00a8c8">typeid</span><span style="color:#111">(</span><span style="color:#111">SpaceStation</span><span style="color:#111">)</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#111">SpaceStation</span><span style="color:#f92672">&amp;</span> <span style="color:#111">ss</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#111">SpaceStation</span><span style="color:#f92672">&amp;</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">otherObject</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#111">process</span> <span style="color:#111">a</span> <span style="color:#111">SpaceShip</span><span style="color:#f92672">-</span><span style="color:#111">SpaceStation</span> <span style="color:#111">collision</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">else</span> <span style="color:#75af00">if</span> <span style="color:#111">(</span><span style="color:#111">objectType</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#00a8c8">typeid</span><span style="color:#111">(</span><span style="color:#111">Asteroid</span><span style="color:#111">)</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#111">Asteroid</span><span style="color:#f92672">&amp;</span> <span style="color:#111">a</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#111">Asteroid</span><span style="color:#f92672">&amp;</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">otherObject</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#111">process</span> <span style="color:#111">a</span> <span style="color:#111">SpaceShip</span><span style="color:#f92672">-</span><span style="color:#111">Asteroid</span> <span style="color:#111">collision</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">throw</span> <span style="color:#75af00">CollisionWithUnknownObject</span><span style="color:#111">(</span><span style="color:#111">otherObject</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The danger in this design: each <code>collide</code> function must be aware of each of its sibling classes, so if a new type of object is added to the game, we must update each RTTI-based <code>if-then-else</code> chain in the proram that might encounter the new object, which in essence is unmaintainable in the long run. We added a final <code>else</code> clause where control winds up if we hit an unnknown object, throwing an exception to callers in the hope that they handle the error better than we can (but since we are running into something we didn't know existed, they almost can't do anything more satisfying.)</p>
<h1 id="using-virtual-functions-only">Using Virtual Functions Only</h1>
<p>We can also implement double-dispatching as two separate virtual function calls:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// forward declarations
</span><span style="color:#75715e"></span><span style="color:#00a8c8">class</span> <span style="color:#75af00">SpaceShip</span><span style="color:#111">;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">SpaceStation</span><span style="color:#111">;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">Asteroid</span><span style="color:#111">;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">GameObject</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#111">collide</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span>   <span style="color:#111">otherObject</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">collide</span><span style="color:#111">(</span><span style="color:#111">SpaceShip</span><span style="color:#f92672">&amp;</span>    <span style="color:#111">otherObject</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">collide</span><span style="color:#111">(</span><span style="color:#111">SpaceStation</span><span style="color:#f92672">&amp;</span> <span style="color:#111">otherObject</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">collide</span><span style="color:#111">(</span><span style="color:#111">Asteroid</span><span style="color:#f92672">&amp;</span>     <span style="color:#111">otherObject</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#00a8c8">class</span> <span style="color:#75af00">SpaceShip</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">GameObject</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#111">collide</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span>   <span style="color:#111">otherObject</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">collide</span><span style="color:#111">(</span><span style="color:#111">SpaceShip</span><span style="color:#f92672">&amp;</span>    <span style="color:#111">otherObject</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">collide</span><span style="color:#111">(</span><span style="color:#111">SpaceStation</span><span style="color:#f92672">&amp;</span> <span style="color:#111">otherObject</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">collide</span><span style="color:#111">(</span><span style="color:#111">Asteroid</span><span style="color:#f92672">&amp;</span>     <span style="color:#111">otherObject</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#111">SpaceShip</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">collide</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">otherObject</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">otherObject</span><span style="color:#111">.</span><span style="color:#111">collide</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#00a8c8">this</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Note that this implementation is not a resursive call: being inside a member function of the class <code>Spaceship</code>, the static type of <code>*this</code> is of type <code>SpaceShip</code>, so the call is routed to the <code>collide(SpaceShip&amp;)</code> instead of going back to <code>collide(GameObject&amp;)</code>. All the <code>collide</code> functions are virtual, so finally this call will resolve to the implementation of <code>collide</code> corresponding to the real type of <code>otherObject</code>, where both types are known. So the implementation is simply:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#111">SpaceShip</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">collide</span><span style="color:#111">(</span><span style="color:#111">SpaceShip</span><span style="color:#f92672">&amp;</span> <span style="color:#111">otherObject</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">process</span> <span style="color:#111">a</span> <span style="color:#111">SpaceShip</span><span style="color:#f92672">-</span><span style="color:#111">SpaceShip</span> <span style="color:#111">collision</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">void</span> <span style="color:#111">SpaceShip</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">collide</span><span style="color:#111">(</span><span style="color:#111">SpaceStation</span><span style="color:#f92672">&amp;</span> <span style="color:#111">otherObject</span><span style="color:#111">)</span> <span style="color:#111">{</span>
    <span style="color:#111">process</span> <span style="color:#111">a</span> <span style="color:#111">SpaceShip</span><span style="color:#f92672">-</span><span style="color:#111">SpaceStation</span> <span style="color:#111">collision</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">void</span> <span style="color:#111">Spaceship</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">collide</span><span style="color:#111">(</span><span style="color:#111">SpaceStation</span><span style="color:#f92672">&amp;</span> <span style="color:#111">otherObject</span><span style="color:#111">)</span> <span style="color:#111">{</span>
    <span style="color:#111">process</span> <span style="color:#111">a</span> <span style="color:#111">SpaceShip</span><span style="color:#f92672">-</span><span style="color:#111">Asteroid</span> <span style="color:#111">collision</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>There's no RTTI, no need to throw unexpected object types. Still, there's the same old flaw: each class must know about its siblings. Even worth, the <em>way</em> in which the code must be updated in the case of adding new classes is difficult to extend: if we add a new class, say <code>class Satellite: public GameObject</code>, to our game, we'd have to add a new <code>collide</code> function to each of the existing classes in the program, rather than just another <code>else</code> clause in one function before.</p>
<p>Now let's do a small sum-up:</p>
<ol>
<li>Virtual function approach is safer than the RTTI strategy, but it constrains the extensibility of the system to match that of our ability to edit header files</li>
<li>RTTI makes no recompilation demands, but it generally leads unmaintainable software.</li>
<li>The best recourse is to modify the design to eliminate the need for double-dispatching.</li>
</ol>
<h1 id="emulating-virtual-function-tables">Emulating Virtual Function Tables</h1>
<p>Actually, we can build our own virtual function tables, similar to how compilers implement virtual functions by creating an array of function pointers (the vtbl) and then indexing into that array when a virtual function is called, except that this customized version support double-dispatching. Moreover, the virtual function tables is more efficient than the RTTI-based code (indexing into an array and following a function pointer vs running through a series of <code>if-then-else</code> tests), and we isolate the use of RTTI to a single location where the array of function pointers is initialized.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">GameObject</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#111">collide</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">otherObject</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#00a8c8">class</span> <span style="color:#75af00">SpaceShip</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">GameObject</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#111">collide</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">otherObject</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">hitSpaceShip</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">spaceShip</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">hitSpaceStation</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">spaceStation</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">hitAsteroid</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">asteroid</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">typedef</span> <span style="color:#00a8c8">void</span> <span style="color:#111">(</span><span style="color:#111">SpaceShip</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">*</span><span style="color:#111">HitFunctionPtr</span><span style="color:#111">)</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">static</span> <span style="color:#111">HitFunctionPtr</span> <span style="color:#75af00">lookup</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">whatWeHit</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">typedef</span> <span style="color:#111">map</span><span style="color:#f92672">&lt;</span><span style="color:#111">string</span><span style="color:#111">,</span> <span style="color:#111">HitFunctionPtr</span><span style="color:#f92672">&gt;</span> <span style="color:#111">HitMap</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">static</span> <span style="color:#111">HitMap</span> <span style="color:#f92672">*</span> <span style="color:#75af00">initializeCollisionMap</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">SpaceShip</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">HitMap</span> <span style="color:#f92672">*</span> <span style="color:#111">SpaceShip</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">initializeCollisionMap</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">HitMap</span> <span style="color:#f92672">*</span><span style="color:#111">phm</span> <span style="color:#f92672">=</span> <span style="color:#111">newHitMap</span><span style="color:#111">;</span>
    <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">phm</span><span style="color:#111">)</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">SpaceShip</span><span style="color:#d88200">&#34;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#111">hitSpaceShip</span><span style="color:#111">;</span>
    <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">phm</span><span style="color:#111">)</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">SpaceStation</span><span style="color:#d88200">&#34;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#111">hitSpaceStation</span><span style="color:#111">;</span>
    <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">phm</span><span style="color:#111">)</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">Asteroid</span><span style="color:#d88200">&#34;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#111">hitAsteroid</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">phm</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#111">SpaceShip</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">HitFunctionPtr</span> <span style="color:#111">SpaceShip</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">lookup</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">whatWeHit</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">static</span> <span style="color:#111">auto_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">HitMap</span><span style="color:#f92672">&gt;</span> <span style="color:#111">collisionMap</span><span style="color:#111">(</span><span style="color:#111">initializeCollisionMap</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">HitMap</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">iterator</span> <span style="color:#111">mapEntry</span> <span style="color:#f92672">=</span> <span style="color:#111">collisionMap</span><span style="color:#111">.</span><span style="color:#111">find</span><span style="color:#111">(</span><span style="color:#00a8c8">typeid</span><span style="color:#111">(</span><span style="color:#111">whatWeHit</span><span style="color:#111">)</span><span style="color:#111">.</span><span style="color:#111">name</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">mapEntry</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#111">collisionMap</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">end</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span> <span style="color:#00a8c8">return</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">mapEntry</span><span style="color:#111">)</span><span style="color:#111">.</span><span style="color:#111">second</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">void</span> <span style="color:#111">SpaceShip</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">collide</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">otherObject</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">HitFunctionPtr</span> <span style="color:#111">hfp</span> <span style="color:#f92672">=</span> <span style="color:#111">lookup</span><span style="color:#111">(</span><span style="color:#111">otherObject</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">hfp</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#111">(</span><span style="color:#00a8c8">this</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">*</span><span style="color:#111">htp</span><span style="color:#111">)</span><span style="color:#111">(</span><span style="color:#111">otherObject</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">throw</span> <span style="color:#75af00">CollisionWithUnknownObject</span><span style="color:#111">(</span><span style="color:#111">otherObject</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
<span style="color:#111">}</span>

<span style="color:#75715e">// Each of the `dynamic_cast` will throw a `bad_cast` exception if the cast fails
</span><span style="color:#75715e"></span><span style="color:#75715e">// they should never fail, though.
</span><span style="color:#75715e"></span><span style="color:#00a8c8">void</span> <span style="color:#111">SpaceShip</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">hitSpaceShip</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">spaceShip</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">SpaceShip</span><span style="color:#f92672">&amp;</span> <span style="color:#111">otherShip</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">dynamic_cast</span><span style="color:#f92672">&lt;</span><span style="color:#111">SpaceShip</span><span style="color:#f92672">&amp;</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">spaceShip</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">process</span> <span style="color:#111">a</span> <span style="color:#111">SpaceShip</span><span style="color:#f92672">-</span><span style="color:#111">SpaceShip</span> <span style="color:#111">collision</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">void</span> <span style="color:#111">SpaceShip</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">hitSpaceStation</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">spaceStation</span><span style="color:#111">)</span> <span style="color:#111">{</span>
    <span style="color:#111">SpaceStation</span><span style="color:#f92672">&amp;</span> <span style="color:#111">Station</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">dynamic_cast</span><span style="color:#f92672">&lt;</span><span style="color:#111">SpaceStation</span><span style="color:#f92672">&amp;</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">spaceStation</span><span style="color:#111">)</span>
    <span style="color:#111">process</span> <span style="color:#111">a</span> <span style="color:#111">SpaceShip</span><span style="color:#f92672">-</span><span style="color:#111">SpaceStation</span> <span style="color:#111">collision</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">void</span> <span style="color:#111">Spaceship</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">hitAsteroid</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">asteroid</span><span style="color:#111">)</span> <span style="color:#111">{</span>
    <span style="color:#111">Asteroid</span><span style="color:#f92672">&amp;</span> <span style="color:#111">theAsteroid</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">dynamic_cast</span><span style="color:#f92672">&lt;</span><span style="color:#111">Asteroid</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">asteroid</span><span style="color:#111">)</span>
    <span style="color:#111">process</span> <span style="color:#111">a</span> <span style="color:#111">SpaceShip</span><span style="color:#f92672">-</span><span style="color:#111">Asteroid</span> <span style="color:#111">collision</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Note that there's another design which seems doable but is actually error-prone:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">SpaceShip</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">GameObject</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#111">collide</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">otherObject</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">hitSpaceShip</span><span style="color:#111">(</span><span style="color:#111">SpaceShip</span><span style="color:#f92672">&amp;</span> <span style="color:#111">otherObject</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">hitSpaceStation</span><span style="color:#111">(</span><span style="color:#111">SpaceStation</span><span style="color:#f92672">&amp;</span> <span style="color:#111">otherObject</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">hitAsteroid</span><span style="color:#111">(</span><span style="color:#111">Asteroid</span><span style="color:#f92672">&amp;</span> <span style="color:#111">otherObject</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#111">SpaceShip</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">HitMap</span> <span style="color:#f92672">*</span> <span style="color:#111">SpaceShip</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">initializeCollisionMap</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">HitMap</span> <span style="color:#f92672">*</span><span style="color:#111">phm</span> <span style="color:#f92672">=</span> <span style="color:#111">newHitMap</span><span style="color:#111">;</span>
    <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">phm</span><span style="color:#111">)</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">SpaceShip</span><span style="color:#d88200">&#34;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#111">HitFunctionPtr</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#111">hitSpaceShip</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">phm</span><span style="color:#111">)</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">SpaceStation</span><span style="color:#d88200">&#34;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#111">HitFunctionPtr</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#111">hitSpaceStation</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">phm</span><span style="color:#111">)</span><span style="color:#111">[</span><span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">Asteroid</span><span style="color:#d88200">&#34;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">reinterpret_cast</span><span style="color:#f92672">&lt;</span><span style="color:#111">HitFunctionPtr</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#111">hitAsteroid</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">phm</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Here we tell the compiler that <code>hitSpaceShip</code>, <code>hitSpaceStation</code>, and <code>hitAsteroid</code> are functions expecting a <code>GameObject</code> argument, which is not true. <code>hitSpaceShip</code> expects a <code>SpaceShip</code>, <code>hitSpaceStation</code> expects a <code>SpaceStation</code>, and <code>hitAsteroid</code> expects an <code>Asteroid</code>. All these functions are declared as pass-by-reference, which in fact is implemented by passing a pointer to an object, so ideally compilers will pass the declared type of the parameter(say <code>hitSpaceShip</code> for function <code>hitSpaceShip</code>) in the function being called. However, due to the object layout of classes under an inheritance path, after the cast above, it is possible that the wrong address (say <code>GameObject</code>) is passed into the function, because inside a <code>SpaceShip</code> object there are both a derived class part as well as a base class part, each having a different address (for detailed discussion, refer to <em>More Effective C++</em> Item 31-Initializing Emulated Virtual Function Talbes).</p>
<h2 id="using-non-member-collision-processing-functions">Using Non-Member Collision-Processing Functions</h2>
<p>Still, similar to pure virtual functions based approach, there is one remaining problem: because the associative array contains pointers to <em>member functions</em>, once a new type of <code>GameObject</code> is added to the game, every class definition needs to be updated and recompiled, even if that class does not care about the new type of object.</p>
<p>To solve this problem, we change the associative array so that it contains pointers to <em>non-member functions</em>. This update also helps us address a design question before: a collision between objects of types A and B should be handles by neither A nor B (depending on whichever is the left-hand argument to <code>processCollision</code>) but instead in some neutral location outside both classes.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;SpaceShip.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;SpaceStation.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;Asteroid.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">namespace</span> <span style="color:#111">{</span>  

<span style="color:#75715e">// primary collision-processing functions
</span><span style="color:#75715e"></span><span style="color:#00a8c8">void</span> <span style="color:#75af00">shipStation</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">spaceShip</span><span style="color:#111">,</span> <span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">spaceStation</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#00a8c8">void</span> <span style="color:#75af00">shipAsteroid</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">spaceShip</span><span style="color:#111">,</span> <span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">asteroid</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#00a8c8">void</span> <span style="color:#75af00">asteroidStation</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">asteroid</span><span style="color:#111">,</span> <span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">spaceStation</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#75715e">// secondary collision-processing functions that just implement symmetry
</span><span style="color:#75715e"></span><span style="color:#00a8c8">void</span> <span style="color:#75af00">stationShip</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">spaceStation</span><span style="color:#111">,</span> <span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">spaceShip</span><span style="color:#111">)</span>
<span style="color:#111">{</span> <span style="color:#111">shipStation</span><span style="color:#111">(</span><span style="color:#111">spaceShip</span><span style="color:#111">,</span> <span style="color:#111">spaceStation</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>
<span style="color:#00a8c8">void</span> <span style="color:#75af00">asteroidShip</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">asteroid</span><span style="color:#111">,</span> <span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">spaceShip</span><span style="color:#111">)</span>
<span style="color:#111">{</span> <span style="color:#111">shipAsteroid</span><span style="color:#111">(</span><span style="color:#111">spaceShip</span><span style="color:#111">,</span> <span style="color:#111">asteroid</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>
<span style="color:#00a8c8">void</span> <span style="color:#75af00">stationAsteroid</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">spaceStation</span><span style="color:#111">,</span> <span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">asteroid</span><span style="color:#111">)</span>
<span style="color:#111">{</span> <span style="color:#111">asteroidStation</span><span style="color:#111">(</span><span style="color:#111">asteroid</span><span style="color:#111">,</span> <span style="color:#111">spaceStation</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>

<span style="color:#00a8c8">typedef</span> <span style="color:#00a8c8">void</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">HitFunctionPtr</span><span style="color:#111">)</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span><span style="color:#111">,</span> <span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#00a8c8">typedef</span> <span style="color:#111">map</span><span style="color:#f92672">&lt;</span> <span style="color:#111">pair</span><span style="color:#f92672">&lt;</span><span style="color:#111">string</span><span style="color:#111">,</span> <span style="color:#111">string</span><span style="color:#f92672">&gt;</span><span style="color:#111">,</span> <span style="color:#111">HitFunctionPtr</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">HitMap</span><span style="color:#111">;</span>

<span style="color:#111">pair</span><span style="color:#f92672">&lt;</span><span style="color:#111">string</span><span style="color:#111">,</span> <span style="color:#111">string</span><span style="color:#f92672">&gt;</span> <span style="color:#111">makeStringPair</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">s1</span><span style="color:#111">,</span> <span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">s2</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">HitMap</span> <span style="color:#f92672">*</span> <span style="color:#75af00">initializeCollisionMap</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">class1</span><span style="color:#111">,</span> <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">class2</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">HitFunctionPtr</span> <span style="color:#75af00">lookup</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">class1</span><span style="color:#111">,</span> <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">class2</span><span style="color:#111">)</span><span style="color:#111">;</span>

<span style="color:#111">}</span> <span style="color:#75715e">// end of unnamed namespace
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">void</span> <span style="color:#75af00">processCollision</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">object1</span><span style="color:#111">,</span> <span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">object2</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">HitFunctionPtr</span> <span style="color:#111">phf</span> <span style="color:#f92672">=</span> <span style="color:#111">lookup</span><span style="color:#111">(</span><span style="color:#00a8c8">typeid</span><span style="color:#111">(</span><span style="color:#111">object1</span><span style="color:#111">)</span><span style="color:#111">.</span><span style="color:#111">name</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">,</span> 
                                <span style="color:#00a8c8">typeid</span><span style="color:#111">(</span><span style="color:#111">object2</span><span style="color:#111">)</span><span style="color:#111">.</span><span style="color:#111">name</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">phf</span><span style="color:#111">)</span> <span style="color:#111">phf</span><span style="color:#111">(</span><span style="color:#111">object1</span><span style="color:#111">,</span> <span style="color:#111">object2</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">throw</span> <span style="color:#111">UnknownCollision</span><span style="color:#111">(</span><span style="color:#111">object1</span><span style="color:#111">,</span> <span style="color:#111">object2</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">namespace</span> <span style="color:#111">{</span>

<span style="color:#111">pair</span><span style="color:#f92672">&lt;</span><span style="color:#111">string</span><span style="color:#111">,</span> <span style="color:#111">string</span><span style="color:#f92672">&gt;</span> <span style="color:#111">makeStringPair</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">s1</span><span style="color:#111">,</span> <span style="color:#00a8c8">const</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">s2</span><span style="color:#111">)</span>
<span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#111">pair</span><span style="color:#f92672">&lt;</span><span style="color:#111">stirng</span><span style="color:#111">,</span> <span style="color:#111">string</span><span style="color:#f92672">&gt;</span><span style="color:#111">(</span><span style="color:#111">s1</span><span style="color:#111">,</span> <span style="color:#111">s2</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#111">HitMap</span> <span style="color:#f92672">*</span> <span style="color:#75af00">initializeCollisionMap</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">HitMap</span> <span style="color:#f92672">*</span><span style="color:#111">phm</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">HitMap</span><span style="color:#111">;</span>
    <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">phm</span><span style="color:#111">)</span><span style="color:#111">[</span><span style="color:#111">makeStringPair</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">Spaceship</span><span style="color:#d88200">&#34;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">Asteroid</span><span style="color:#d88200">&#34;</span><span style="color:#111">)</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#111">shipAsteroid</span><span style="color:#111">;</span>
    <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">phm</span><span style="color:#111">)</span><span style="color:#111">[</span><span style="color:#111">makeStringPair</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">Spaceship</span><span style="color:#d88200">&#34;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">SpaceStation</span><span style="color:#d88200">&#34;</span><span style="color:#111">)</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#111">shipStation</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">phm</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#111">HitFunctionPtr</span> <span style="color:#75af00">lookup</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">class1</span><span style="color:#111">,</span> <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">class2</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">static</span> <span style="color:#111">auto_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">HitMap</span><span style="color:#f92672">&gt;</span> <span style="color:#111">collisionMap</span><span style="color:#111">(</span><span style="color:#111">initializeCollisionMap</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">HitMap</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">iterator</span> <span style="color:#111">mapEntry</span> <span style="color:#f92672">=</span> <span style="color:#111">collisionMap</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">find</span><span style="color:#111">(</span><span style="color:#111">make_pair</span><span style="color:#111">(</span><span style="color:#111">class1</span><span style="color:#111">,</span> <span style="color:#111">class2</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">mapEntry</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#111">collisionMap</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">end</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span> <span style="color:#00a8c8">return</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">mapEntry</span><span style="color:#111">)</span><span style="color:#111">.</span><span style="color:#111">second</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#111">}</span> <span style="color:#75715e">// end namespace
</span></code></pre></td></tr></table>
</div>
</div><p>Note that <code>makeStringPair</code>, <code>initializeColllisionMap</code>, and <code>lookup</code> were declared inside an unnamed namespace, therefore each must also be implemented within the same namespace.</p>
<p>Now we've solved the problem: if there are new classes to the hierarchy, it requires only the addition of more map insertions in <code>initializeCollisionMap</code> and the declarations of the new collision-processing functions in the unnamed namespace associated with the implementation of <code>processCollision</code>.</p>
<p>However, as uaual, there's still a disadvantage in this design: these non-member functions will not support inheritance-based parameter conversions such as how double-virtual-function-call mechanism does.</p>
<p>For example, suppose the concrete classes <code>CommercialShip</code> and <code>MilitaryShip</code> inherit from the newly abstract class <code>SpaceShip</code> (according to the guidance of MECpp item 33). If a <code>MilitaryShip</code> object and an <code>Asteroid</code> collided, we'd expect <code>void shipAsteroid(GameObject&amp;, GameObject&amp;)</code>  to be called. However, in fact, an <code>UnknownCollision</code> would be thrown, because <code>lookup</code> would be asked to find a function corresponding to the type names <code>MilitaryShip</code> and <code>Asteroid</code>, and no such function would be found in <code>collisionMap</code> - after all, <code>lookup</code> has no way of knowing that <code>MilitaryShip</code> can be treated like a <code>SpaceShip</code>.</p>
<h2 id="modifying-emulated-virtual-function-talbes-dynamically">Modifying Emulated Virtual Function Talbes Dynamically</h2>
<p>If we'd like to add, remove, or change collision-processing functions as the game proceeds, the static <code>collisionMap</code> will not meet this requirement. In this case, we can turn the concept of a static map into a class that offers member functions allowing us to modify the contents of the map dynamically:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">CollisionMap</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">typedef</span> <span style="color:#00a8c8">void</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">HitFunctionPtr</span><span style="color:#111">)</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span><span style="color:#111">,</span> <span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">void</span> <span style="color:#75af00">addEntry</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">type1</span><span style="color:#111">,</span>
                  <span style="color:#00a8c8">const</span> <span style="color:#111">String</span><span style="color:#f92672">&amp;</span> <span style="color:#111">type2</span><span style="color:#111">,</span>
                  <span style="color:#111">HitFunctionPtr</span> <span style="color:#111">collisionFunction</span><span style="color:#111">,</span>
                  <span style="color:#00a8c8">bool</span> <span style="color:#111">symmetric</span> <span style="color:#f92672">=</span> <span style="color:#111">true</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">void</span> <span style="color:#75af00">removeEntry</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">type1</span><span style="color:#111">,</span> <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">type2</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">HitFunctionPtr</span> <span style="color:#75af00">lookup</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">type1</span><span style="color:#111">,</span> <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">type2</span><span style="color:#111">)</span>
    <span style="color:#75715e">// return a reference to the one and only map
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">static</span> <span style="color:#111">CollisionMap</span><span style="color:#f92672">&amp;</span> <span style="color:#111">theCollisionMap</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#75715e">// private to prevent the creation of multiple maps
</span><span style="color:#75715e"></span>    <span style="color:#111">CollisionMap</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">CollisionMap</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">CollisionMap</span><span style="color:#f92672">&amp;</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Clients wishing to add an entry to the map simply do the following step:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#75af00">shipAsteroid</span><span style="color:#111">(</span><span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">spaceShip</span><span style="color:#111">,</span> <span style="color:#111">GameObject</span><span style="color:#f92672">&amp;</span> <span style="color:#111">asteroid</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">CollisionMap</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">theCollisionMap</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">.</span><span style="color:#111">addEntry</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">SpaceShip</span><span style="color:#d88200">&#34;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">Asteroid</span><span style="color:#d88200">&#34;</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#111">shipAsteroid</span><span style="color:#111">)</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>We must take care to ensure that these map entries are added to the map before any collisions occurs. One way is to have constructors in <code>GameObject</code> subclasses check to make sure the appropriate mappings had been added each time an object was created, but then we have to pay a small performance penalty at runtime. An alternative would be to create a <code>RegisterCollisionFunction</code> class:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">RegisterCollisionFunction</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">RegisterCollisionFunction</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">type1</span><span style="color:#111">,</span>
                              <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">type2</span><span style="color:#111">,</span>
                              <span style="color:#111">CollisionMap</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">HitFunctionPtr</span> <span style="color:#111">collisionFunction</span><span style="color:#111">,</span>
                              <span style="color:#00a8c8">bool</span> <span style="color:#111">symmetric</span> <span style="color:#f92672">=</span> <span style="color:#111">true</span><span style="color:#111">)</span>
    <span style="color:#111">{</span>
        <span style="color:#111">CollisionMap</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">theCollisionMap</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">.</span><span style="color:#111">addEntry</span><span style="color:#111">(</span><span style="color:#111">type1</span><span style="color:#111">,</span> <span style="color:#111">type2</span><span style="color:#111">,</span> <span style="color:#111">collisionFunction</span><span style="color:#111">,</span> <span style="color:#111">symmetric</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Clients then use global objects of this type to automatically register the functions before <code>main</code> is invoked to insure the map is initialized properly before any collision occurs:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">RegisterCollisionFunction</span> <span style="color:#75af00">cf1</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">SpaceShip</span><span style="color:#d88200">&#34;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">Asteroid</span><span style="color:#d88200">&#34;</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#111">shipAsteroid</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">RegisterCollisionFunction</span> <span style="color:#75af00">cf2</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">SpaceShip</span><span style="color:#d88200">&#34;</span><span style="color:#111">,</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#111">SpaceStation</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#111">shipStation</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>

<span style="color:#00a8c8">int</span> <span style="color:#111">main</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">argc</span><span style="color:#111">,</span> <span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span> <span style="color:#111">argv</span><span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>If, later, a new derived <code>class Satellite: public GameObject {...};</code> is added, and one or more new collision-processing functions are written (say, <code>void satelliteShip(GameObject&amp;, GameObject&amp;)</code>, and <code>void satelliteAsteroid(GameObject&amp;,GameObject&amp;)</code>, etc), we can simply add them to the map without disturbing existing code:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">RegisterCollisionFunction</span> <span style="color:#75af00">cf4</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">Satellite</span><span style="color:#d88200">&#34;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">SpaceShip</span><span style="color:#d88200">&#34;</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#111">satelliteShip</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">RegisterCollisionFunction</span> <span style="color:#75af00">cf5</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">Satellite</span><span style="color:#d88200">&#34;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">Asteroid</span><span style="color:#d88200">&#34;</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#111">satelliteAsteroid</span><span style="color:#111">)</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Overall, this makes it easy to provide data for a map-based implementation, but it doesn't change the fact that there's no perfect way to implement multiple dispatch.</p></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
