<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>Item-48 Be aware of template metaprogramming - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>Item-48 Be aware of template metaprogramming</h1>
  </div>
<div class="meta">
  <div>2018-03-15 23:00</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>Template metaprogramming can shift work from runtime to compile-time (thus enabling earlier error dettection and higher runtime performance), can be used to generate custom code based on combinations of policy choices, and can also be used to avoid generating code inappropriate for particular types.</p>
<!-- toc -->
<p>Template metaprogramming (TMP) is the process of writing template-based C++ programs that execute inside the C++ compiler, ending up with pieces of C++ source code instantiated from templates, which are then compiled as usual. TMP was discovered, not designed, in the early 1990s, and has later been shown to be Turing-complete, which means that it is powerful enough to compute anything (declare variables, perform loops, write and call functions, etc).</p>
<h1 id="strength-of-tmp">Strength of TMP</h1>
<p>TMP has two great strengths:</p>
<ol>
<li>it makes some things easy that would otherwise be hard or impossiblle</li>
<li>it shifts work from runtime to compile-time<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></li>
</ol>
<p>By making use of TMP, we can expect following good consequences:</p>
<ul>
<li>Some kinds of errors originally detected at runtime could be found during compilation</li>
<li>C++ progrmas become more efficient in about every way: smaller executables, shorter runtimes, lesser memory requirements</li>
</ul>
<p>To take a glimpse into how things work in TMP, let's look at two examples.</p>
<h2 id="examples">Examples</h2>
<ul>
<li>
<p><strong>Ex1: <code>if...else</code> conditionals in TMP</strong></p>
<p>As item 47 shows, <code>if...else</code> conditionals in TMP are expressed via templates and template specializations<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>. Let's take a comparason between the &ldquo;normal&rdquo; C++ (using <code>typeid</code>) and TMP (using traits) based on implementing the pseudo part of <code>if (iter is a random access iterator)</code> from STL's <code>advance</code></p>
<p>Below is the &ldquo;normal&rdquo; C++ approach, which evaluates at runtime:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">IterT</span><span style="color:#111">,</span> <span style="color:#00a8c8">typename</span> <span style="color:#111">DistT</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">advance</span><span style="color:#111">(</span><span style="color:#111">IterT</span><span style="color:#f92672">&amp;</span> <span style="color:#111">iter</span><span style="color:#111">,</span> <span style="color:#111">DistT</span> <span style="color:#111">d</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#00a8c8">typeid</span><span style="color:#111">(</span><span style="color:#00a8c8">typename</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">iterator_traits</span><span style="color:#f92672">&lt;</span><span style="color:#111">IterT</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">iterator_categoray</span><span style="color:#111">)</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> 
        <span style="color:#00a8c8">typeid</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">random_access_iterator_tag</span><span style="color:#111">)</span><span style="color:#111">)</span> <span style="color:#111">{</span>
            <span style="color:#111">iter</span> <span style="color:#f92672">+</span><span style="color:#f92672">=</span> <span style="color:#111">d</span><span style="color:#111">;</span> <span style="color:#75715e">// use iterator arithmetic for random access iters
</span><span style="color:#75715e"></span>    <span style="color:#111">}</span>
    <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">d</span> <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#00a8c8">while</span><span style="color:#111">(</span><span style="color:#111">d</span><span style="color:#f92672">-</span><span style="color:#f92672">-</span><span style="color:#111">)</span> <span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">iter</span><span style="color:#111">;</span> <span style="color:#111">}</span>
        <span style="color:#00a8c8">else</span> <span style="color:#111">{</span> <span style="color:#00a8c8">while</span><span style="color:#111">(</span><span style="color:#111">d</span><span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">)</span> <span style="color:#f92672">-</span><span style="color:#f92672">-</span><span style="color:#111">iter</span><span style="color:#111">;</span> <span style="color:#111">}</span>
    <span style="color:#111">}</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Compared to the one using traits, the <code>typeid</code>-based approach has following issues:</p>
<ol>
<li>less efficient: testing occurs at runtime; executable is larger (since the code to do the testing must be present in the executable)</li>
<li>introduce compilation problems: if <code>iter</code> isn't a random access iterator, <code>iter</code> will not support operator <code>+=</code>, so <code>iter += d</code> will not be valid, but compilers will still check this part of code and complain about its invalidation, because they are obliged to make sure that all source code is valid, even if it's not executed.</li>
</ol>
</li>
<li>
<p><strong>Ex2: loops in TMP</strong></p>
<p>TMP has no real looping construct, so the effect of loops is accomplished via recursion, or more specifically, recursive <em>template instantiations</em>. As an example, TMP factorial computation demonstates how it works:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">unsigned</span> <span style="color:#111">n</span><span style="color:#f92672">&gt;</span>  <span style="color:#75715e">// general case: the value of Factorial&lt;n&gt; is n times the value of Factorial&lt;n-1&gt;
</span><span style="color:#75715e"></span><span style="color:#00a8c8">struct</span> <span style="color:#75af00">Factorial</span> <span style="color:#111">{</span>
    <span style="color:#00a8c8">enum</span> <span style="color:#111">{</span> <span style="color:#111">value</span> <span style="color:#f92672">=</span> <span style="color:#111">n</span> <span style="color:#f92672">*</span> <span style="color:#111">Factorial</span><span style="color:#f92672">&lt;</span><span style="color:#111">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">value</span> <span style="color:#111">}</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">struct</span> <span style="color:#75af00">Factorial</span><span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> <span style="color:#111">{</span>
    <span style="color:#00a8c8">enum</span> <span style="color:#111">{</span> <span style="color:#111">value</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#111">}</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>The looping part of the code occurs where the template instantiation <code>Factorial&lt;n&gt;</code> references the tempalte instantiation <code>Factorial&lt;n-1&gt;</code>, until hitting the special case, <code>Factorial&lt;0&gt;</code>, that causes the recursion to terminate.</p>
<p>Each instantiation of the <code>Factorial</code> template is a struct, and each struct uses the enum hack (item 2) to declare a TMP variable named <code>value</code>, which holds the current value of the factorial computation. After recursive template instantiation, each instantiation gets its own copy of <code>value</code>.</p>
<p>To use <code>Factorial</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">int</span> <span style="color:#75af00">main</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">cout</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#111">Factorial</span><span style="color:#f92672">&lt;</span><span style="color:#ae81ff">5</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">value</span><span style="color:#111">;</span>  <span style="color:#75715e">// prints 120
</span><span style="color:#75715e"></span>    <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">cout</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#111">Factorial</span><span style="color:#f92672">&lt;</span><span style="color:#ae81ff">10</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">value</span><span style="color:#111">;</span> <span style="color:#75715e">// prints 3628800
</span><span style="color:#75715e"></span><span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>To sum up the technique keywords: templates and specializations and recursive instantiations and enum hacks.</p>
</li>
</ul>
<h1 id="what-can-be-accomplished-in-tmp">What can be accomplished in TMP</h1>
<h2 id="1-ensuring-dimensional-unit-correctness">1. Ensuring dimensional unit correctness</h2>
<p>In scientific and engineering applications, it's essential that dimensional units (e.g., mass, distance, time, etc.) be combined correctly. Using TMP, it's possible to ensure (during compilation) that all dimensional unit combinations in a program are correct, no matter how complex the calculations - good example for early error detection.</p>
<h2 id="2-optimizang-matrix-operations">2. Optimizang matrix operations</h2>
<p>Consider the following code,</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">typedef</span> <span style="color:#111">SqureMatrix</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">double</span><span style="color:#111">,</span> <span style="color:#ae81ff">10000</span><span style="color:#f92672">&gt;</span> <span style="color:#111">BigMatrix</span><span style="color:#111">;</span>
<span style="color:#111">BigMatrix</span> <span style="color:#111">m1</span><span style="color:#111">,</span> <span style="color:#111">m2</span><span style="color:#111">,</span> <span style="color:#111">m3</span><span style="color:#111">,</span> <span style="color:#111">m4</span><span style="color:#111">,</span> <span style="color:#111">m5</span><span style="color:#111">;</span>  <span style="color:#75715e">// create matrices
</span><span style="color:#75715e"></span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span> <span style="color:#75715e">// give them values
</span><span style="color:#75715e"></span><span style="color:#111">BigMatrix</span> <span style="color:#111">result</span> <span style="color:#f92672">=</span> <span style="color:#111">m1</span> <span style="color:#f92672">*</span> <span style="color:#111">m2</span> <span style="color:#f92672">*</span> <span style="color:#111">m3</span> <span style="color:#f92672">*</span> <span style="color:#111">m4</span> <span style="color:#f92672">*</span> <span style="color:#111">m5</span><span style="color:#111">;</span> <span style="color:#75715e">// compute the product
</span></code></pre></td></tr></table>
</div>
</div><p>Calculating <code>result</code> in the &ldquo;normal&rdquo; way calls for the creation of four temporary matrices, one for the reuslt of each call to <code>operator*</code>. Furthermore, the independent multiplications generate a sequence of four loops over the matrix elements.</p>
<p>Using an advanced template technology related to TMP called <em>expression templates</em>, it's possible to eliminate the temporaries and merge the loops, without changing the syntax of the client code above while enabling the program consume less memory and run dramatically fast.</p>
<h2 id="3-generating-custom-design-pattern-implementations">3. Generating custom design pattern implementations</h2>
<p>Design patterns like Strategy (item 35), Observer, Visitor, etc. can be implemented in many ways. Using a TMP-based technology called <code>policy-based design</code>, it's possible to create templates representing independent design choices (&ldquo;policies&rdquo;) that can be combined in arbitrary ways to yield pattern implementations with custom behavior.</p>
<p>Generalized beyond the domain of programming artifacts like design patterns, this technology is a basis for what's known as <em>generative programming</em>.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>Programs using TMP may take <em>much</em> longer to compile than their non-TMP counterparts. <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>Basic constructs, such as declaring variables, performing loops, and calling function, may look very different from their &ldquo;normal&rdquo; C++ counterparts, but that's assembly-level TMP - it's worth to know that libraries for TMP (e.g., Boost's MPL, item 55) offer a higher-level syntax. <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
