<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>Item-49 Understand the behavior of the new handler - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>Item-49 Understand the behavior of the new handler</h1>
  </div>
<div class="meta">
  <div>2018-03-16 19:52</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p><code>set-new-handler</code> allows you to specify a function to be called when memory allocation requests cannot be satisfied.</p>
<!-- toc -->
<h1 id="the-basic">The basic</h1>
<p>If <code>operator new</code> can't satisfy a memory allocation request, it will call a client-specifiable error-handling function called a <code>new-handler</code> before throwing a <code>bad_alloc</code> exception. To specify this out-of-memory-handling function, clients call <code>set_new_handler</code>, a standard library function declared in <code>&lt;new&gt;</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">namespace</span> <span style="color:#111">std</span> <span style="color:#111">{</span>
    <span style="color:#00a8c8">typedef</span> <span style="color:#75af00">void</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">new_handler</span><span style="color:#111">)</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">new_handler</span> <span style="color:#75af00">set_new_handler</span><span style="color:#111">(</span><span style="color:#111">new_handler</span> <span style="color:#111">p</span><span style="color:#111">)</span> <span style="color:#00a8c8">throw</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The <code>throw()</code> here is an exception specification, telling us that function <code>set_new_handler</code> won't throw any exceptions (though there's more truth, refer to item 29).</p>
<p><code>set_new_handler</code>'s parameter is the new <code>new_handler</code> we want to specify, which is a pointer to the function <code>operator new</code> should call if it fails to allocate the requested memory, and the return value if the previous <code>new_handler</code>. Once <code>operator new</code> fails to fulfill a memory request, it calls the <code>new_handler</code> function repeatedly until it <em>succeeds</em> to find enough memory (more details in item 51), so this default behavior gives us following conclusion - a well-designed new-handler function must do one of the following:</p>
<ul>
<li><strong>Make more memory available</strong> to allow the next memory allocation attempt inside <code>operator new</code> to succeed<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>.</li>
<li><strong>Install a different new-handler</strong> that may be capable to make more memory <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>. A variation is to modify the behavior of current <code>new-handler</code> (via modifying static, namespace specific, or global data the affects the new-handler's behavior)</li>
<li><strong>Deinstall the new-handler</strong>, i.e., pass the null pointer to <code>set_new_handler</code>, which leads to <code>operator new</code> throwing a <code>bad_alloc</code> exception.</li>
<li><strong>Throw an exception</strong> of type <code>bad_alloc</code> or some type derived from <code>bad_alloc</code>, which will firstly be caught by <code>operator new</code> and then propagate to the site originating the request for memory.</li>
<li><strong>Not return</strong>, typically by calling <code>abort</code> or <code>exit</code>.</li>
</ul>
<p>For example, to use <code>set-new-handler</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// new handler to install
</span><span style="color:#75715e"></span><span style="color:#00a8c8">void</span> <span style="color:#75af00">outOfMem</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">cerr</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">Unable to satisfy request for memory</span><span style="color:#8045ff">\n</span><span style="color:#d88200">&#34;</span><span style="color:#111">;</span>
    <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">about</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">int</span> <span style="color:#75af00">main</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">set_new_handler</span><span style="color:#111">(</span><span style="color:#111">outOfMem</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">int</span> <span style="color:#f92672">*</span><span style="color:#111">pBigDataArray</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#00a8c8">int</span><span style="color:#111">[</span><span style="color:#ae81ff">100000000L</span><span style="color:#111">]</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="customize-the-new-handler-per-class">Customize the <code>new-handler</code> per class</h1>
<p>C++ has no support for class-specific new-handlers, so we implement this by ourselves: we have each class provide its own versions of <code>set_new_handler</code> (which allows clients to specify the customized <code>new-handler</code>) and <code>operator new</code> (which ensures the class-specific <code>new-handler</code> is used in place of the global <code>new-handler</code> when memory allocation request fails).</p>
<p>To make thie ensurance confirmed, this class-specific <code>operator new</code> should do the following stuff:</p>
<ol>
<li>Call the standard <code>set_new_handler</code> to install <code>Widget</code>'s own error-handling function as the global new-handler.</li>
<li>Call the global <code>operator new</code> to perform the actual memory allocation. Two things may happen during this step:
<ul>
<li>if allocation ultimately fails and a <code>bad_alloc</code> is thrown by the global <code>operator new</code>, restore the original global new-handler, and then propagate the exception</li>
<li>if allocation succeeds, return a pointer to the allocated memory, and then restore the original global new-handler prior to the call to <code>Widget::operator new</code>.</li>
</ul>
</li>
</ol>
<p>To ensure that the original new-handler is always reinstalled, we can treat the global new-handler as a resource and follow the advice of item 13 to use resource-managing objects to prevent resource leaks:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">NewHandlerHolder</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">explicit</span> <span style="color:#111">NewHandlerHolder</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">new_handler</span> <span style="color:#111">nh</span><span style="color:#111">)</span> <span style="color:#75715e">// aquire the original new-handler
</span><span style="color:#75715e"></span>    <span style="color:#f92672">:</span><span style="color:#111">handler</span><span style="color:#111">(</span><span style="color:#111">nh</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#111">}</span>
    <span style="color:#f92672">~</span><span style="color:#111">NewHandlerHolder</span><span style="color:#111">(</span><span style="color:#111">)</span>
    <span style="color:#111">{</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">set_new_handler</span><span style="color:#111">(</span><span style="color:#111">handler</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>  <span style="color:#75715e">// release the original new-handler
</span><span style="color:#75715e"></span><span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">new_handler</span> <span style="color:#111">handler</span><span style="color:#111">;</span>  <span style="color:#75715e">// remember the original new-handler
</span><span style="color:#75715e"></span>    <span style="color:#111">NewHandlerHolder</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">NewHandlerHolder</span><span style="color:#f92672">&amp;</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// prevent copying see item 14
</span><span style="color:#75715e"></span>    <span style="color:#111">NewHandlerHolder</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">NewHandlerHolder</span><span style="color:#f92672">&amp;</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// prevent copying see item 14
</span><span style="color:#75715e"></span><span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Since the behavior of setting a class-specific new-handler is the same regardless of the class, we can reuse the setting procedure by creating a &ldquo;mixin-style&rdquo; base class (i.e., a base class that's designed to allow derived classes to inherit a single specific capability), so that each derived class not only inherits the <code>set_new_handler</code> and <code>operator new</code> functions from the base class, but also gets a different class-specific <code>new-handler</code> from the template.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>      <span style="color:#75715e">// &#34;mixin-style&#34; base class 
</span><span style="color:#75715e"></span><span style="color:#00a8c8">class</span> <span style="color:#75af00">NewHandlerSupport</span> <span style="color:#111">{</span> <span style="color:#75715e">// for class-specific set_new_handler support
</span><span style="color:#75715e"></span><span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">static</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">new_handler</span> <span style="color:#111">set_new_handler</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">new_handler</span> <span style="color:#111">p</span><span style="color:#111">)</span> <span style="color:#00a8c8">throw</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span><span style="color:#f92672">*</span> <span style="color:#00a8c8">operator</span> <span style="color:#75af00">new</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">size_t</span> <span style="color:#111">size</span><span style="color:#111">)</span> <span style="color:#00a8c8">throw</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">bad_alloc</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span> <span style="color:#75715e">// other versions of op. new - see item 52
</span><span style="color:#75715e"></span><span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">static</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">new_handler</span> <span style="color:#111">currentHandler</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">new_handler</span> <span style="color:#111">NewHandlerSupport</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">set_new_handler</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">new_handler</span> <span style="color:#111">p</span><span style="color:#111">)</span> <span style="color:#00a8c8">throw</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">new_handler</span> <span style="color:#111">oldHandler</span> <span style="color:#f92672">=</span> <span style="color:#111">currentHandler</span><span style="color:#111">;</span>
    <span style="color:#111">currentHandler</span> <span style="color:#f92672">=</span> <span style="color:#111">p</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">oldHandler</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span><span style="color:#f92672">*</span> <span style="color:#111">NewHandlerSupport</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span> <span style="color:#00a8c8">new</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">size_t</span> <span style="color:#111">size</span><span style="color:#111">)</span> <span style="color:#00a8c8">throw</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">bad_alloc</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">NewHandlerHolder</span> <span style="color:#75af00">h</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">set_new_handler</span><span style="color:#111">(</span><span style="color:#111">currentHandler</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// install new-handler
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span> <span style="color:#00a8c8">new</span><span style="color:#111">(</span><span style="color:#111">size</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// allocate memory or throw
</span><span style="color:#75715e"></span><span style="color:#111">}</span> <span style="color:#75715e">// restore global new-handler
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">new_handler</span> <span style="color:#111">NewHanderSupport</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">currentHandler</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75715e">// init.  currentHandler to null
</span></code></pre></td></tr></table>
</div>
</div><p>With this class template, adding <code>set_new_handler</code> support to <code>Widget</code> is easy: <code>Widget</code> just inherits from <code>NewHandlerSupport&lt;Widget&gt;</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Widget</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">NewHandlerSupport</span><span style="color:#f92672">&lt;</span><span style="color:#111">Widget</span><span style="color:#f92672">&gt;</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span> <span style="color:#75715e">// without declaration for set_new_handler or operator new
</span><span style="color:#75715e"></span><span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>One interesting point for this design is that  <code>Widget</code> inheriting from a templatized base class that takes <code>Widget</code> itself as a type parameter, and this technique has a straightforwart name: <em>curiously recurring template pattern (CRTP)</em>.</p>
<p>Another point worth noting is that the <code>NewHandlerSupport</code> template never uses its type parameter <code>T</code>, because it doesn't need to: all we need is a different copy of static data member <code>currentHJandler</code> for each class inheriting from <code>NewHandlerSupport</code>, and template parameter <code>T</code> just makes it possible to distinguish these derived classes - the template mechanism automatically generates a copy of <code>currentHandler</code> for each <code>T</code> with which <code>NewHandlerSupport</code> is instantiated.</p>
<p>Finally, let's take a look at how to use the new-handling capabilities in <code>Widget</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#75af00">outOfMem</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// decl. of class-specific new-handler func.
</span><span style="color:#75715e"></span><span style="color:#111">Widget</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">set_new_handler</span><span style="color:#111">(</span><span style="color:#111">outOfMem</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// set outOfMem as Widget&#39;s new-handler
</span><span style="color:#75715e"></span><span style="color:#111">Widget</span> <span style="color:#f92672">*</span><span style="color:#111">pw1</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">Widget</span><span style="color:#111">;</span> <span style="color:#75715e">// if mem. alloc. fails, call outOfMem
</span><span style="color:#75715e"></span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">string</span> <span style="color:#f92672">*</span><span style="color:#111">ps</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">string</span><span style="color:#111">;</span> <span style="color:#75715e">// if mem. alloc. fails, call the original global new-handler (if there is one)
</span><span style="color:#75715e"></span><span style="color:#111">Widget</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">set_new_handler</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// set the Widget-specific new-handler to nothing (null)
</span><span style="color:#75715e"></span><span style="color:#111">Widget</span> <span style="color:#f92672">*</span><span style="color:#111">pw2</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">Widget</span><span style="color:#111">;</span>  <span style="color:#75715e">// there&#39;s no new-handling func. for Widget now, so if mem. alloc. fails, throw an exception immediately
</span></code></pre></td></tr></table>
</div>
</div><h1 id="traditional-failure-yields-null-alternative-for-operator-new">Traditional failure-yields-null alternative for <code>operator new</code></h1>
<p>Althought now it is specified to throw a <code>bad_alloc</code> exception, until 1993, C++ required that <code>operator new</code> return null when it way unable to allocate the requested memory. Unwilling to abandon the traditional behavior, the C++ standardization committee provided an alternative form of <code>operator new</code> called &ldquo;nothrow&rdquo; forms, in part because the forms employ <code>nothrow</code> objects defined in the header <code>&lt;new&gt;</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Widget</span> <span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span><span style="color:#111">;</span>
<span style="color:#111">Widget</span> <span style="color:#f92672">*</span><span style="color:#111">pw1</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">Widget</span><span style="color:#111">;</span>  <span style="color:#75715e">// throws bad_alloc if allocation fails
</span><span style="color:#75715e"></span><span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">pw1</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span> <span style="color:#75715e">// this test must fail
</span><span style="color:#75715e"></span><span style="color:#111">Widget</span> <span style="color:#f92672">*</span><span style="color:#111">pw2</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">nothrow</span><span style="color:#111">)</span> <span style="color:#111">Widget</span><span style="color:#111">;</span> <span style="color:#75715e">// returns 0 if allocation fails
</span><span style="color:#75715e"></span><span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">pw2</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span> <span style="color:#75715e">// this test may succeed
</span></code></pre></td></tr></table>
</div>
</div><p>However, using <code>new (std::nothrow) Widget</code> only guarantees that <code>operator new</code> won't throw, not the whole expression: after the nothrow versoin of <code>operator new</code> succeeds to allocate enough memory for a <code>Widget</code> object, and then the <code>Widget</code> constructor is called, chances are that the <code>Widget</code> constructor might itself new up some memory and throw, and then the exception will be propagated as usual.</p>
<p>Conclusion: we never have a need for nothrow new.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>One way to achieve this strategy is to allocate a large block of memory at program start-up, then release it for use in the program the first time the new-handler is invoked. <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>The strategy may be implemented by calling <code>set_new_handler</code> inside current <code>new-handler</code>. The next time <code>operator new</code> call the <code>new-handler</code> function, it will get the one most recently installed. <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
