<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>Item-47 Use traits classes for information about types - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>Item-47 Use traits classes for information about types</h1>
  </div>
<div class="meta">
  <div>2018-03-14 18:49</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>Implemented by templates and template specializations, traits classes make information about types available during compilation. Combining traints with overloading, it is possible to perform compile-time <code>if...else</code> tests on types.</p>
<!-- toc -->
<p>In this item, let's look at how STL supports the utility template <code>advance</code>, which moves a specified iterator a specified distance:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">IterT</span><span style="color:#111">,</span> <span style="color:#00a8c8">typename</span> <span style="color:#111">DistT</span><span style="color:#f92672">&gt;</span>  
<span style="color:#00a8c8">void</span> <span style="color:#111">advance</span><span style="color:#111">(</span><span style="color:#111">IterT</span><span style="color:#f92672">&amp;</span> <span style="color:#111">iter</span><span style="color:#111">,</span> <span style="color:#111">DistT</span> <span style="color:#111">d</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// move iter d units forward; if d &lt; 0, move iter backward
</span></code></pre></td></tr></table>
</div>
</div><p>Before we step into the field of <code>advance</code> implementation, we should be familiar about STL iterator categoryies, because different iterators support different operations.</p>
<h1 id="five-iterator-categories">Five iterator categories</h1>
<p>According to the operations they support, there are five categories of iterators<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>:</p>
<ul>
<li><strong><em>Input iterators</em></strong> can move only one step forward at a time, can only read, and can read what they're pointing to only once (e.g., <code>istream_iterator</code>)</li>
<li><strong><em>Output iterators</em></strong> can move only one step forwrad at a time, can only write, and can write what they're pointing to only once (e.g., <code>ostream_iterator</code>)</li>
<li><strong><em>Forward iterators</em></strong> can do whatever input and output iterators can do, and they can read or write what they point to momre than once (e.g., singly linked list or iterators into TR1's hashed containers (item 54) may be in the forward category)</li>
<li><strong><em>Bidirectional iterators</em></strong> add to forward iterators the ability to move backward as well as forward (e.g., iterators for <code>list</code>, <code>set</code>, <code>multiset</code>, <code>map</code>, <code>multimap</code> in STL)</li>
<li><strong><em>Random access iterators</em></strong> are the most powerful ones: they add to bidirectional iterators the ability to perform &ldquo;iterator arithmetic&rdquo; - to jump forward or backward an arbitrary distance in constant time, which is similar to pointer arithmetic (e.g., iterators for <code>vector</code>, <code>deque</code>, <code>string</code>)</li>
</ul>
<p>For each of the five iterator categories, C++ has a &ldquo;tag struct&rdquo; in the standard library that serves to identify it:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">struct</span> <span style="color:#75af00">input_iterator_tag</span> <span style="color:#111">{</span><span style="color:#111">}</span><span style="color:#111">;</span>
<span style="color:#00a8c8">struct</span> <span style="color:#75af00">output_iterator_tag</span> <span style="color:#111">{</span><span style="color:#111">}</span><span style="color:#111">;</span>
<span style="color:#00a8c8">struct</span> <span style="color:#75af00">forward_iterator_tag</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">input_iterator_tag</span> <span style="color:#111">{</span><span style="color:#111">}</span><span style="color:#111">;</span>
<span style="color:#00a8c8">struct</span> <span style="color:#75af00">bidirectional_iterator_tag</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">forward_iterator_tag</span> <span style="color:#111">{</span><span style="color:#111">}</span><span style="color:#111">;</span>
<span style="color:#00a8c8">struct</span> <span style="color:#75af00">random_access_iterator_tag</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">bidirectional_iterator_tag</span> <span style="color:#111">{</span><span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="pseudocode-for-advance">Pseudocode for <code>advance</code></h1>
<p>Knowing that different categories support different operations, <code>advance</code> will essentially be implemented like this:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">IterT</span><span style="color:#111">,</span> <span style="color:#00a8c8">typename</span> <span style="color:#111">DistT</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">advance</span><span style="color:#111">(</span><span style="color:#111">IterT</span><span style="color:#f92672">&amp;</span> <span style="color:#111">iter</span><span style="color:#111">,</span> <span style="color:#111">DistT</span> <span style="color:#111">d</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">iter</span> <span style="color:#111">is</span> <span style="color:#111">a</span> <span style="color:#111">random</span> <span style="color:#111">access</span> <span style="color:#111">iterator</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#111">iter</span> <span style="color:#f92672">+</span><span style="color:#f92672">=</span> <span style="color:#111">d</span><span style="color:#111">;</span> <span style="color:#75715e">// use iterator arithmetic for random access iters
</span><span style="color:#75715e"></span>    <span style="color:#111">}</span>
    <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">d</span> <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#00a8c8">while</span> <span style="color:#111">(</span><span style="color:#111">d</span><span style="color:#f92672">-</span><span style="color:#f92672">-</span><span style="color:#111">)</span> <span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">iter</span><span style="color:#111">;</span> <span style="color:#111">}</span> <span style="color:#75715e">// use iterative calls 
</span><span style="color:#75715e"></span>        <span style="color:#00a8c8">else</span> <span style="color:#111">{</span> <span style="color:#00a8c8">while</span> <span style="color:#111">(</span><span style="color:#111">d</span><span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">)</span> <span style="color:#f92672">-</span><span style="color:#f92672">-</span><span style="color:#111">iter</span><span style="color:#111">;</span> <span style="color:#111">}</span>        <span style="color:#75715e">// to ++ or -- for other iterator categories
</span><span style="color:#75715e"></span>    <span style="color:#111">}</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>How to determine whether <code>iter</code> is a random access iterator? Here comes the technique of <em>traits</em>, which allow us to get type information during compilation.</p>
<h1 id="traits">Traits</h1>
<p>Traits aren't a keyword or a predefined construct in C++, but simply a technique and a convention followed by C++ programmers. It has some requirements, one of which asks that it has to work as well for built-in types as it does for user-defined types. This demand leads to the conclusion that the traits information for a type must be external to the type<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>.</p>
<h2 id="for-user-defined-types">For user-defined types</h2>
<p>The standard technique is to put the information into a template and one or more specializations of that template. For iterators, the template in the standard library is named <code>iterator_traits</code><sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// the iterator_category for type IterT is whatever IterT says it is
</span><span style="color:#75715e"></span><span style="color:#75715e">// see item 42 for info on the use of &#34;typedef typename&#34;
</span><span style="color:#75715e"></span><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">IterT</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">struct</span> <span style="color:#75af00">iterator_traits</span> <span style="color:#111">{</span>
    <span style="color:#00a8c8">typedef</span> <span style="color:#00a8c8">typename</span> <span style="color:#111">IterT</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">iterator_category</span> <span style="color:#111">iterator_category</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>How does <code>iterator_traits</code> work? Since <code>iterator_traits</code> just parrots back a typedef called <code>iterator_category</code> inside the iterator class, it requires that any user-defined iterator type must contain this nested typedef named <code>iterator_category</code>, which identifies the appropriate tag struct. For example, <code>deque</code> iterators belong to random access category, and <code>list</code>'s iterators are bidirectional:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">deque</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">class</span> <span style="color:#75af00">iterator</span> <span style="color:#111">{</span>
    <span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
        <span style="color:#00a8c8">typedef</span> <span style="color:#111">random_access_iterator_tag</span> <span style="color:#111">iterator_category</span><span style="color:#111">;</span>
        <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#111">}</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">list</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">class</span> <span style="color:#75af00">iterator</span> <span style="color:#111">{</span>
    <span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
        <span style="color:#00a8c8">typedef</span> <span style="color:#111">bidirectional_iterator_tag</span> <span style="color:#111">iterator_category</span><span style="color:#111">;</span>
        <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#111">}</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="for-pointer-types">For pointer types</h2>
<p>The code above works well for user-defined types, but it doasn't work for iterators that are pointers, since there's no such thing as a nested typedef inside a built-in pointer. To make it work, <code>iterator_traits</code> need to offer a <em>partial template specialization</em> for pointer types:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">IterT</span><span style="color:#f92672">&gt;</span>  <span style="color:#75715e">// partial template specialization
</span><span style="color:#75715e"></span><span style="color:#00a8c8">struct</span> <span style="color:#75af00">iterator_traits</span><span style="color:#f92672">&lt;</span><span style="color:#111">IterT</span><span style="color:#f92672">*</span><span style="color:#f92672">&gt;</span> <span style="color:#75715e">// for built-in pointer types
</span><span style="color:#75715e"></span><span style="color:#111">{</span>
    <span style="color:#00a8c8">typedef</span> <span style="color:#111">random_access_iterator_tag</span> <span style="color:#111">iterator_category</span><span style="color:#111">;</span> <span style="color:#75715e">// pointers act as random access iterators
</span><span style="color:#75715e"></span>    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="workflow-for-designing-and-implementing-a-traits-class">Workflow for designing and implementing a traits class</h2>
<ul>
<li>Identify some information about types we'd like to make available (e.g., iterator category for iterator types)</li>
<li>Choose a name to identify that information (e.g., <code>iterator_category</code>)</li>
<li>Provide a template and set of specializations (e.g., <code>iterator_traits</code>) that contain the information for the types we want to support</li>
</ul>
<h1 id="implementing-advance">Implementing <code>advance</code></h1>
<p>Given <code>std::iterator_traits</code>, we can refine our pseudocode for <code>advance</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">IterT</span><span style="color:#111">,</span> <span style="color:#00a8c8">typename</span> <span style="color:#111">DistT</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">advance</span><span style="color:#111">(</span><span style="color:#111">IterT</span><span style="color:#f92672">&amp;</span> <span style="color:#111">iter</span><span style="color:#111">,</span> <span style="color:#111">DistT</span> <span style="color:#111">d</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#00a8c8">typeid</span><span style="color:#111">(</span><span style="color:#00a8c8">typename</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">iterator_traits</span><span style="color:#f92672">&lt;</span><span style="color:#111">IterT</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">iterator_category</span><span style="color:#111">)</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span>
        <span style="color:#00a8c8">typeid</span><span style="color:#111">(</span><span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">random_access_iterator_tag</span><span style="color:#111">)</span><span style="color:#111">)</span>
        <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Sadly, this is not what we want: for one thing, it will lead to compilation problems (refer to item 48); anther issue, which is more fundamental, is that <code>if</code> statement is evaluated at runtime but <code>iterator_traits&lt;IterT&gt;::iterator_category</code> can be determined during compilation already. There's no point to move the evaluation from compile-time to runtime to waste time and bloat the executable.</p>
<h2 id="template-metaprogramming">Template metaprogramming</h2>
<p>What we want is a conditional construct for types that is evaluated during compilation. Actually this demand brings us to the realm of template metaprogramming (item 48), but the technique we'll use turns out to be quit familiar: <em>overloading</em>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">IterT</span><span style="color:#111">,</span> <span style="color:#00a8c8">typename</span> <span style="color:#111">DistT</span><span style="color:#f92672">&gt;</span> <span style="color:#75715e">// use this impl for random access iterators
</span><span style="color:#75715e"></span><span style="color:#00a8c8">void</span> <span style="color:#111">doAdvance</span><span style="color:#111">(</span><span style="color:#111">IterT</span><span style="color:#f92672">&amp;</span> <span style="color:#111">iter</span><span style="color:#111">,</span> <span style="color:#111">DistT</span> <span style="color:#111">d</span><span style="color:#111">,</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">random_access_iterator_tag</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">iter</span> <span style="color:#f92672">+</span><span style="color:#f92672">=</span> <span style="color:#111">d</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">IterT</span><span style="color:#111">,</span> <span style="color:#00a8c8">typename</span> <span style="color:#111">DistT</span><span style="color:#f92672">&gt;</span> <span style="color:#75715e">// use this impl for bidirectional iterators
</span><span style="color:#75715e"></span><span style="color:#00a8c8">void</span> <span style="color:#111">doAdvance</span><span style="color:#111">(</span><span style="color:#111">IterT</span><span style="color:#f92672">&amp;</span> <span style="color:#111">iter</span><span style="color:#111">,</span> <span style="color:#111">DistT</span> <span style="color:#111">d</span><span style="color:#111">,</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">bidirectional_iterator_tag</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">d</span> <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#00a8c8">while</span><span style="color:#111">(</span><span style="color:#111">d</span><span style="color:#f92672">-</span><span style="color:#f92672">-</span><span style="color:#111">)</span> <span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">iter</span><span style="color:#111">;</span> <span style="color:#111">}</span>
    <span style="color:#00a8c8">else</span> <span style="color:#111">{</span> <span style="color:#00a8c8">while</span><span style="color:#111">(</span><span style="color:#111">d</span><span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">)</span> <span style="color:#f92672">-</span><span style="color:#f92672">-</span><span style="color:#111">iter</span><span style="color:#111">;</span> <span style="color:#111">}</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">IterT</span><span style="color:#111">,</span> <span style="color:#00a8c8">typename</span> <span style="color:#111">DistT</span><span style="color:#f92672">&gt;</span> <span style="color:#75715e">// use this impl for input iterators, also applies to inherited forward_iterator_tag
</span><span style="color:#75715e"></span><span style="color:#00a8c8">void</span> <span style="color:#111">doAdvance</span><span style="color:#111">(</span><span style="color:#111">IterT</span><span style="color:#f92672">&amp;</span> <span style="color:#111">iter</span><span style="color:#111">,</span> <span style="color:#111">DistT</span> <span style="color:#111">d</span><span style="color:#111">,</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">input_iterator_tag</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">d</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">throw</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">out_of_range</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">Negative distance</span><span style="color:#d88200">&#34;</span><span style="color:#111">)</span><span style="color:#111">;</span> 
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">while</span><span style="color:#111">(</span><span style="color:#111">d</span><span style="color:#f92672">-</span><span style="color:#f92672">-</span><span style="color:#111">)</span> <span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">iter</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">typename</span> <span style="color:#111">IterT</span><span style="color:#111">,</span> <span style="color:#00a8c8">typename</span> <span style="color:#111">DistT</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">advance</span><span style="color:#111">(</span><span style="color:#111">IterT</span><span style="color:#f92672">&amp;</span> <span style="color:#111">iter</span><span style="color:#111">,</span> <span style="color:#111">DistT</span> <span style="color:#111">d</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">doAdvance</span><span style="color:#111">(</span><span style="color:#111">iter</span><span style="color:#111">,</span> <span style="color:#111">d</span><span style="color:#111">,</span> 
        <span style="color:#00a8c8">typename</span> <span style="color:#111">std</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">iterator_traits</span><span style="color:#f92672">&lt;</span><span style="color:#111">IterT</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">iterator_category</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<p>How to use a traits class:</p>
<ul>
<li>Create a set of overloaded &ldquo;worker&rdquo; functions or function templates (e.g., doAdvance) that differ in a traits parameter. Implement each function in accrod with the traits information passed.</li>
<li>Create a &ldquo;master&rdquo; function or function template (e.g., advance) that calls the workers, passing information provided by a traits class.</li>
</ul>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>Input and output iterators, as two least powerful iterator categories, are modeled on the read (into an input file) and write (into an output file) pointer, suitable only for one-pass algorithm. Forward (and higher level iterators) can do multi-pass algoritms. The most powerful random access iterators are modeled on built-in pointers. <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>For example, if <code>advance</code> is called with a pointer <code>const char*</code> and an <code>int</code>, since traits technique must apply to built-in types like <code>const char*</code>, and there's no way to nesting information inside pointers, thus the traits information for a type must be external to the type. <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p>By convention, traits are always implemented as structs, but that  structs are called &ldquo;traits classes&rdquo; - not joking. <a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
