<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>[MECpp]Item-14 Use Exception Specifications Judiciously - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>[MECpp]Item-14 Use Exception Specifications Judiciously</h1>
  </div>
<div class="meta">
  <div>2018-04-08 23:51</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>Exception specifications provide a documentation aid and an enforcement mechanism for constraints on exception usage, but they are only partly checked by compilers and they are easy to violate inadvertently.</p>
<!-- toc -->
<h1 id="the-good-points">The good points</h1>
<ul>
<li>
<p>Explicitly state what exception a function may throw</p>
</li>
<li>
<p>Compilers are sometimes able to detect inconsistent exception specfications during compilation</p>
</li>
<li>
<p>If the inconsistency is not found during compilation but detected at runtime, the special funciton <code>unexpected</code> is automatically invoked to constrain exception usage.</p>
<ul>
<li>There is a reason for compilers to <em>partially</em> check exception usage for consistency with exception: the language standard <em>prohibits</em> compilers from rejecting a call to a function that <em>might</em> violate the exception specification of the function making the call in order to integrate with older code lacking such specifications:</li>
</ul>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">extern</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">f1</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// might throw anything
</span><span style="color:#75715e"></span><span style="color:#00a8c8">void</span> <span style="color:#75af00">f2</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">throw</span> <span style="color:#111">(</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#111">f1</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// legal even if f1 might throw sth other than an int
</span><span style="color:#75715e"></span>    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h1 id="the-unwanted-points">The unwanted points</h1>
<ul>
<li>
<p>The default behavior for <code>unexpected</code> is to call <code>terminate</code>, which by default will call <code>abort</code>, preventing possible high-level exception handlers from dealing with unexpected exceptions.</p>
<p>Sometimes the default behavior of immediate program termination is not what we want. For example, like the example code below, when an unanticipated exception propagates from inside the <code>logDestruction</code> (which isn't supposed to happen due to the assertion <code>throw()</code> in exception specification after <code>logDestruction</code>, but it's possible due to a call to some other function that throws), by default, <code>unexpected</code> will be called, and that will result in termination of the program, without letting the high-level destructor to catch and deal with the exception.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Session</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#f92672">~</span><span style="color:#111">Session</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#111">logDestruction</span><span style="color:#111">(</span><span style="color:#111">Session</span> <span style="color:#f92672">*</span><span style="color:#111">objAddr</span><span style="color:#111">)</span> <span style="color:#00a8c8">throw</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#111">Session</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">Session</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">try</span> <span style="color:#111">{</span>
        <span style="color:#111">logDestruction</span><span style="color:#111">(</span><span style="color:#00a8c8">this</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">catch</span> <span style="color:#111">(</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#111">}</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h1 id="the-solution">The solution</h1>
<p>To avoid calls to <code>unexpected</code>:</p>
<ol>
<li>A good way to start is to avoid putting exception specifications on templates that take type argements, because there's no way to know anything about the exceptions thrown by a template's type parameters.</li>
<li>A second technique is to omit exception specifications on functions making calls to functions that themselves lack exception specifications.</li>
<li>A third technique is to handle exceptions &ldquo;the system&rdquo; may throw, such as <code>bad_alloc</code> thrown by <code>operator new</code> and <code>operator new[]</code> when a memory allocation fails (MECpp item 8).</li>
</ol>
<p>To cope with unexpected exceptions:</p>
<ul>
<li>
<p>Exploit the fact that C++ allows us to replace unexpected exceptions with exceptions of a different type (<code>UnexpectedException</code>), and add this type in the exception specification.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">UnexpectexException</span> <span style="color:#111">{</span><span style="color:#111">}</span><span style="color:#111">;</span>  <span style="color:#75715e">// all unexpected exception obj. will be replaces
</span><span style="color:#75715e"></span>                               <span style="color:#75715e">// by obj. of this type
</span><span style="color:#75715e"></span><span style="color:#00a8c8">void</span> <span style="color:#75af00">convertUnexpected</span><span style="color:#111">(</span><span style="color:#111">)</span>       <span style="color:#75715e">// function to call is an unexpected exception is thrown
</span><span style="color:#75715e"></span><span style="color:#111">{</span>
    <span style="color:#00a8c8">throw</span> <span style="color:#111">UnexpectedException</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#111">set_unexpected</span><span style="color:#111">(</span><span style="color:#111">convertUnexpected</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// replace the default `unexpected` function with `convertUnexpected`
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Another way is to translate unexpected exceptions into <code>bad_exception</code> by rethrowing the current exception in the customized <code>unexpected</code> function, and include <code>bad_exception</code> or its base class <code>exception</code> in the exception specifications.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#75af00">convertUnexpected</span><span style="color:#111">(</span><span style="color:#111">)</span>       <span style="color:#75715e">// function to call is an unexpected exception is thrown
</span><span style="color:#75715e"></span><span style="color:#111">{</span>
    <span style="color:#00a8c8">throw</span><span style="color:#111">;</span>  <span style="color:#75715e">// just rethrow the current exception
</span><span style="color:#75715e"></span><span style="color:#111">}</span>

<span style="color:#111">set_unexpected</span><span style="color:#111">(</span><span style="color:#111">convertUnexpected</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// install convertUnexpected as the unexpected replacement
</span></code></pre></td></tr></table>
</div>
</div></li>
</ul></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
