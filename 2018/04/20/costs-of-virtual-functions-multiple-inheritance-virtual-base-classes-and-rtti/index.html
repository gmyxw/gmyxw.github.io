<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>[MECpp]Item-24 Understand the Costs of Virtual Functions, Multiple Inheritance, Virtual Base Classes, and RTTI - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>[MECpp]Item-24 Understand the Costs of Virtual Functions, Multiple Inheritance, Virtual Base Classes, and RTTI</h1>
  </div>
<div class="meta">
  <div>2018-04-20 15:32</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>It's important to have a basic understanding of the cost of some C++ features that can have a noticeable impact on the size of objects and the speed at which member functions execute.</p>
<!-- toc -->
<h1 id="virtual-functions">Virtual Functions</h1>
<p>Virtual function feature in C++ gives us the ability to execute the code corresponding to the dynamic type of the object on which the virtual function is invoked. Most implementations use <em>virtual tables</em> (<em>vtbls</em>) and <em>virtual table pointers</em> (<em>vptrs</em>).</p>
<h2 id="cost-of-vtbl">Cost of vtbl</h2>
<p>A vtble is usually an array of pointers to functions. Each class that declares or inherits virtual functions has its own vtbl, which holds pointers to the implementations of the virtual functions for that class.</p>
<p>For example:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">C1</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">C1</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// nonvirtual func
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">virtual</span> <span style="color:#f92672">~</span><span style="color:#111">C1</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// virtual func
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">f1</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// virtual func
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">int</span> <span style="color:#75af00">f2</span><span style="color:#111">(</span><span style="color:#00a8c8">char</span> <span style="color:#111">c</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>  <span style="color:#75715e">// virtual func
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">f3</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">s</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// virtual func
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">void</span> <span style="color:#75af00">f4</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span> <span style="color:#75715e">// nonvirtual func
</span><span style="color:#75715e"></span>    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#00a8c8">class</span> <span style="color:#75af00">C2</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">C1</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">C2</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// nonvirtual func
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">virtual</span> <span style="color:#f92672">~</span><span style="color:#111">C2</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// virtual func
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">f1</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// redefined virtual func
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">f5</span><span style="color:#111">(</span><span style="color:#00a8c8">char</span> <span style="color:#f92672">*</span><span style="color:#111">str</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// new virtual func
</span><span style="color:#75715e"></span>    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>The vtbls for <code>C1</code> and <code>C2</code> looks like this:</p>
<pre><code>C1's vtbl:
┌──┐
│  │--&gt; impl. of C1::~C1
├──┤
│  │--&gt; impl. of C1::f1
├──┤
│  │--&gt; impl. of C1::f2
├──┤
│  │--&gt; impl. of C1::f3
└──┘
</code></pre><pre><code>C2's vtbl:
┌──┐
│  │--&gt; impl. of C2::~C2
├──┤
│  │--&gt; impl. of C2::f1
├──┤
│  │--&gt; impl. of C1::f2
├──┤
│  │--&gt; impl. of C1::f3
├──┤
│  │--&gt; impl. of C2::f5
└──┘
</code></pre><p>These tables come with cost: for each class containing virtual functions we have to set aside space ofr a virtual table, and the size of the vtbl is proportional to the number of virtual functions declared for that class.</p>
<p>Ideally, we need only one copy of a class's vtbl. Usually a class's vtbl is generated in the object file containing the definition (i.e., the body) of the first non-inline non-pure virtal function in that class <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>. However, if all virtual functions are declared <code>inline</code>, compilers tend to generate a copy of the class's vtbl in <em>every object file</em> that uses it, so we should avoid declaring virtual functions <code>inline</code>.</p>
<p>Speaking of <code>inline</code>, it is worth noting that for all practical purposes, virtual functions aren't inlined:</p>
<ul>
<li><code>inline</code> means replacing the call site with the body of the called function *<strong>during compilation</strong></li>
<li><code>virtual</code> means wait until <strong>runtime</strong> to see which function is called.</li>
<li>In practical real world situation, virtual function calls are made through <em>pointers</em> or <em>reference</em> to objects, which are not inlined; only the virtual functions invoked through <em>objects</em> can be inlined, which is usually pointless.</li>
</ul>
<h2 id="cost-of-vptr">Cost of vptr</h2>
<p>Each object whose class declares virtual functions will be added by compilers a hidden member that points to the virtual table for that class, so we'll pay for an extra pointer indise each object that is of a class containing virtual functions:</p>
<pre><code>  C1 object                                              C1 object 
┌──────────────┐                                     ┌──────────────┐
│ Data members │                                     │ Data members │
├──────────────┤     C1's vtbl                       ├──────────────┤
│     vptr     │-----&gt;┌──┐&lt;--------------------------│     vptr     │
└──────────────┘      │  │--&gt; impl. of C1::~C1       └──────────────┘
                      ├──┤
                      │  │--&gt; impl. of C1::f1
                      ├──┤
                      │  │--&gt; impl. of C1::f2
                      ├──┤
                      │  │--&gt; impl. of C1::f3
                      └──┘
</code></pre><p>Thus, for a call to the virtual function <code>f1</code> below:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#75af00">makeACall</span><span style="color:#111">(</span><span style="color:#111">C1</span> <span style="color:#f92672">*</span><span style="color:#111">pC1</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">pC1</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">f1</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>will be translated by compilers like this (given compilers know the hidden member <code>vptr</code> and the vtbl index of function <code>f1</code> is <code>i</code>):</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">pC1</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">vptr</span><span style="color:#111">[</span><span style="color:#111">i</span><span style="color:#111">]</span><span style="color:#111">)</span><span style="color:#111">(</span><span style="color:#111">pC1</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// call the function pointed to by the i-th entry in the vtbl
</span><span style="color:#75715e"></span>                       <span style="color:#75715e">// pointed to by pC1-&gt;vptr; pC1 is passed to the function as the &#34;this&#34; pointer
</span></code></pre></td></tr></table>
</div>
</div><p>On most machines this is almost as efficient as a non-virtual function call, with only a few more instructions, so the cost of calling a virtual function is basically the same as that of calling a function through a function pointer.</p>
<h2 id="summary">Summary</h2>
<p>Both the per-class and the per-object space overhead for virtual functions increases, and the runtime invocation cost grows slightly.</p>
<h1 id="multiple-inheritance">Multiple Inheritance</h1>
<p>The same effect applies to multiple inheritance, except that things get more complex:</p>
<ul>
<li>offset claculations to find vptrs within objects become more complicated</li>
<li>there are multiple vptrs within a single object (one per base class)</li>
<li>special vtbls must be generated for base classes in addition to the stand-alone vtbls</li>
</ul>
<h1 id="virtual-base-classes">Virtual Base Classes</h1>
<p>Multiple inheritance often leads to the need for virtual base classes to eliminate the duplicated copies of base class in each deriving path.</p>
<p>However, because implementations of virtual base classes often use pointers to virtual base class parts, one or more of these pointers may be stored inside the derived class objects. Take the following &ldquo;dreaded multiple inheritance diamond&rdquo; for example:</p>
<pre><code>          A
virtual ↗   ↖ virtual
      B       C
        ↖   ↗
          D
</code></pre><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">A</span> <span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span><span style="color:#111">;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">B</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">public</span> <span style="color:#111">A</span> <span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span><span style="color:#111">;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">C</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">public</span> <span style="color:#111">A</span> <span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span><span style="color:#111">;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">D</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">B</span><span style="color:#111">,</span> <span style="color:#00a8c8">public</span> <span style="color:#111">C</span> <span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>The layout for an object of type <code>D</code> is likely to look like this:</p>
<pre><code>    ┌───────────────────────────────┐
    │        B Data Members         │
    ├───────────────────────────────┤
    │ Pointer to virtual base class ├─┐
    ├───────────────────────────────┤ │
    │        C Data Members         │ │
    ├───────────────────────────────┤ │
  ┌─┤ Pointer to virtual base class │ │
  │ ├───────────────────────────────┤ │
  │ │        D Data Members         │ │
  │ ├───────────────────────────────┤ │
  └&gt;│        A Data Members         │&lt;┘
    └───────────────────────────────┘
</code></pre><p>Combining virtual base class with virtual table pointers introduced in &ldquo;Cost of vptr&rdquo; above, the memory layout for an object of type <code>D</code> could look like this:</p>
<pre><code>    ┌───────────────────────────────┐
    │        B Data Members         │
    ├───────────────────────────────┤
    │             _vptr_            │
    ├───────────────────────────────┤    
    │_Pointer to virtual base class_│
    ├───────────────────────────────┤
    │        C Data Members         │
    ├───────────────────────────────┤
    │             _vptr_            │    
    ├───────────────────────────────┤    
    │_Pointer to virtual base class_│
    ├───────────────────────────────┤
    │        D Data Members         │
    ├───────────────────────────────┤
    │        A Data Members         │
    ├───────────────────────────────┤    
    │             _vptr_            │
    └───────────────────────────────┘
</code></pre><p>Notice that in the above diagram there are only thre vptrs while four classes are involved, this is because  <code>D</code> can share the vptr with <code>B</code>. Most implementations take use of this to reduce the compiler-generated overhead.</p>
<h1 id="rtti">RTTI</h1>
<blockquote>
<p>RTTI (Runtime type identification) lets us discover information about objects and classes at runtime. The information is stored in an object of type <code>type_+info</code>, which can be accessed by using the <code>typeid</code> operator.</p>
</blockquote>
<p>For each class, there only needs to be a single copy of the RTTI, and the language specification states that an object's dynamic type information is guaranteed accurate only if that type has at least one virtual funciton. This may end up with such a design that RTTI was implemented in terms of a class's vtbl.</p>
<p>For example, index 0 of a vtbl array might contain a pointer to the <code>type_info</code> object for the class corresponding to that vtbl:</p>
<pre><code>C1's vtbl
┌──┐
│  │--&gt; C1's type_info object
├──┤
│  │--&gt; impl. of C1::~C1
├──┤
│  │--&gt; impl. of C1::f1
├──┤
│  │--&gt; impl. of C1::f2
├──┤
│  │--&gt; impl. of C1::f3
└──┘
</code></pre><p>With this implementation, the space cost of RTTI is an additional entry in each class vtbl plus the cost of the storage for the <code>type_info</code> object for each class, which is unlikely to be noticeable for most applications.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>For vendors who provide an integrated environment containing both compiler and linker, there is another brute-force starategy: generate a copy of the vtbl in each object file that might need it, and let linker strip out duplicate copies, leading to a single instance of each vtbl in the final executable or library. <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
