<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>[MECpp]Item-17 Consider Using Lazy Evaluation - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>[MECpp]Item-17 Consider Using Lazy Evaluation</h1>
  </div>
<div class="meta">
  <div>2018-04-11 14:02</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>The best computations are those we never perform at all.</p>
<!-- toc -->
<p>Lazy evaluation is applicable in an enormous variety of application areas.</p>
<h1 id="reference-counting">Reference Counting</h1>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">String</span> <span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#111">String</span> <span style="color:#111">s1</span> <span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">Hello</span><span style="color:#d88200">&#34;</span><span style="color:#111">;</span>

<span style="color:#111">String</span> <span style="color:#111">s2</span> <span style="color:#f92672">=</span> <span style="color:#111">s1</span><span style="color:#111">;</span>  <span style="color:#75715e">// call String copy ctor
</span></code></pre></td></tr></table>
</div>
</div><p>The lazy approach: instead of giving <code>s2</code> a copy of <code>s1</code>'s value, we have <code>s2</code> share <code>s1</code>'s value to save the cost of a call to <code>new</code> and the expense of copying anything, until any one is modified (i.e., <code>s2.convertToUpperCase();</code> will change only <code>s2</code>'s value by making a private copy of shared value before modification). Refer to MECpp item 29 for implementation details.</p>
<h1 id="distinguishing-reads-from-writes">Distinguishing Reads from Writes</h1>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">cout</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#111">s</span><span style="color:#111">[</span><span style="color:#ae81ff">2</span><span style="color:#111">]</span><span style="color:#111">;</span>  <span style="color:#75715e">// read
</span><span style="color:#75715e"></span><span style="color:#111">s</span><span style="color:#111">[</span><span style="color:#ae81ff">2</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#39;</span><span style="color:#d88200">x</span><span style="color:#d88200">&#39;</span><span style="color:#111">;</span>    <span style="color:#75715e">// write
</span></code></pre></td></tr></table>
</div>
</div><p>For <code>operator[]</code>, we'd like to distinguish the read call from the write so that a reference-counted string reading is cheap. In order to determine whether <code>operator[]</code> has been called in a read or in a write context, we use lazy evaluation and proxy classes as described in MECpp item 30.</p>
<h1 id="lazy-fetching">Lazy Fetching</h1>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">LargeObject</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">LargeObject</span><span style="color:#111">(</span><span style="color:#111">ObjectID</span> <span style="color:#111">id</span><span style="color:#111">)</span><span style="color:#111">;</span>

    <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">field1</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">int</span> <span style="color:#75af00">field2</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">double</span> <span style="color:#75af00">field3</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">field4</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">ObjectID</span> <span style="color:#111">oid</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">mutable</span> <span style="color:#111">string</span> <span style="color:#f92672">*</span><span style="color:#111">field1Value</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">mutable</span> <span style="color:#00a8c8">int</span> <span style="color:#f92672">*</span><span style="color:#111">field2Value</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">mutable</span> <span style="color:#00a8c8">double</span> <span style="color:#f92672">*</span><span style="color:#111">field3Value</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">mutable</span> <span style="color:#111">string</span> <span style="color:#f92672">*</span><span style="color:#111">field4Value</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>    
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#111">LargeObject</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">LargeObject</span><span style="color:#111">(</span><span style="color:#111">ObjectID</span> <span style="color:#111">id</span><span style="color:#111">)</span>
<span style="color:#f92672">:</span> <span style="color:#111">oid</span><span style="color:#111">(</span><span style="color:#111">id</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">field1Value</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">field2Value</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">field3Value</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">field4Value</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">{</span><span style="color:#111">}</span>

<span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">LargeObject</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">field1</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#00a8c8">const</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">field1Value</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#111">read</span> <span style="color:#111">the</span> <span style="color:#111">data</span> <span style="color:#00a8c8">for</span> <span style="color:#111">field</span> <span style="color:#ae81ff">1</span> <span style="color:#111">from</span> <span style="color:#111">the</span> <span style="color:#111">database</span>
        <span style="color:#111">and</span> <span style="color:#111">make</span> <span style="color:#111">field1Value</span> <span style="color:#111">point</span> <span style="color:#111">to</span> <span style="color:#111">it</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">return</span> <span style="color:#f92672">*</span><span style="color:#111">field1Value</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Because <code>LargeObject</code> instances are big, getting all the data at once is a costly database operation. The lazy approach to this problem is to create only a skeleton of an object, without reading any data from disk when a <code>LargeObject</code> instance is created. Each field in the object is represented as a pointer to the necessary data, initialized as null pointers, which signify fields that have not yet been read from the database.</p>
<p>Since null pointers may need to be initialized to point to real data from inside any member function, including <code>const</code> member functions like <code>field1</code>, we declare the pointer fields <code>mutable</code> to tell compilers that they can be modified inside any member function.</p>
<p>As an alternative, we can replace pointers with smart pointers (MECpp item 28), which does not need to be declared as <code>mutable</code>.</p>
<h1 id="lazy-expression-evaluation">Lazy Expression Evaluation</h1>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">Matrix</span> <span style="color:#111">{</span> <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span> <span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#111">Matrix</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">int</span><span style="color:#f92672">&gt;</span> <span style="color:#111">m1</span><span style="color:#111">(</span><span style="color:#ae81ff">1000</span><span style="color:#111">,</span> <span style="color:#ae81ff">1000</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// a 1000 by 1000 matrix
</span><span style="color:#75715e"></span><span style="color:#111">Matrix</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">int</span><span style="color:#f92672">&gt;</span> <span style="color:#111">m2</span><span style="color:#111">(</span><span style="color:#ae81ff">1000</span><span style="color:#111">,</span> <span style="color:#ae81ff">1000</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// a 1000 by 1000 matrix
</span><span style="color:#75715e"></span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">Matrix</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">int</span><span style="color:#f92672">&gt;</span> <span style="color:#111">m3</span> <span style="color:#f92672">=</span> <span style="color:#111">m1</span> <span style="color:#f92672">+</span> <span style="color:#111">m2</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Instead of compute and return the sum of <code>m1</code> and <code>m2</code> (which cost 1,000,000 additions and corresponding memory allocation), lazy evaluation sets up a data structure inside <code>m3</code> indicating that <code>m3</code>'s value is the sum of <code>m1</code> and <code>m2</code> (which may just consisting of two pointers to each of <code>m1</code> and <code>m2</code> and an enum indicating the additional operation). In most scenarios, we need only <em>part</em> of a computation (i.e., <code>cout &lt;&lt; m3[4];</code> instead of <code>cout &lt;&lt; m3;</code>), so laziness generally pays off.</p>
<p>However, due to these dependencies between values, there are extra maintainence to notice: when one of the matrices on which <code>m3</code> is dependent is to be modified, we have to make sure the correctness:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">m3</span> <span style="color:#f92672">=</span> <span style="color:#111">m1</span> <span style="color:#f92672">+</span> <span style="color:#111">m2</span><span style="color:#111">;</span>
<span style="color:#111">m1</span> <span style="color:#f92672">=</span> <span style="color:#111">m4</span><span style="color:#111">;</span> <span style="color:#75715e">// m3 is the sum of m2 and the old value of m1
</span></code></pre></td></tr></table>
</div>
</div><p>Inside the <code>Matrix&lt;int&gt;</code> assignment opertaor, we might compute <code>m3</code>'s value prior to changing <code>m1</code> or we may take a copy of the old value of <code>m1</code> and make <code>m3</code> dependent on that.</p>
<p>Those extra mentainence efforts often ends up saving significant amounts of time and space during program runs, which is a payoff that justifies the lazy evaluation.</p></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
