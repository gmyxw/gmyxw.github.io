<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>[MECpp]Item-11 Prevent Exceptions From Leaving Destructors - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>[MECpp]Item-11 Prevent Exceptions From Leaving Destructors</h1>
  </div>
<div class="meta">
  <div>2018-04-03 10:54</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>Keep exceptions from propagating out of destructors to prevent C++ calling <code>terminate</code> during the statck-unwinding part of exception propagation and ensure that every neccessary cleanup is accomplished.</p>
<p>Destructor is called in two situations:</p>
<ul>
<li>when an object is destroyed under &ldquo;normal&rdquo; conditions, e.g., when it goes out of scope, or is explicitly <code>delete</code>d.</li>
<li>when an object is destroyed by the exception-handling mechanism during the stackunwinding part of exception propagation.</li>
</ul>
<p>According to C++:</p>
<blockquote>
<p>When control leaves a destructor due to an exception while another exception is active, C++ calls the <code>termiante</code> function immediately, and any remaining local objects may not get a chance to be destroyed.</p>
</blockquote>
<p>For example, consider a <code>Session</code> class that will record object creations and destructions:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Session</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">Session</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#f92672">~</span><span style="color:#111">Session</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#111">logCreation</span><span style="color:#111">(</span><span style="color:#111">Session</span> <span style="color:#f92672">*</span><span style="color:#111">objAddr</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">logDestruction</span><span style="color:#111">(</span><span style="color:#111">Session</span> <span style="color:#f92672">*</span><span style="color:#111">objAddr</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#111">Session</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">Session</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">logDestruction</span><span style="color:#111">(</span><span style="color:#00a8c8">this</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Because there's no <code>try...catch</code> statement, any exception inside the destructor will be propagated to the caller of the destructor. Thus once <code>logDestructoin</code> throws an exception during a special case when the destructor itself is called due to some other exception, the <code>terminate</code> function would automatically be invoked. So we prefer this design:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">Session</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">Session</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">try</span> <span style="color:#111">{</span>
        <span style="color:#111">logDestruction</span><span style="color:#111">(</span><span style="color:#00a8c8">this</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">catch</span> <span style="color:#111">(</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#111">}</span>  <span style="color:#75715e">// do nothing!
</span><span style="color:#75715e"></span><span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The point here is that the <code>catch</code> block shouldn't hold any statement that has potential of throwing exception, and its only purpose here is to prevent exception thrown from <code>logDestruction</code> from propagating beyond <code>Session</code>'s destructor. Another good reason of catching the exception and prevent the propagation is to make sure the destructor will run to completion, so that any leftover cleanup code after the exception-thrown statement is able to run properly, without being interrupted by the excpetion propagation.</p></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
