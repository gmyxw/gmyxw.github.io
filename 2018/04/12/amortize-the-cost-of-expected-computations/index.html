<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>[MECpp]Item-18 Amortize the Cost of Expected Computations - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>[MECpp]Item-18 Amortize the Cost of Expected Computations</h1>
  </div>
<div class="meta">
  <div>2018-04-12 15:31</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>The old Computer Science story: trade space for time<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>.</p>
<!-- toc -->
<p>In order to improve program efficiency, we may use lazy evaluation (MECpp item 17), which is a technique for improving the efficiency of programs where results are not always needed. On the other side, when we must support operations whose results are almost always needed or whose results are often needed more than once, we may adopt &ldquo;over-eager evaluation to amortize the cost of anticipated computations, such as caching and prefetching.</p>
<h1 id="caching">Caching</h1>
<p>Say we're writing a program to provide information about employees, and one of the pieces of information we expect to request frequently is an employee's cubicle number, which is stored in a database, but the database is not optimized to find it. In this case, we could cache the cubicle numbers to save the subsequent database lookups.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">int</span> <span style="color:#75af00">findCubicleNumber</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">employeeName</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">typedef</span> <span style="color:#111">map</span><span style="color:#f92672">&lt;</span><span style="color:#111">string</span><span style="color:#111">,</span> <span style="color:#00a8c8">int</span><span style="color:#f92672">&gt;</span> <span style="color:#111">CubicleMap</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">static</span> <span style="color:#111">CubicleMap</span> <span style="color:#111">cubes</span><span style="color:#111">;</span>
    <span style="color:#111">CubicleMap</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">iterator</span> <span style="color:#111">it</span> <span style="color:#f92672">=</span> <span style="color:#111">cubes</span><span style="color:#111">.</span><span style="color:#111">find</span><span style="color:#111">(</span><span style="color:#111">employeeName</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">it</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#111">cubes</span><span style="color:#111">.</span><span style="color:#111">end</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">int</span> <span style="color:#111">cubicle</span> <span style="color:#f92672">=</span> <span style="color:#75715e">// db query for the cubicle number
</span><span style="color:#75715e"></span>        <span style="color:#111">cubes</span><span style="color:#111">[</span><span style="color:#111">employeeName</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">cubicle</span><span style="color:#111">;</span>
        <span style="color:#00a8c8">return</span> <span style="color:#111">cubicle</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">return</span> <span style="color:#111">it</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">second</span><span style="color:#111">;</span> <span style="color:#75715e">// or &#34;(*it).second&#34; if compiler does not support &#34;-&gt;&#34; for &#34;it&#34; object
</span><span style="color:#75715e"></span>    <span style="color:#111">}</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="prefetching">Prefetching</h1>
<p>According to the infamous <em>locality of reference</em> phenomenon, if data in one place is requested, it's quite common to want nearby data, too, which justifies disk caches, memory caches for both instructions and data, and instruction prefetches.</p>
<p>Adopting similar concept, we can use similar strategy when writing a template for dynamic arrays, which will automatically extend themselves:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">DynArray</span> <span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">T</span><span style="color:#f92672">&amp;</span> <span style="color:#111">DynArray</span><span style="color:#f92672">&lt;</span><span style="color:#111">T</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#00a8c8">operator</span><span style="color:#111">[</span><span style="color:#111">]</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">index</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">index</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">throw</span> <span style="color:#111">an</span> <span style="color:#111">exception</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">index</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">the</span> <span style="color:#111">current</span> <span style="color:#111">maximum</span> <span style="color:#111">index</span> <span style="color:#111">value</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">int</span> <span style="color:#111">diff</span> <span style="color:#f92672">=</span> <span style="color:#111">index</span> <span style="color:#f92672">-</span> <span style="color:#111">the</span> <span style="color:#111">current</span> <span style="color:#111">maximum</span> <span style="color:#111">index</span> <span style="color:#111">value</span><span style="color:#111">;</span>
        <span style="color:#111">call</span> <span style="color:#00a8c8">new</span> <span style="color:#111">to</span> <span style="color:#111">allocate</span> <span style="color:#111">enough</span> <span style="color:#111">additional</span> <span style="color:#111">memory</span> <span style="color:#111">so</span> <span style="color:#75af00">that</span> <span style="color:#111">(</span><span style="color:#111">index</span><span style="color:#f92672">+</span><span style="color:#111">diff</span><span style="color:#111">)</span> <span style="color:#111">is</span> <span style="color:#111">valid</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">the</span> <span style="color:#111">indexth</span> <span style="color:#111">element</span> <span style="color:#111">of</span> <span style="color:#111">the</span> <span style="color:#111">array</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This <code>operator[]</code> function allocates twice as much memory as needed each time the array must be extended, so that it saves one memory allocation when its logical size is extended twice in the following case:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">DynArray</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">double</span><span style="color:#f92672">&gt;</span> <span style="color:#111">a</span><span style="color:#111">;</span>  <span style="color:#75715e">// only a[0] is valid
</span><span style="color:#75715e"></span><span style="color:#111">a</span><span style="color:#111">[</span><span style="color:#ae81ff">22</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">3.5</span><span style="color:#111">;</span>         <span style="color:#75715e">// new is called to expand a&#39;s storage through index 44, 
</span><span style="color:#75715e"></span>                     <span style="color:#75715e">// a&#39;s logical size is 23
</span><span style="color:#75715e"></span><span style="color:#111">a</span><span style="color:#111">[</span><span style="color:#ae81ff">32</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>           <span style="color:#75715e">// a&#39;s logical size is now 33, without new being called
</span></code></pre></td></tr></table>
</div>
</div><section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>Not always. Using large objects means fewer fit on a virtual memory or cache page. In rare cases, making objects bigger <em>reduces</em> the performance of the software due to the increased paging activity and/or the decreased cache hit rate. <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
