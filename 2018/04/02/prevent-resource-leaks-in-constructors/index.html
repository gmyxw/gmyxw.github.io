<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>[MECpp]Item-10 Prevent Resource Leaks in Constructors - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>[MECpp]Item-10 Prevent Resource Leaks in Constructors</h1>
  </div>
<div class="meta">
  <div>2018-04-02 15:56</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>Replace pointer class members with their corresponding smart pointer objects to fortify the constructors against resource leaks in the presence of exceptions, to eliminate the need to manually deallocate resources in destructors, and to allow <code>const</code> member pointers to be handled in the smae graceful fashion as non-<code>const</code> pointers.</p>
<!-- toc -->
<h1 id="example">Example</h1>
<p>Suppose we want to develop a software for a multimedia address book that might hold information of a person's name, address, phone numbers, a picture of the person and, the sound of their voice:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Image</span> <span style="color:#111">{</span>  <span style="color:#75715e">// for holding image data
</span><span style="color:#75715e"></span><span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">Image</span> <span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">imageDataFileName</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#00a8c8">class</span> <span style="color:#75af00">AudioClip</span> <span style="color:#111">{</span>  <span style="color:#75715e">// for holding audio data
</span><span style="color:#75715e"></span><span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">AudioClip</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">sudioDataFileName</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#00a8c8">class</span> <span style="color:#75af00">PhoneNumber</span> <span style="color:#111">{</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">}</span><span style="color:#111">;</span> <span style="color:#75715e">// for holding phone numbers
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">BookEntry</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">BookEntry</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">name</span><span style="color:#111">,</span>  <span style="color:#75715e">// name data is mandatory for BookEntry, other fields are optional
</span><span style="color:#75715e"></span>              <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">address</span> <span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">&#34;</span><span style="color:#111">,</span>
              <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">imageFileName</span> <span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">&#34;</span><span style="color:#111">,</span>
              <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">audioClipFileName</span> <span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">&#34;</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#f92672">~</span><span style="color:#111">BookEntry</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">void</span> <span style="color:#75af00">addPhoneNumber</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">PhoneNumber</span><span style="color:#f92672">&amp;</span> <span style="color:#111">number</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// phone numbers are added via this function
</span><span style="color:#75715e"></span>    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">string</span> <span style="color:#111">theName</span><span style="color:#111">;</span>
    <span style="color:#111">string</span> <span style="color:#111">theAddress</span><span style="color:#111">;</span>
    <span style="color:#111">list</span><span style="color:#f92672">&lt;</span><span style="color:#111">PhoneNumber</span><span style="color:#f92672">&gt;</span> <span style="color:#111">thePhones</span><span style="color:#111">;</span>
    <span style="color:#111">Image</span> <span style="color:#f92672">*</span><span style="color:#111">theImage</span><span style="color:#111">;</span>
    <span style="color:#111">AudioClip</span> <span style="color:#f92672">*</span><span style="color:#111">theAudioClip</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="naive-implementation">Naive implementation</h1>
<p>A straightforward implementation for constructor and destructor:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">BookEntry</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">BookEntry</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">name</span><span style="color:#111">,</span>
                     <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">address</span><span style="color:#111">,</span>
                     <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">imageFileName</span><span style="color:#111">,</span>
                     <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">audioClipFileName</span><span style="color:#111">)</span>
<span style="color:#f92672">:</span> <span style="color:#111">theName</span><span style="color:#111">(</span><span style="color:#111">name</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">theAddress</span><span style="color:#111">(</span><span style="color:#111">address</span><span style="color:#111">)</span><span style="color:#111">,</span>
  <span style="color:#111">theImage</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">theAudioClip</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">imageFileName</span> <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">&#34;</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#111">theImage</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">Image</span><span style="color:#111">(</span><span style="color:#111">imageFileName</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">audioClipFileName</span> <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">&#34;</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#111">theAudioClip</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">AudioClip</span><span style="color:#111">(</span><span style="color:#111">audioClipFileName</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
<span style="color:#111">}</span>

<span style="color:#111">BookEntry</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">BookEntry</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">delete</span> <span style="color:#111">theImage</span><span style="color:#111">;</span>  <span style="color:#75715e">// C++ guarantees it&#39;s safe to delete null pointers
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">delete</span> <span style="color:#111">theAudoClip</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Everything looks good, however, there is potential resource leak under abnormal conditions: when an exception is thrown duringg exectuion of <code>theAudioClip = new AudioClip(audioClipFileName);</code>:</p>
<ul>
<li>An exception might arise because <code>operator new</code> (MECpp item 8) is unable to allocate enough memory for an <code>AudioClip</code> object, or coming from <code>AudioClip</code> constructor who throws an exception itself, ending up with a exception propagated to the site where the <code>BookEntry</code> object is being created</li>
<li>C++ destroys only <em>fully constructed</em> objects, and an object isn't fully constructed until its construtor has run to completion.</li>
<li>The exception propagated from <code>new AudioClip(audioClipFileName</code> interrupts the construction of the <code>BookEntry</code> object, so the <code>BookEntry</code>'s destructor will never be called, and nobody will delete the object that <code>theImage</code> already points to.</li>
</ul>
<p>Note that adding <code>try...catch</code> outside of the <code>BookEntry</code> constructor does not help:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#75af00">testBookEntryClass</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">BookEntry</span> <span style="color:#f92672">*</span><span style="color:#111">pb</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">try</span> <span style="color:#111">{</span>
        <span style="color:#111">pb</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">BookEntry</span><span style="color:#111">(</span><span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">Sherlock Holmes</span><span style="color:#d88200">&#34;</span><span style="color:#111">,</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">221B Baker Street</span><span style="color:#d88200">&#34;</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">catch</span> <span style="color:#111">(</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">)</span> <span style="color:#111">{</span>  <span style="color:#75715e">// catch all exceptions
</span><span style="color:#75715e"></span>        <span style="color:#00a8c8">delete</span> <span style="color:#111">pb</span><span style="color:#111">;</span> <span style="color:#75715e">// delete pb when an exception is thrown
</span><span style="color:#75715e"></span>        <span style="color:#00a8c8">throw</span><span style="color:#111">;</span>     <span style="color:#75715e">// propagate exception to caller
</span><span style="color:#75715e"></span>    <span style="color:#111">}</span>
    <span style="color:#00a8c8">delete</span> <span style="color:#111">pb</span><span style="color:#111">;</span>     <span style="color:#75715e">// delete pb normally
</span><span style="color:#75715e"></span><span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>If <code>BookEntry</code>'s constructor throws an exception, no assignment is made to <code>pb</code> and <code>pb</code> will be a null pointer, so deleting it in the <code>catch</code> block does nothing except make us feel better about ourselves.</p>
<h1 id="workable-but-inelegant-implementation">Workable (but inelegant) implementation</h1>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">BookEntry</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">BookEntry</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">name</span><span style="color:#111">,</span>
                     <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">address</span><span style="color:#111">,</span>
                     <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">imageFileName</span><span style="color:#111">,</span>
                     <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">audioClipFileName</span><span style="color:#111">)</span>
<span style="color:#f92672">:</span> <span style="color:#111">theName</span><span style="color:#111">(</span><span style="color:#111">name</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">theAddress</span><span style="color:#111">(</span><span style="color:#111">address</span><span style="color:#111">)</span><span style="color:#111">,</span>
  <span style="color:#111">theImage</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">theAudioClip</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">try</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">imageFileName</span> <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">&#34;</span><span style="color:#111">)</span> <span style="color:#111">{</span>
            <span style="color:#111">theImage</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">Image</span><span style="color:#111">(</span><span style="color:#111">imageFileName</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#111">}</span>
        <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">audioClipFileName</span> <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">&#34;</span><span style="color:#111">)</span> <span style="color:#111">{</span>
            <span style="color:#111">theAudioClip</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">AudioClip</span><span style="color:#111">(</span><span style="color:#111">audioClipFileName</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#111">}</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">catch</span> <span style="color:#111">(</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">)</span> <span style="color:#111">{</span>               <span style="color:#75715e">// catch any exception
</span><span style="color:#75715e"></span>        <span style="color:#00a8c8">delete</span> <span style="color:#111">theImage</span><span style="color:#111">;</span>        <span style="color:#75715e">// perform necessary cleanup actions
</span><span style="color:#75715e"></span>        <span style="color:#00a8c8">delete</span> <span style="color:#111">theAudioClip</span><span style="color:#111">;</span>
        <span style="color:#00a8c8">throw</span><span style="color:#111">;</span>                  <span style="color:#75715e">// propagate the exception
</span><span style="color:#75715e"></span>    <span style="color:#111">}</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>For non-pointer data members such as <code>theName</code>, <code>theAddress</code>, and <code>thePhones</code>, they are automatically initialized before a class's constructor is called, so if a <code>BookEntry</code> constructor body begins exewcuting, they have already been fully constructed. As fully constructed objects, they will also be automatically destroyed even if an exception arises in  the <code>BookEntry</code> constructor.</p>
<p>Considering code duplication, we may move the common resource cleanup code into a private helper funciton and have both the constructor and the destructor call it:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">BookEntry</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span> <span style="color:#75715e">// as before
</span><span style="color:#75715e"></span><span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span> 
    <span style="color:#00a8c8">void</span> <span style="color:#111">cleanup</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// common cleanup statement
</span><span style="color:#75715e"></span><span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#00a8c8">void</span> <span style="color:#111">BookEntry</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">cleanup</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">delete</span> <span style="color:#111">theImage</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">delete</span> <span style="color:#111">theAudioClip</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#111">BookEntry</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">BookEntry</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">name</span><span style="color:#111">,</span>
                     <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">address</span><span style="color:#111">,</span>
                     <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">imageFileName</span><span style="color:#111">,</span>
                     <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">audioClipFileName</span><span style="color:#111">)</span>
<span style="color:#f92672">:</span> <span style="color:#111">theName</span><span style="color:#111">(</span><span style="color:#111">name</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">theAddress</span><span style="color:#111">(</span><span style="color:#111">address</span><span style="color:#111">)</span><span style="color:#111">,</span>
  <span style="color:#111">theImage</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">theAudioClip</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">try</span> <span style="color:#111">{</span>
        <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">catch</span> <span style="color:#111">(</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">)</span> <span style="color:#111">{</span>               <span style="color:#75715e">// catch any exception
</span><span style="color:#75715e"></span>        <span style="color:#111">cleanup</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#00a8c8">throw</span><span style="color:#111">;</span>                  <span style="color:#75715e">// propagate the exception
</span><span style="color:#75715e"></span>    <span style="color:#111">}</span>
<span style="color:#111">}</span>

<span style="color:#111">BookEntry</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">BookEntry</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">cleanup</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><hr>
<h1 id="for-both-constant-and-non-const-pointers">For both <code>constant</code> and non-<code>const</code> pointers</h1>
<p>What if <code>BookEntry</code> class interface is designed differently, with <code>theImage</code> and <code>theAudioClip</code> defined as <code>constant</code> pointers, which must be initialized via the member initialization lists:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">BookEntry</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#111">Image</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">const</span> <span style="color:#111">theImage</span><span style="color:#111">;</span>
    <span style="color:#111">AudioClip</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">const</span> <span style="color:#111">theAudioClip</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="naive-implementation-1">Naive implementation</h2>
<p>We may be tempted to initit <code>theImage</code> and <code>theAudioClip</code> like this:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// an implementation that may leak resources if an exception is thrown
</span><span style="color:#75715e"></span><span style="color:#111">BookEntry</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">BookEntry</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">name</span><span style="color:#111">,</span>
                     <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">address</span><span style="color:#111">,</span>
                     <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">imageFileName</span><span style="color:#111">,</span>
                     <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">audioClipFileName</span><span style="color:#111">)</span>
<span style="color:#f92672">:</span> <span style="color:#111">theName</span><span style="color:#111">(</span><span style="color:#111">name</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">theAddress</span><span style="color:#111">(</span><span style="color:#111">address</span><span style="color:#111">)</span><span style="color:#111">,</span>
  <span style="color:#111">theImage</span><span style="color:#111">(</span><span style="color:#111">imageFileName</span> <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">&#34;</span>
           <span style="color:#f92672">?</span> <span style="color:#00a8c8">new</span> <span style="color:#111">Image</span><span style="color:#111">(</span><span style="color:#111">imageFileName</span><span style="color:#111">)</span>
           <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#111">,</span> 
  <span style="color:#111">theAudioClip</span><span style="color:#111">(</span><span style="color:#111">audioClipFileName</span> <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">&#34;</span>
               <span style="color:#f92672">?</span> <span style="color:#00a8c8">new</span> <span style="color:#111">AudioClip</span><span style="color:#111">(</span><span style="color:#111">audioClipFileNAme</span><span style="color:#111">)</span>
               <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
<span style="color:#111">{</span><span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>but this leads to the problem of potential resource leak: if an exception is thrown during initialization of <code>theAudioClip</code>, the object pointed to by <code>theImage</code> is never destroyed.</p>
<h2 id="workable-design">Workable design</h2>
<p>In order to add <code>try</code> and <code>catch</code> to perform cleanup tasks in a member initialization list, we may consider put them inside private member functions that return pointers:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">BookEntry</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#111">Image</span> <span style="color:#f92672">*</span> <span style="color:#111">initImage</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">imageFileName</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">AudioClip</span> <span style="color:#f92672">*</span> <span style="color:#75af00">initAudioClip</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">audioClipFileName</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#111">BookEntry</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">BookEntry</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">name</span><span style="color:#111">,</span>
                     <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">address</span><span style="color:#111">,</span>
                     <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">imageFileName</span><span style="color:#111">,</span>
                     <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">audioClipFileName</span><span style="color:#111">)</span>
<span style="color:#f92672">:</span> <span style="color:#111">theName</span><span style="color:#111">(</span><span style="color:#111">name</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">theAddress</span><span style="color:#111">(</span><span style="color:#111">address</span><span style="color:#111">)</span><span style="color:#111">,</span>
  <span style="color:#111">theImage</span><span style="color:#111">(</span><span style="color:#111">initImage</span><span style="color:#111">(</span><span style="color:#111">imageFileName</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">,</span>
  <span style="color:#111">theAudioClip</span><span style="color:#111">(</span><span style="color:#111">initAudioClip</span><span style="color:#111">(</span><span style="color:#111">audioClipFileName</span><span style="color:#111">)</span><span style="color:#111">)</span>
<span style="color:#111">{</span><span style="color:#111">}</span>

<span style="color:#75715e">// theImage is init. first, so there&#39;s no need to worry about a resource leak
</span><span style="color:#75715e"></span><span style="color:#75715e">// if this initialization fails.
</span><span style="color:#75715e"></span><span style="color:#111">Image</span> <span style="color:#f92672">*</span> <span style="color:#111">BookEntry</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">initImage</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">imageFileName</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">imageFileName</span> <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">&#34;</span><span style="color:#111">)</span> <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">new</span> <span style="color:#111">Image</span><span style="color:#111">(</span><span style="color:#111">imageFileName</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">return</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#75715e">// theAudioClip is initialized second, so it must take care of theImage&#39;s resources
</span><span style="color:#75715e"></span><span style="color:#75715e">// if an exception is thrown during initialization of theAudioClip 
</span><span style="color:#75715e"></span><span style="color:#111">AudioClip</span> <span style="color:#f92672">*</span> <span style="color:#111">BookEntry</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">initAudioClip</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">audioClipFileName</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">try</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">audioClipFileName</span> <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">&#34;</span><span style="color:#111">)</span> <span style="color:#111">{</span>
            <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">new</span> <span style="color:#75af00">AudioClip</span><span style="color:#111">(</span><span style="color:#111">audioClipFileName</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#111">}</span>
        <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">return</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#00a8c8">catch</span> <span style="color:#111">(</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">delete</span> <span style="color:#111">theImage</span><span style="color:#111">;</span>
        <span style="color:#00a8c8">throw</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This design works, but the drawback is that code that conceptually belongs in a constructor is now dispersed across several functions, and that's a maitenance headache.</p>
<h2 id="better-design">Better design</h2>
<p>A better design is to adopt the advise of MECpp Item 9 (as well as item 13):</p>
<ul>
<li>treat the objects pointed to by <code>theImage</code> and <code>theAudioClip</code> as resources to be managed by local objects (specifically, smart pointers).</li>
</ul>
<p>Since the resource here is of pointer types, we can use smart pointers to manage them. Take <code>auto_ptr</code> for example:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">BookEntry</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#00a8c8">const</span> <span style="color:#111">auto_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">Image</span><span style="color:#f92672">&gt;</span> <span style="color:#111">theImage</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">const</span> <span style="color:#111">auto_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">AudioClip</span><span style="color:#f92672">&gt;</span> <span style="color:#111">theAudioClip</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#111">BookEntry</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">BookEntry</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">name</span><span style="color:#111">,</span>
                     <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">address</span><span style="color:#111">,</span>
                     <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">imageFileName</span><span style="color:#111">,</span>
                     <span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">audioClipFileName</span><span style="color:#111">)</span>
<span style="color:#f92672">:</span> <span style="color:#111">theName</span><span style="color:#111">(</span><span style="color:#111">name</span><span style="color:#111">)</span><span style="color:#111">,</span> <span style="color:#111">theAddress</span><span style="color:#111">(</span><span style="color:#111">address</span><span style="color:#111">)</span><span style="color:#111">,</span>
  <span style="color:#111">theImage</span><span style="color:#111">(</span><span style="color:#111">imageFileName</span> <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">&#34;</span>
           <span style="color:#f92672">?</span> <span style="color:#00a8c8">new</span> <span style="color:#111">Image</span><span style="color:#111">(</span><span style="color:#111">imageFileName</span><span style="color:#111">)</span>
           <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#111">,</span> 
  <span style="color:#111">theAudioClip</span><span style="color:#111">(</span><span style="color:#111">audioClipFileName</span> <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">&#34;</span>
               <span style="color:#f92672">?</span> <span style="color:#00a8c8">new</span> <span style="color:#111">AudioClip</span><span style="color:#111">(</span><span style="color:#111">audioClipFileNAme</span><span style="color:#111">)</span>
               <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
<span style="color:#111">{</span><span style="color:#111">}</span>

<span style="color:#111">BookEntry</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">BookEntry</span><span style="color:#111">(</span><span style="color:#111">)</span>  <span style="color:#75715e">// nothing to do
</span><span style="color:#75715e"></span><span style="color:#111">{</span><span style="color:#111">}</span>                       
</code></pre></td></tr></table>
</div>
</div><p>In this design, if an exception is thrown during initialization of <code>theAudioClip</code>, <code>theImage</code> is already a fully constructed object, so it will automatically be destroyed, jsut like <code>theName</code>, <code>theAddress</code>, and <code>thePhones</code>. Furthermore, because <code>theImage</code> and <code>theAudioClip</code> are now objects, they'll be destroyed automatically when the <code>BookEntry</code> object containing them is destroyed.</p></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
