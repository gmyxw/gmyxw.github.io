<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>[MECpp]Item-9 Use Destructors to Prevent Resource Leaks - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>[MECpp]Item-9 Use Destructors to Prevent Resource Leaks</h1>
  </div>
<div class="meta">
  <div>2018-04-01 00:00</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>To avoid resource leaks in the presence of exceptions, we can encapsulate resources inside objects.</p>
<!-- toc -->
<h1 id="using-objects-to-manage-pointer-based-resource">Using objects to manage pointer-based resource</h1>
<p>Suppose we're writing software for a shelter names Adorable Little Animals, an organization that finds homes for puppies and kittens. Each day the shelter creates a file containing information on the adoptions it arranged that day, so we need to read these files and do the approgriate procesing for each adoption.</p>
<p>A reasonable design will use polymorphism: an abstract base class <code>ALA</code> (&ldquo;adorable little animal&rdquo;), with two concrete derived classes for puppies and kittens, and a virtual function <code>processAdoption</code> to handle the necessary species-specific processing:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">ALA</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#111">processAdoption</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#00a8c8">class</span> <span style="color:#75af00">Puppy</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">ALA</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#111">processAdoption</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#00a8c8">class</span> <span style="color:#75af00">Kitten</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">ALA</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">virtual</span> <span style="color:#00a8c8">void</span> <span style="color:#111">processAdoption</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Another thing we need is a <em>virtual constructor</em> (MECpp item 25), which reads information from a file and produce either a <code>Puppy</code> object or a <code>Kitten</code> object, depending on the information in the file:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">ALA</span> <span style="color:#f92672">*</span> <span style="color:#75af00">readALA</span><span style="color:#111">(</span><span style="color:#111">istream</span><span style="color:#f92672">&amp;</span> <span style="color:#111">s</span><span style="color:#111">)</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Finally, the key processing part of the program looks like this:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#75af00">processAdoptions</span><span style="color:#111">(</span><span style="color:#111">istream</span><span style="color:#f92672">&amp;</span> <span style="color:#111">dataSource</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">while</span> <span style="color:#111">(</span><span style="color:#111">dataSource</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#111">ALA</span> <span style="color:#f92672">*</span><span style="color:#111">pa</span> <span style="color:#f92672">=</span> <span style="color:#111">readALA</span><span style="color:#111">(</span><span style="color:#111">dataSource</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#111">pa</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">processAdoption</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#00a8c8">delete</span> <span style="color:#111">pa</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>However, there's a potential resource leak: if <code>pa-&gt;processAdoption</code> threw an exception, all statements in <code>processAdoptions</code> after this statement would be skipped, ending up with <code>pa</code> never getting deleted. To solve it, an ungly design would be:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#75af00">processAdoptions</span><span style="color:#111">(</span><span style="color:#111">istream</span><span style="color:#f92672">&amp;</span> <span style="color:#111">dataSource</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">while</span> <span style="color:#111">(</span><span style="color:#111">dataSource</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#111">ALA</span> <span style="color:#f92672">*</span><span style="color:#111">pa</span> <span style="color:#f92672">=</span> <span style="color:#111">readALA</span><span style="color:#111">(</span><span style="color:#111">dataSource</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#00a8c8">try</span> <span style="color:#111">{</span>
        <span style="color:#111">pa</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">processAdoption</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#111">}</span>
        <span style="color:#00a8c8">catch</span> <span style="color:#111">(</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">)</span> <span style="color:#111">{</span>
            <span style="color:#00a8c8">delete</span> <span style="color:#111">pa</span><span style="color:#111">;</span>   <span style="color:#75715e">// avoid resource leak when encountering exception
</span><span style="color:#75715e"></span>            <span style="color:#00a8c8">throw</span><span style="color:#111">;</span>       <span style="color:#75715e">// propagate exception to caller
</span><span style="color:#75715e"></span>        <span style="color:#111">}</span>
        <span style="color:#00a8c8">delete</span> <span style="color:#111">pa</span><span style="color:#111">;</span>       <span style="color:#75715e">// delete pa in normal condition
</span><span style="color:#75715e"></span>    <span style="color:#111">}</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The duplication in cleanup code is annoying to write and difficult to maintain. Remember that</p>
<blockquote>
<p>Local objects are always destroyed when leaving a function, regardless of how that function is exited <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>.</p>
</blockquote>
<p>So we can move the <code>delete</code> into a destructor for an object local to <code>processAdoptions</code>, which is exactly the functionaltity smart pointers in standard C++ library provide. For example, the essential of <code>auto_ptr</code> (item 13, MECpp item 28) boils down to following definition:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">auto_ptr</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">auto_ptr</span><span style="color:#111">(</span><span style="color:#111">T</span> <span style="color:#f92672">*</span><span style="color:#111">p</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#f92672">:</span> <span style="color:#111">ptr</span><span style="color:#111">(</span><span style="color:#111">p</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#111">}</span>  <span style="color:#75715e">// save ptr to object
</span><span style="color:#75715e"></span>    <span style="color:#f92672">~</span><span style="color:#111">auto_ptr</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#00a8c8">delete</span> <span style="color:#111">ptr</span><span style="color:#111">;</span> <span style="color:#111">}</span>    <span style="color:#75715e">// delete ptr to object
</span><span style="color:#75715e"></span><span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">T</span> <span style="color:#f92672">*</span><span style="color:#111">ptr</span><span style="color:#111">;</span>                        <span style="color:#75715e">// raw ptr to object
</span><span style="color:#75715e"></span><span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>New <code>processAdoptions</code> using an <code>auto_ptr</code> object instead of a raw pointer:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#75af00">processAdoptions</span><span style="color:#111">(</span><span style="color:#111">istream</span><span style="color:#f92672">&amp;</span> <span style="color:#111">dataSource</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">while</span> <span style="color:#111">(</span><span style="color:#111">dataSource</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#111">auto_ptr</span><span style="color:#f92672">&lt;</span><span style="color:#111">ALA</span><span style="color:#f92672">&gt;</span> <span style="color:#111">pa</span><span style="color:#111">(</span><span style="color:#111">readALA</span><span style="color:#111">(</span><span style="color:#111">dataSource</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>
        <span style="color:#111">pa</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span><span style="color:#111">processAdoption</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><!-- toc -->
<h1 id="using-objects-to-manage-other-resources">Using objects to manage other resources</h1>
<p>The idea behind <code>auto_ptr</code> is to use an object to store a resource that needs to be automatically released via the object's destructor, which applis to broader ranges of resource types as well. For example, in a GUI application that needs to create a window to display some information:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#75af00">displayInfo</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Information</span><span style="color:#f92672">&amp;</span> <span style="color:#111">info</span><span style="color:#111">)</span> 
<span style="color:#111">{</span>
    <span style="color:#111">WINDOW_HANDLE</span> <span style="color:#111">w</span><span style="color:#111">(</span><span style="color:#111">createWindow</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">display</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">info</span><span style="color:#d88200">&#34;</span> <span style="color:#111">in</span> <span style="color:#111">window</span> <span style="color:#111">corresponding</span> <span style="color:#111">to</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">w</span><span style="color:#d88200">&#34;</span><span style="color:#111">;</span>
    <span style="color:#111">destroyWindw</span><span style="color:#111">(</span><span style="color:#111">w</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The functions <code>createWindow</code> and <code>destroyWindow</code> for acquiring and releasing window resources should be packaged in an object to avoid resource leak in the situations where an exception is thrown during process of displaying <code>info</code> in <code>w</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// class for acquiring and releasing a window handle
</span><span style="color:#75715e"></span><span style="color:#00a8c8">class</span> <span style="color:#75af00">WindowHandle</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#111">WindowHandle</span><span style="color:#111">(</span><span style="color:#111">WINDOW_HANDLE</span> <span style="color:#111">handle</span><span style="color:#111">)</span><span style="color:#f92672">:</span> <span style="color:#111">w</span><span style="color:#111">(</span><span style="color:#111">handle</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#111">}</span>
    <span style="color:#f92672">~</span><span style="color:#111">WindowHandle</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#111">destroyWindow</span><span style="color:#111">(</span><span style="color:#111">w</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>

    <span style="color:#00a8c8">operator</span> <span style="color:#75af00">WINDOW_HANDLE</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#111">w</span><span style="color:#111">;</span> <span style="color:#111">}</span>  <span style="color:#75715e">// implicit convertion operator to turn a WindowHandle into a WINDOW_HANDLE
</span><span style="color:#75715e"></span><span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">WINDOW_HANDLE</span> <span style="color:#111">w</span><span style="color:#111">;</span>
    <span style="color:#111">WindowHandle</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">WindowHandle</span><span style="color:#f92672">&amp;</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#75715e">// prevent multiple copies
</span><span style="color:#75715e"></span>    <span style="color:#111">WindowHandle</span><span style="color:#f92672">&amp;</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">WindowHandle</span><span style="color:#f92672">&amp;</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// prevent multiple copies
</span><span style="color:#75715e"></span><span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Note that the implicit conversion operator is essential to the practical application of a <code>WindowHandle</code> object, becauce it means we can use a <code>WindowHandle</code> just about anywhere we would normally use a raw <code>WINDOW_HANDLE</code> (refer to MECpp item 5 for downsides of doing so).</p>
<p>Given this <code>WindowHandle</code> class, we can rewrite <code>desplayInfo</code> as follows:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#75af00">displayInfo</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Information</span><span style="color:#f92672">&amp;</span> <span style="color:#111">info</span><span style="color:#111">)</span> 
<span style="color:#111">{</span>
    <span style="color:#111">WindowHandle</span> <span style="color:#111">w</span><span style="color:#111">(</span><span style="color:#111">createWindow</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">display</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">info</span><span style="color:#d88200">&#34;</span> <span style="color:#111">in</span> <span style="color:#111">window</span> <span style="color:#111">corresponding</span> <span style="color:#111">to</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">w</span><span style="color:#d88200">&#34;</span><span style="color:#111">;</span>
<span style="color:#111">}</span>  <span style="color:#75715e">// the window handled by &#34;w&#34; will always be released even if an exception is thrown
</span></code></pre></td></tr></table>
</div>
</div><section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>The only exception to this rule is when we call <code>longjmp</code>, and this shortcoming of <code>longjmp</code> is the primary reason why C++ has support for exceptions in the first place. <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
