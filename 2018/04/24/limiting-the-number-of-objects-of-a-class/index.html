<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>[MECpp]Item-26 Limiting the Number of Objects of a Class - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>[MECpp]Item-26 Limiting the Number of Objects of a Class</h1>
  </div>
<div class="meta">
  <div>2018-04-24 15:03</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>Combining object-counting technique with the pseudo-constructors, we can limit the number of objects of a class.</p>
<!-- toc -->
<h1 id="allowing-zero-or-one-objects">Allowing zero or one objects</h1>
<p>Using the classic singleton design pattern, it's easy to limit the number of object to either zero or one. There are three points worth noting in this design:</p>
<ol>
<li>Declaring the constructors of the class <code>private</code></li>
<li>Using static object</li>
<li>In order to access the single object, encapsulate the single object inside a accessor function (either a friend function inside some namespace/globally, or a static member function of that class). Note that:
<ul>
<li>Remember to put the static object inside this wrapper function to make it a function static instead of a class static, because
<ul>
<li>A class static is always constructed even if it's never used, while a function static is created the first time through the function</li>
<li>C++ says noting about the initialization order of static objects in different translation units, so class statics turn out to be a source of headaches, which can be avoided in the case of function statics (ECpp Item 4).</li>
</ul>
</li>
<li>If this wrapper function is also declared as <code>inline</code>, it's possible for some compilers to create more than one copy of the static objects in the program due to <em>internal linkage</em> (the object code for the program may contain more than one copy of each function with internal linkage, and this duplication includes function statics). So shy away from inline functions with static data.</li>
</ul>
</li>
</ol>
<p>Example:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">namespace</span> <span style="color:#111">PrintingStuff</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">Printer</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">void</span> <span style="color:#111">submitJob</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">PrintJob</span><span style="color:#f92672">&amp;</span> <span style="color:#111">job</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">void</span> <span style="color:#75af00">reset</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">void</span> <span style="color:#75af00">performSelfTest</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">friend</span> <span style="color:#111">Printer</span><span style="color:#f92672">&amp;</span> <span style="color:#111">thePrinter</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">Printer</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">Printer</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Printer</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#111">Printer</span><span style="color:#f92672">&amp;</span> <span style="color:#111">thePrinter</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#75715e">// no inline in case of duplication caused by internal linkage
</span><span style="color:#75715e"></span><span style="color:#111">{</span>
    <span style="color:#00a8c8">static</span> <span style="color:#111">Printer</span> <span style="color:#111">p</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">p</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
<span style="color:#111">}</span> <span style="color:#75715e">// namespace PrintingStuff
</span></code></pre></td></tr></table>
</div>
</div><p>Since the accessor returns a reference to a <code>Printer</code> object, clients may use <code>thePrinter</code> in any context where a <code>Printer</code> object itself is expected:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">using</span> <span style="color:#111">PrintingStuff</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">thePrinter</span><span style="color:#111">;</span> 

<span style="color:#111">thePrinter</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">.</span><span style="color:#111">reset</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">thePrinter</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">.</span><span style="color:#111">submitJob</span><span style="color:#111">(</span><span style="color:#111">buffer</span><span style="color:#111">)</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>However, there's still an inconvenience in this design: we're limited to a single <code>Printer</code> object for each run of the program. As a result, it's not possible to write code like this:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">create</span> <span style="color:#111">Printer</span> <span style="color:#111">object</span> <span style="color:#111">p1</span><span style="color:#111">;</span>
<span style="color:#111">use</span> <span style="color:#111">p1</span><span style="color:#111">;</span>
<span style="color:#111">destroy</span> <span style="color:#111">p1</span><span style="color:#111">;</span>
<span style="color:#111">create</span> <span style="color:#111">Printer</span> <span style="color:#111">object</span> <span style="color:#111">p2</span><span style="color:#111">;</span>
<span style="color:#111">use</span> <span style="color:#111">p2</span><span style="color:#111">;</span>
<span style="color:#111">destroy</span> <span style="color:#111">p2</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>This design never instantiates more than a single <code>Printer</code> object at a time, but it does use different <code>Printer</code> objects in different parts of the program. It does not violate the constraint that only one printer may exist, but is still illegal with a single function static implementation.</p>
<p>This need for flexibility leads us to the design of object-counting.</p>
<h1 id="allowing-multimple-objects-object-counting-with-pseudo-constructor">Allowing multimple objects: object-counting with pseudo-constructor</h1>
<h2 id="object-counting">Object-counting</h2>
<p>The good point of object-counting is that, it provides us with more flexibility than the function static, and makes it easier to generalize the limit number to more than one. However, object-counting alone will not work. For example:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Printer</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">class</span> <span style="color:#75af00">TooManyObjects</span><span style="color:#111">{</span><span style="color:#111">}</span><span style="color:#111">;</span>  <span style="color:#75715e">// exception class for use when too many obj. are requested; may also returning null for too-many-object cases
</span><span style="color:#75715e"></span>    <span style="color:#111">Printer</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">Printer</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Printer</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#f92672">~</span><span style="color:#111">Printer</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">static</span> <span style="color:#111">size_t</span> <span style="color:#111">numObjects</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">const</span> <span style="color:#111">size_t</span> <span style="color:#111">maxObjects</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#111">;</span> <span style="color:#75715e">// may need enum hack here for old compiler
</span><span style="color:#75715e"></span><span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// Obligatory definitions of class statics
</span><span style="color:#75715e"></span><span style="color:#111">size_t</span> <span style="color:#111">Printer</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">numObjects</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>
<span style="color:#00a8c8">const</span> <span style="color:#111">size_t</span> <span style="color:#111">Printer</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">maxObjets</span><span style="color:#111">;</span>

<span style="color:#111">Printer</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">Printer</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">numObjects</span> <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#111">maxObjects</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">throw</span> <span style="color:#75af00">TooManyObjects</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>   
    <span style="color:#111">process</span> <span style="color:#111">with</span> <span style="color:#111">normal</span> <span style="color:#111">construction</span> <span style="color:#111">here</span><span style="color:#111">;</span>
    <span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">numObjects</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#111">Printer</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">Printer</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">perform</span> <span style="color:#111">normal</span> <span style="color:#111">destruction</span> <span style="color:#111">here</span><span style="color:#111">;</span>
    <span style="color:#f92672">-</span><span style="color:#f92672">-</span><span style="color:#111">numObjects</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#111">Printer</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">Printer</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Printer</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">numObjects</span> <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#111">maxObjects</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">throw</span> <span style="color:#75af00">TooManyObjects</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>    
    <span style="color:#111">perform</span> <span style="color:#111">normal</span> <span style="color:#111">copy</span> <span style="color:#111">construction</span> <span style="color:#111">here</span>
    <span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">numObjects</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The problem here is that, in order to set a limit on the number of instantiations,  we should not declare the class constructor <code>public</code>, because that will allow clients to put the class as base class parts of more derived objects, or embedded inside larger objects, which is totally different usage context, and the presence of these different contexts significantly muddies the waters regarding what it means to keep track of the &ldquo;number of objects in existence.&rdquo; For example:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">ColorPrinter</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">public</span> <span style="color:#111">Printer</span> <span style="color:#111">{</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">Printer</span> <span style="color:#111">p</span><span style="color:#111">;</span>
<span style="color:#111">ColorPrinter</span> <span style="color:#111">cp</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>From object definition above, there are two <code>Printer</code> objects, one for <code>p</code> and one for the <code>Printer</code> part of <code>cp</code>. This is usually unwanted behavior.</p>
<p>Often we are interested only in allowing objects to exist on their own, and limit the number of those kinds of instantiations. To satisfy such restrictions, we should declare the class constructors <code>private</code>, and (in the absence of <code>friend</code> declarations) classes with private constructors can't be used as base classes, nor can they be embedded inside other objects.</p>
<h2 id="pseudo-constructor">Pseudo-constructor</h2>
<p>In fact, private constructors are a general solution for preventing derivation. Instead of returning a reference to a single object (like what <code>thePrinter</code> does), we can declare a pseudo-constructor returning a pointer to a unique object to allow multiple objects.</p>
<p>That is, we combine the object-counting with pseudo-consturctors:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Printer</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">class</span> <span style="color:#75af00">TooManyObjects</span><span style="color:#111">{</span><span style="color:#111">}</span><span style="color:#111">;</span>  <span style="color:#75715e">// exception class for use when too many obj. are requested; may also returning null for too-many-object cases
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// pseudo-constructor
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">static</span> <span style="color:#111">Printer</span> <span style="color:#f92672">*</span> <span style="color:#75af00">makePrinter</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">static</span> <span style="color:#111">Printer</span> <span style="color:#f92672">*</span> <span style="color:#75af00">makePrinter</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Printer</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#f92672">~</span><span style="color:#111">Printer</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">static</span> <span style="color:#111">size_t</span> <span style="color:#111">numObjects</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">const</span> <span style="color:#111">size_t</span> <span style="color:#111">maxObjects</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#111">;</span> <span style="color:#75715e">// may need enum hack here for old compiler
</span><span style="color:#75715e"></span>    <span style="color:#111">Printer</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">Printer</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Printer</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span> 
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// Obligatory definitions of class statics
</span><span style="color:#75715e"></span><span style="color:#111">size_t</span> <span style="color:#111">Printer</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">numObjects</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span>
<span style="color:#00a8c8">const</span> <span style="color:#111">size_t</span> <span style="color:#111">Printer</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">maxObjets</span><span style="color:#111">;</span>

<span style="color:#111">Printer</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">Printer</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">numObjects</span> <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#111">maxObjects</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">throw</span> <span style="color:#75af00">TooManyObjects</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
    <span style="color:#111">process</span> <span style="color:#111">with</span> <span style="color:#111">normal</span> <span style="color:#111">construction</span> <span style="color:#111">here</span><span style="color:#111">;</span>
    <span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">numObjects</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#111">Printer</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">Printer</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Printer</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">numObjects</span> <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#111">maxObjects</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#00a8c8">throw</span> <span style="color:#75af00">TooManyObjects</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>    
    <span style="color:#111">perform</span> <span style="color:#111">normal</span> <span style="color:#111">copy</span> <span style="color:#111">construction</span> <span style="color:#111">here</span>
    <span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">numObjects</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#111">Printer</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span><span style="color:#111">Printer</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">perform</span> <span style="color:#111">normal</span> <span style="color:#111">destruction</span> <span style="color:#111">here</span><span style="color:#111">;</span>
    <span style="color:#f92672">-</span><span style="color:#f92672">-</span><span style="color:#111">numObjects</span><span style="color:#111">;</span>
<span style="color:#111">}</span>

<span style="color:#111">Printer</span> <span style="color:#f92672">*</span> <span style="color:#111">Printer</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">makePrinter</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">new</span> <span style="color:#111">Printer</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#111">Printer</span> <span style="color:#f92672">*</span> <span style="color:#111">Printer</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">makePrinter</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Printer</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span>
<span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">new</span> <span style="color:#75af00">Printer</span><span style="color:#111">(</span><span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="an-object-counting-base-class">An object-counting base class</h2>
<p>We can split the instance counting ability apart from the <code>Printer</code> class to reuse the limited-number-of-instance functionality.</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">BeingCounted</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">class</span> <span style="color:#75af00">Counted</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">class</span> <span style="color:#75af00">TooManyObjects</span><span style="color:#111">{</span><span style="color:#111">}</span><span style="color:#111">;</span> <span style="color:#75715e">// for throwing exceptions
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">static</span> <span style="color:#111">size_t</span> <span style="color:#75af00">objectCount</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#111">numObjects</span><span style="color:#111">;</span> <span style="color:#111">}</span>
<span style="color:#00a8c8">protected</span><span style="color:#f92672">:</span>
    <span style="color:#111">Counted</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">Counted</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Counted</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#f92672">~</span><span style="color:#111">Counted</span><span style="color:#111">(</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#f92672">-</span><span style="color:#f92672">-</span><span style="color:#111">numObjects</span><span style="color:#111">;</span> <span style="color:#111">}</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#00a8c8">static</span> <span style="color:#111">size_t</span> <span style="color:#111">numObjects</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">const</span> <span style="color:#111">size_t</span> <span style="color:#111">maxObjects</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">void</span> <span style="color:#75af00">init</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// to avoid ctor code duplication
</span><span style="color:#75715e"></span><span style="color:#111">}</span><span style="color:#111">;</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">BeingCounted</span><span style="color:#f92672">&gt;</span>              <span style="color:#75715e">// defines numObjects and
</span><span style="color:#75715e"></span><span style="color:#111">size_t</span> <span style="color:#111">Counted</span><span style="color:#f92672">&lt;</span><span style="color:#111">BeingCounted</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">numObjects</span><span style="color:#111">;</span> <span style="color:#75715e">// automatically init. it to 0
</span><span style="color:#75715e"></span>
<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">BeingCouted</span><span style="color:#f92672">&gt;</span>
<span style="color:#111">Counted</span><span style="color:#f92672">&lt;</span><span style="color:#111">BeingCounted</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">Counted</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span> <span style="color:#111">init</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">BeingCounted</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">Counted</span><span style="color:#f92672">&lt;</span><span style="color:#111">BeingCounted</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">Counted</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Counted</span><span style="color:#f92672">&lt;</span><span style="color:#111">BeingCounted</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&amp;</span><span style="color:#111">)</span>
<span style="color:#111">{</span> <span style="color:#111">init</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span> <span style="color:#111">}</span>

<span style="color:#00a8c8">template</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">class</span> <span style="color:#75af00">BeingCounted</span><span style="color:#f92672">&gt;</span>
<span style="color:#00a8c8">void</span> <span style="color:#111">Counted</span><span style="color:#f92672">&lt;</span><span style="color:#111">BeingCounted</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">init</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">numObjects</span> <span style="color:#f92672">&gt;</span><span style="color:#f92672">=</span> <span style="color:#111">maxObjects</span><span style="color:#111">)</span> <span style="color:#00a8c8">throw</span> <span style="color:#111">TooManyObjects</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#111">numObjects</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Now modify the <code>Printer</code> class to use the <code>Counted</code> template:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Printer</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">private</span> <span style="color:#111">Counted</span><span style="color:#f92672">&lt;</span><span style="color:#111">Printer</span><span style="color:#f92672">&gt;</span> <span style="color:#111">{</span>
<span style="color:#00a8c8">public</span><span style="color:#f92672">:</span>
    <span style="color:#75715e">// pseudo-constructors
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">static</span> <span style="color:#111">Printer</span> <span style="color:#f92672">*</span> <span style="color:#111">makePrinter</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">static</span> <span style="color:#111">Printer</span> <span style="color:#f92672">*</span> <span style="color:#75af00">makePrinter</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Printer</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#f92672">~</span><span style="color:#111">Printer</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">void</span> <span style="color:#75af00">submitJob</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">PrintJob</span><span style="color:#f92672">&amp;</span> <span style="color:#111">job</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">void</span> <span style="color:#75af00">reset</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">void</span> <span style="color:#75af00">performSelfTest</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">.</span><span style="color:#111">.</span><span style="color:#111">.</span>
    <span style="color:#00a8c8">using</span> <span style="color:#111">Counted</span><span style="color:#f92672">&lt;</span><span style="color:#111">Printer</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">objectCount</span><span style="color:#111">;</span> <span style="color:#75715e">// make this function public for clients of Printer
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">using</span> <span style="color:#111">Counted</span><span style="color:#f92672">&lt;</span><span style="color:#111">Printer</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">TooManyObjects</span><span style="color:#111">;</span>
<span style="color:#00a8c8">private</span><span style="color:#f92672">:</span>
    <span style="color:#111">Printer</span><span style="color:#111">(</span><span style="color:#111">)</span><span style="color:#111">;</span>
    <span style="color:#111">Printer</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Printer</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#111">}</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Note that:</p>
<ol>
<li>
<p>We use <code>private</code> inheritance here because the implementation detials of keeping track of the number of instantiated objects are nobody's business but the author of <code>Printer</code>'s. If we use the alternative public inheritance design, then we have to give the <code>Counted</code> class a virtual destructor - that will almost certainly affect size and layout of objects of classes inheriting from <code>Counted</code>, as MECpp item 24 states.</p>
</li>
<li>
<p>Clients may still want to know how many <code>Printer</code> objects exists, but <code>objectCount</code> becomes <code>private</code> due to the private inheritance. To restore the public accessibility, we employ a <code>using</code> declaration.</p>
</li>
<li>
<p>After inheritance, <code>Printer</code> can forget about counting objects, so the <code>Printer</code> constructor now looks like this:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">Printer</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">Printer</span><span style="color:#111">(</span><span style="color:#111">)</span>
<span style="color:#111">{</span>
    <span style="color:#111">proceed</span> <span style="color:#111">with</span> <span style="color:#111">normal</span> <span style="color:#111">object</span> <span style="color:#111">construction</span><span style="color:#111">;</span>
<span style="color:#111">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The benifits:</p>
<ul>
<li>No checking of the number of objects to see if the limit is about to be exceeded</li>
<li>No incrementing the number of objects in existence once the constructor is done</li>
<li>Base class will always be invoked first, so if too many objects are created, a <code>Connted&lt;Printer&gt;</code> constructor throws an exception, and the <code>Printer</code> constructor won't even be invoked</li>
</ul>
</li>
<li>
<p>Clients of the <code>Printer</code> class are required to initialize <code>maxObjects</code>, or there will be an error during linking for undefined <code>maxObjects</code>:</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">const</span> <span style="color:#111">size_t</span> <span style="color:#111">Counted</span><span style="color:#f92672">&lt;</span><span style="color:#111">Printer</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#111">maxObjects</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ol></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
