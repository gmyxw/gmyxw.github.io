<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>[MECpp]Item-19 Understand the Origin of Temporary Objects - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>[MECpp]Item-19 Understand the Origin of Temporary Objects</h1>
  </div>
<div class="meta">
  <div>2018-04-13 17:06</div>
  <div>
    <span><a href="https://sy123.ml/tags/technique/">#technique</a></span>
      <span><a href="https://sy123.ml/tags/cpp/">#cpp</a></span>
      </div>
  </div>
<div class="content">
  <p>Unnamed non-heap objects are invisible temporary objects in C++.</p>
<!-- toc -->
<p>Temporary objects arise in two situations:</p>
<ol>
<li>when implicit type conversions are applied to make function calls succeed</li>
<li>when functions return objects</li>
</ol>
<p>It's important to understand how and why these temporary objects are created and destroyed because their construction and destruction can have noticeable impact on the performance of the program.</p>
<h1 id="implicit-conversion">Implicit conversion</h1>
<p>When the type of object passed to a function is not the same as the type of the parameter to which it is being bound, temporary objects are created during the implicit conversion to make function calls succeed.</p>
<p>For example,</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#111">size_t</span> <span style="color:#75af00">countChar</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">str</span><span style="color:#111">,</span> <span style="color:#00a8c8">char</span> <span style="color:#111">ch</span><span style="color:#111">)</span><span style="color:#111">;</span>

<span style="color:#00a8c8">char</span> <span style="color:#111">buffer</span><span style="color:#111">[</span><span style="color:#111">MAX_STRING_LEN</span><span style="color:#111">]</span><span style="color:#111">;</span>
<span style="color:#00a8c8">char</span> <span style="color:#111">c</span><span style="color:#111">;</span>

<span style="color:#75715e">// read in a char and a string; use setw to avoid 
</span><span style="color:#75715e"></span><span style="color:#75715e">// overflowing buffer when reading the string
</span><span style="color:#75715e"></span><span style="color:#111">cin</span> <span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#111">c</span> <span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#111">setw</span><span style="color:#111">(</span><span style="color:#111">MAX_STRING_LEN</span><span style="color:#111">)</span> <span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#111">buffer</span><span style="color:#111">;</span>
<span style="color:#111">cout</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">There are </span><span style="color:#d88200">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#111">countChar</span><span style="color:#111">(</span><span style="color:#111">buffer</span><span style="color:#111">,</span> <span style="color:#111">c</span><span style="color:#111">)</span>
     <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200"> occurrences of the character </span><span style="color:#d88200">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#111">c</span>
     <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200"> in </span><span style="color:#d88200">&#34;</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#111">buffer</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#111">endl</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Here is what will happen:</p>
<ol>
<li>By passing a <code>char</code> array into function <code>countChar</code> which expects a <code>const string&amp;</code>, compilers will create a temporary object of type <code>string</code> constructed by calling the <code>string</code> constructor with <code>buffer</code> as its argument.</li>
<li>The <code>str</code> parameter of <code>countChar</code> is then bound to this temporary <code>string</code> object.</li>
<li>When the statement containing the call to <code>countChar</code> finishes executing, the temporary object is automatically destroyed.</li>
</ol>
<p>Needless to say, such implicit conversion (with pointless construction and destruction of temporary objects)  is not efficient and should be eliminated:</p>
<ul>
<li>by redesigning the code to forbid such implicit conversion, MECpp item 5</li>
<li>by modifying the code the same as described in MECpp item 21</li>
</ul>
<h2 id="restrictions-on-implicit-conversion">Restrictions on implicit conversion</h2>
<p>These conversions occur only when passing objects by value or when passing to a reference-to-<code>const</code> parameter, so when passing an object to a reference-to-non-<code>const</code> parameter, there is no implicit conversion. For example,</p>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">void</span> <span style="color:#75af00">uppercasify</span><span style="color:#111">(</span><span style="color:#111">string</span><span style="color:#f92672">&amp;</span> <span style="color:#111">str</span><span style="color:#111">)</span><span style="color:#111">;</span>
<span style="color:#00a8c8">char</span> <span style="color:#111">bookTitle</span><span style="color:#111">[</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#d88200"></span><span style="color:#d88200">&#34;</span><span style="color:#d88200">Effective C++</span><span style="color:#d88200">&#34;</span><span style="color:#111">;</span>
<span style="color:#111">uppercasify</span><span style="color:#111">(</span><span style="color:#111">bootTitle</span><span style="color:#111">)</span><span style="color:#111">;</span>  <span style="color:#75715e">// error!
</span></code></pre></td></tr></table>
</div>
</div><p>Here, temporary would not be created for parameter <code>str</code>, which is declared to be of type &ldquo;non-<code>const</code> reference&rdquo;, because it is the <code>bookTitle</code> that is supposed to be updated, instead of a newly created temporary.</p>
<h1 id="function-return-value">Function return value</h1>
<div class="highlight"><div style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00a8c8">const</span> <span style="color:#111">Number</span> <span style="color:#00a8c8">operator</span><span style="color:#f92672">+</span><span style="color:#111">(</span><span style="color:#00a8c8">const</span> <span style="color:#111">Number</span><span style="color:#f92672">&amp;</span> <span style="color:#111">lhs</span><span style="color:#111">,</span> <span style="color:#00a8c8">const</span> <span style="color:#111">Number</span><span style="color:#f92672">&amp;</span> <span style="color:#111">rhs</span><span style="color:#111">)</span><span style="color:#111">;</span>
</code></pre></td></tr></table>
</div>
</div><p>The return value of <code>operator+</code> is a temporary, because it is just the function's return value and has no name, and we must pay to construct and destruct this object each time we call the function. (<code>const</code> is added for the same reason in MECpp item 6);</p>
<p>To avoid such costs,</p>
<ul>
<li>switch to a similar function <code>operator+=</code>, MECpp item 22</li>
<li>if, in most cases, conceptually the construction and destruction can not be avoided, we optimize the program using the technique <code>return value optimization</code> instroduced in MECpp item 20</li>
</ul></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
