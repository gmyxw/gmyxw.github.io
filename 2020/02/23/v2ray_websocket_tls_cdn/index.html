<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>V2Ray_WebSocket_TLS_CDN - sy123.ml</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.ml/">sy123.ml</a></h1><h2><a href="https://sy123.ml/">winter is coming.</a></h2>
  </div>
  <nav><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>V2Ray_WebSocket_TLS_CDN</h1>
  </div>
<div class="meta">
  <div>2020-02-23 04:19</div>
  </div>
<div class="content">
  <p>V2Ray+WebSocket+TLS+CDN
发表于 2019-10-04  |  分类于 人工智能  |  没有评论
可能是由于最近墙的升级，使用SS等方式翻墙IP被墙的概率大大提升（2台小鸡GG，然后新开一台搭建SS，使用2天就GG），所以写一篇介绍全新的姿势，可以复活已经被墙的IP。在速度和稳定性上选择了后者</p>
<p>重要说明本文是针对VPS的IP已经被墙的情况下，如何继续翻墙，如不想这么复杂，请参看如下文章（搭建V2Ray使用特有的Vmess协议即可）：</p>
<p><a href="https://www.codercto.com/a/22204.html">https://www.codercto.com/a/22204.html</a></p>
<p>涉及如下：V2Ray+WebSocket+TLS+CDN</p>
<p>V2Ray是一个集成了各种翻墙协议的软件，包括Socks（目前接触到的是本机到本机）、HTTP、Shadowsocks（目前接触到的是本机到远程）、VMess等，传输载体可以是TCP、mKCP、WebSocket等
使用WebSocket：因为CDN可以转发WS流量
使用https（TLS）伪装网站，请求流量数据
使用CDN转发流量，同时作为连接VPS的跳板，使VPS复活和隐藏
原理图如下：</p>
<p>2 Preparations
准备工作如下：</p>
<p>一台VPS（IP已经被墙，IP假设为99.99.99.99）
域名（以zqq6666.tk为例）
注册CloudFare（免费CDN）
相关知识（Linux命令，Nginx配置，域名配置等）
免费域名注册： <a href="https://my.freenom.com/clientarea.php">https://my.freenom.com/clientarea.php</a></p>
<p>CloudFare: <a href="https://www.cloudflare.com/">https://www.cloudflare.com/</a></p>
<p>3 Installations and Configurations
3.1 安装Nginx
在VPS上，安装Nginx：</p>
<p>sudo apt=get update
sudo apt-get install nginx
编辑配置文件：</p>
<p>sudo vi /etc/nginx/sites-available/default
替换server_name：</p>
<p>将_替换为zqq6666.tk <a href="http://www.zqq6666.tk">www.zqq6666.tk</a>
重新载入Nginx：</p>
<p>nginx -s reload
3.2 申请证书
申请Let’s encrypt免费证书，先在域名注册商那里（freenom）修改dns，添加两个A记录，解析到VPS的IP 99.99.99.99，修改的原因是要向Let‘s encrypt要发起挑战，证明你拥有这个域名</p>
<p>申请证书：</p>
<p>sudo add-apt-repository ppa:certbot/certbot
sudo apt update
sudo apt install python-certbot-nginx</p>
<p>sudo certbot &ndash;authenticator webroot &ndash;webroot-path /var/www/html &ndash;installer nginx -d zqq6666.tk -d <a href="http://www.zqq6666.tk">www.zqq6666.tk</a></p>
<h1 id="会提示是否将所有http-301-重定向到https根据需要选择">会提示是否将所有http 301 重定向到https，根据需要选择</h1>
<p>运行完上述命令之后，上述Nginx的配置也会更新（添加证书配置等）</p>
<p>因为申请到的新证书的有效期为90天，所以设置定时任务，定期检测更新证书：</p>
<h1 id="m-h-dom-mon-dow-command">m h dom mon dow command</h1>
<p>23 1 * * 6 certbot renew &gt; /var/log/letsencrypt/renew.log
3.3 CDN设置
设置完证书后，就可以设置CDN</p>
<p>注册CloudFare账号，选择一个免费站点</p>
<p>更换Freenom处的NameServer为CloudFare的NameServer，把解析工作转移给CloudFare</p>
<p>等待CloudFare网站变为Active状态</p>
<p>3.4 安装配置V2Ray
VPS安装配置V2Ray</p>
<p>安装V2Ray：</p>
<h1 id="官方一键安装脚本">官方一键安装脚本</h1>
<p>bash &lt;(curl -L -s <a href="https://install.direct/go.sh">https://install.direct/go.sh</a>)
安装好后，会有V2Ray运行的端口，和一个Client的UUID PORT:26075 UUID:563a2749-ccfe-4754-959d-b8343faafeac （记住上述信息，并使用实际的更换）</p>
<p>编辑配置文件：</p>
<p>vi /etc/v2ray/config.json</p>
<h1 id="在inbound的最后settings之后追加如下配置记住videos路径">在inbound的最后（settings之后）追加如下配置，记住videos路径</h1>
<p>&ldquo;streamSettings&rdquo;: {
&ldquo;network&rdquo;: &ldquo;ws&rdquo;,
&ldquo;wsSettings&rdquo;: {
&ldquo;path&rdquo;: &ldquo;/videos/&rdquo;
}
}
重启V2Ray：</p>
<p>service v2ray restart
3.5 继续设置Nginx
继续设置Nginx，反向代理到V2Ray</p>
<p>编辑/etc/nginx/sites-available/default：</p>
<h1 id="添加类似如下设置">添加类似如下设置</h1>
<p>location /videos/ { # 路径为上面的路径
proxy_redirect off;
proxy_pass http://127.0.0.1:26075; # 端口要变成v2ray运行的端口
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection &ldquo;upgrade&rdquo;;
proxy_set_header Host $http_host;
}
3.6 客户端
客户端选择和配置</p>
<p>客户端软件MacOS可以选择V2RayX：
<a href="https://github.com/Cenmrev/V2RayX">https://github.com/Cenmrev/V2RayX</a></p>
<p>其他Windows、Android等自行解决</p>
<p>最终的配置类似如下：</p>
<p>{
&ldquo;dns&rdquo; : {
&ldquo;servers&rdquo; : [
&ldquo;8.8.8.8&rdquo;,
&ldquo;8.8.4.4&rdquo;
]
},
&ldquo;inbounds&rdquo; : [
{
&ldquo;listen&rdquo; : &ldquo;127.0.0.1&rdquo;,
&ldquo;port&rdquo; : 1086,
&ldquo;protocol&rdquo; : &ldquo;socks&rdquo;,
&ldquo;tag&rdquo; : &ldquo;socksinbound&rdquo;,
&ldquo;settings&rdquo; : {
&ldquo;auth&rdquo; : &ldquo;noauth&rdquo;,
&ldquo;udp&rdquo; : true,
&ldquo;ip&rdquo; : &ldquo;127.0.0.1&rdquo;
}
},
{
&ldquo;listen&rdquo; : &ldquo;127.0.0.1&rdquo;,
&ldquo;port&rdquo; : 1087,
&ldquo;protocol&rdquo; : &ldquo;http&rdquo;,
&ldquo;tag&rdquo; : &ldquo;httpinbound&rdquo;,
&ldquo;settings&rdquo; : {
&ldquo;timeout&rdquo; : 0
}
}
],
&ldquo;outbounds&rdquo; : [
{
&ldquo;sendThrough&rdquo; : &ldquo;0.0.0.0&rdquo;,
&ldquo;mux&rdquo; : {
&ldquo;enabled&rdquo; : false,
&ldquo;concurrency&rdquo; : 8
},
&ldquo;protocol&rdquo; : &ldquo;vmess&rdquo;,
&ldquo;settings&rdquo; : {
&ldquo;vnext&rdquo; : [
{
&ldquo;address&rdquo; : &ldquo;zqq6666.tk&rdquo;,
&ldquo;users&rdquo; : [
{
&ldquo;id&rdquo; : &ldquo;563a2749-ccfe-4754-959d-b8343faafeac&rdquo;, # 注意
&ldquo;alterId&rdquo; : 64,
&ldquo;security&rdquo; : &ldquo;auto&rdquo;,
&ldquo;level&rdquo; : 1
}
],
&ldquo;port&rdquo; : 443
}
]
},
&ldquo;tag&rdquo; : &ldquo;vultr&rdquo;,
&ldquo;streamSettings&rdquo; : {
&ldquo;wsSettings&rdquo; : {
&ldquo;path&rdquo; : &ldquo;/videos/&quot;, # 注意
&ldquo;headers&rdquo; : {</p>
<pre><code>      }
    },
    &quot;quicSettings&quot; : {
      &quot;key&quot; : &quot;&quot;,
      &quot;security&quot; : &quot;none&quot;,
      &quot;header&quot; : {
        &quot;type&quot; : &quot;none&quot;
      }
    },
    &quot;tlsSettings&quot; : {
      &quot;allowInsecure&quot; : false,
      &quot;alpn&quot; : [
        &quot;http/1.1&quot;
      ],
      &quot;serverName&quot; : &quot;zqq6666.tk&quot;, # 注意
      &quot;allowInsecureCiphers&quot; : false
    },
    &quot;httpSettings&quot; : {
      &quot;path&quot; : &quot;&quot;
    },
    &quot;kcpSettings&quot; : {
      &quot;header&quot; : {
        &quot;type&quot; : &quot;none&quot;
      },
      &quot;mtu&quot; : 1350,
      &quot;congestion&quot; : false,
      &quot;tti&quot; : 20,
      &quot;uplinkCapacity&quot; : 5,
      &quot;writeBufferSize&quot; : 1,
      &quot;readBufferSize&quot; : 1,
      &quot;downlinkCapacity&quot; : 20
    },
    &quot;tcpSettings&quot; : {
      &quot;header&quot; : {
        &quot;type&quot; : &quot;none&quot;
      }
    },
    &quot;security&quot; : &quot;tls&quot;,
    &quot;network&quot; : &quot;ws&quot;
  }
}
</code></pre>
<p>],
&ldquo;routing&rdquo; : {
&ldquo;name&rdquo; : &ldquo;all_to_main&rdquo;,
&ldquo;domainStrategy&rdquo; : &ldquo;AsIs&rdquo;,
&ldquo;rules&rdquo; : [
{
&ldquo;type&rdquo; : &ldquo;field&rdquo;,
&ldquo;outboundTag&rdquo; : &ldquo;vultr&rdquo;,
&ldquo;port&rdquo; : &ldquo;0-65535&rdquo;
}
]
},
&ldquo;log&rdquo; : {
&ldquo;error&rdquo; : &ldquo;/var/folders/06/f9wr_cnd1mdb0h4rxv504grw0000gn/T/cenmrev.v2rayx.log/error.log&rdquo;,
&ldquo;loglevel&rdquo; : &ldquo;warning&rdquo;,
&ldquo;access&rdquo; : &ldquo;/var/folders/06/f9wr_cnd1mdb0h4rxv504grw0000gn/T/cenmrev.v2rayx.log/access.log&rdquo;
}
}
4 References
基本教程</p>
<p><a href="https://www.enterpr1se.info/2017/10/v2ray-gfw-setup/2/">https://www.enterpr1se.info/2017/10/v2ray-gfw-setup/2/</a>
<a href="https://www.aihoom.com/1274.html">https://www.aihoom.com/1274.html</a>
<a href="https://blog.csdn.net/qq_32517057/article/details/85345404">https://blog.csdn.net/qq_32517057/article/details/85345404</a>
<a href="https://blog.starryvoid.com/archives/267.html">https://blog.starryvoid.com/archives/267.html</a>
<a href="https://shenzhensuzy.wordpress.com/2018/11/28/v2ray-over-websocket-with-nginx-tls-plus-cdn/">https://shenzhensuzy.wordpress.com/2018/11/28/v2ray-over-websocket-with-nginx-tls-plus-cdn/</a>
最后一篇尤其好</p>
<p>加上CDN</p>
<p><a href="https://www.svlik.com/2113.html">https://www.svlik.com/2113.html</a>
<a href="https://blog.sprov.xyz/2019/03/11/cdn-v2ray-safe-proxy/">https://blog.sprov.xyz/2019/03/11/cdn-v2ray-safe-proxy/</a></p>
<p>背后原理</p>
<p><a href="https://fbol.org/?p=440">https://fbol.org/?p=440</a>
<a href="https://doubibackup.com/_2y705r7-2.html">https://doubibackup.com/_2y705r7-2.html</a></p>
<p>Mac客户端</p>
<p><a href="https://github.com/Cenmrev/V2RayX">https://github.com/Cenmrev/V2RayX</a></p>
<p>其他</p>
<p>iplocation
<a href="https://www.iplocation.net/">https://www.iplocation.net/</a>
免费域名
<a href="https://www.freenom.com/en/index.html?lang=en">https://www.freenom.com/en/index.html?lang=en</a></p>
</div>
<div class="disqus">
  <div id="disqus_thread"></div>
<script>





(function() { 
var d = document, s = d.createElement('script');
s.src = 'https://sy123-ml.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            
</div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 Zhili.</div>
  </div>
</footer>
</body>
</html>
