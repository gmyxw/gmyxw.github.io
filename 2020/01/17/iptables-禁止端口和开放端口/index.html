<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="zhili">
<meta name="description" content="Sed magna purus, fermentum eu, tincidunt eu, varius ut, felis. Morbi mollis tellus ac sapien. Vestibulum ullamcorper mauris at ligula. In hac habitasse platea dictumst. Vivamus in erat ut urna cursus vestibulum.
    ">
<meta name="keywords" content="博客, 技术, 生物信息，精准医疗, 遗传咨询, 高通量技术, 算法, 学习, 作品, 写作, C&#43;&#43;, Perl">
<meta name="referrer" content="always">
<title>iptables 禁止端口和开放端口 - zhili</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="/logo/favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://sy123.netlify.app/">zhili</a></h1>
  </div>
  <nav><a href="/file/">Files</a><a href="/tags/">Tags</a><a href="/about/">About</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>iptables 禁止端口和开放端口</h1>
  </div>
<div class="meta">
  <div>2020-01-17 22:35</div>
  </div>
<div class="content">
  <h1 id="1首先介绍一下指令和相关配置文件">1.首先介绍一下指令和相关配置文件</h1>
<p>启动指令:service iptables start<br>
重启指令:service iptables restart<br>
关闭指令:service iptables stop</p>
<p>然后是相关配置:/etc/sysconfig/iptables<br>
如何操作该配置呢？<br>
vim /etc/sysconfig/iptables<br>
然后进去修改即可，修改完了怎么办？这里很多人会想到/etc/rc.d/init.d/iptables save指令，但是一旦你这么干了你刚才的修改内容就白做了。。。<br>
具体方法是：<br>
只修改/etc/sysconfig/iptables 使其生效的办法是修改好后先service iptables restart，然后才调用/etc/rc.d/init.d/iptables save，<br>
因为/etc/rc.d/init.d/iptables save会在iptables服务启动时重新加载，要是在重启之前直接先调用了/etc/rc.d/init.d/iptables save那么你<br>
的/etc/sysconfig/iptables 配置就回滚到上次启动服务的配置了，这点必须注意！！！<br>
2.下面介绍一些指令用法（主要还是man iptables看下相关资料才行）</p>
<p>-A：指定链名<br>
-p：指定协议类型<br>
-d：指定目标地址<br>
&ndash;dport：指定目标端口（destination port 目的端口）<br>
&ndash;sport：指定源端口（source port 源端口）<br>
-j：指定动作类型<br>
3.如果我不像修改文件直接打命令可以吗，当然没问题，步骤如下:</p>
<p>例如我给SSH加放行的语句：<br>
添加input记录： iptables -A INPUT -p tcp &ndash;dport 22 -j ACCEPT<br>
添加output记录： iptables -A OUTPUT -p tcp &ndash;sport 22 -j ACCEPT<br>
最后注意需要再执行一下 /etc/init.d/iptables save，这样这两条语句就保存到刚才那个/etc/sysconfig/iptables 文件中了。<br>
4.接下来说明一下步骤，如果机器不在我身边，我只能SSH进去做iptables规则，那么我必须注意每一步，千万别搞错了，否则就SSH链接不上都有可能！</p>
<p>首先要做的是给咱的SSH进行ACCEPT配置，以免直接无法连接的情况发生:<br>
1.如果SSH端口是22（这里不建议用默认端口最好改掉SSH端口）<br>
iptables -A INPUT -p tcp &ndash;dport 22 -j ACCEPT<br>
iptables -A OUTPUT -p tcp &ndash;sport 22 -j ACCEPT<br>
注意要/etc/rc.d/init.d/iptables save，以下每一步都最好执行一遍此语句，以下不再累述。</p>
<p>2.vim /etc/sysconfig/iptables确定是否已经加入配置，可以的话执行service iptables restart重启后生效</p>
<p>3.下面是很危险的操作，如果你第一步没做就会直接可能导致你连不上SSH，此步骤前切记执行第一步！！！<br>
iptables -P INPUT DROP <br>
iptables -P OUTPUT DROP <br>
iptables -P FORWARD DROP<br>
这个步骤是把所有不符合自己配置的规则ACCEPT的连接全部DROP掉，执行完以后如果咱SSH还没掉，那么谢天谢地，安全了，重启下iptables后继续下面的配置！</p>
<p>4.下面咱就不细说了，具体就是看自己服务器要开放哪些端口或者是要访问哪些端口来做具体的配置，下面是我自己的机器的配置：</p>
<p>/etc/sysconfig/iptables文件配置如下:</p>
<h1 id="generated-by-iptables-save-v147-on-fri-mar--2-195943-2012">Generated by iptables-save v1.4.7 on Fri Mar  2 19:59:43 2012</h1>
<p>*filter<br>
:INPUT DROP [0:0]<br>
:FORWARD DROP [0:0]<br>
:OUTPUT DROP [8:496]<br>
-A INPUT -m state &ndash;state RELATED,ESTABLISHED -j ACCEPT<br>
#ping使用的端口<br>
-A INPUT -p icmp -j ACCEPT<br>
-A INPUT -i lo -j ACCEPT<br>
-A INPUT -s 127.0.0.1/32 -d 127.0.0.1/32 -j ACCEPT<br>
-A INPUT -s 192.168.2.200/32 -d 192.168.2.200/32 -j ACCEPT<br>
#允许服务器自己的SSH（对外部请求来说服务器是目标所以使用&ndash;dport）<br>
-A INPUT -p tcp -m tcp &ndash;dport 22 -j ACCEPT<br>
#80端口不用说了吧，服务器网站访问端口<br>
-A INPUT -p tcp -m tcp &ndash;dport 80 -j ACCEPT<br>
-A INPUT -p tcp -m tcp &ndash;dport 3306 -j ACCEPT<br>
-A INPUT -p tcp -m tcp &ndash;dport 11211 -j ACCEPT<br>
-A INPUT -p tcp -m tcp &ndash;dport 11212 -j ACCEPT<br>
-A FORWARD -j REJECT &ndash;reject-with icmp-host-prohibited<br>
#53端口是DNS相关，TCP和UDP都要配置<br>
-A INPUT -p tcp -m tcp &ndash;dport 53 -j ACCEPT<br>
-A INPUT -p udp -m udp &ndash;dport 53 -j ACCEPT<br>
#ping使用的端口<br>
-A OUTPUT -p icmp -j ACCEPT<br>
-A OUTPUT -s 127.0.0.1/32 -d 127.0.0.1/32 -j ACCEPT<br>
-A OUTPUT -s 192.168.2.200/32 -d 192.168.2.200/32 -j ACCEPT<br>
#允许服务器SSH到其他机器（使用外部端口就使用&ndash;dport）<br>
-A OUTPUT -p tcp -m tcp &ndash;dport 22 -j ACCEPT<br>
#允许服务器自己的SSH（自已为源输出就使用&ndash;sport）<br>
-A OUTPUT -p tcp -m tcp &ndash;sport 22 -j ACCEPT<br>
#访问外部网站80端口（使用外部端口就使用&ndash;dport）<br>
-A OUTPUT -p tcp -m tcp &ndash;dport 80 -j ACCEPT<br>
#如果服务器需要访问外部网站，那么OUTPUT也需要配置53端口（使用外部端口就使用&ndash;dport）<br>
-A OUTPUT -p tcp -m tcp &ndash;dport 53 -j ACCEPT<br>
-A OUTPUT -p udp -m udp &ndash;dport 53 -j ACCEPT<br>
#如果有访问外部邮箱，那么打开邮箱相关端口（使用外部端口就使用&ndash;dport）<br>
-A OUTPUT -p tcp -m tcp &ndash;dport 465 -j ACCEPT<br>
-A OUTPUT -p tcp -m tcp &ndash;dport 25 -j ACCEPT<br>
-A OUTPUT -p tcp -m tcp &ndash;dport 110 -j ACCEPT<br>
#服务器网站访问端口（自已为源输出就使用&ndash;sport）<br>
-A OUTPUT -p tcp -m tcp &ndash;sport 80 -j ACCEPT<br>
-A OUTPUT -p tcp -m tcp &ndash;sport 3306 -j ACCEPT<br>
-A OUTPUT -p tcp -m tcp &ndash;sport 11211 -j ACCEPT<br>
-A OUTPUT -p tcp -m tcp &ndash;sport 11212 -j ACCEPT<br>
COMMIT</p>
<h1 id="completed-on-fri-mar--2-195943-2012">Completed on Fri Mar  2 19:59:43 2012</h1>
<p>5.可能有时候需要删除规则，最简单就是修改一下/etc/sysconfig/iptables然后service iptables restart,最后/etc/rc.d/init.d/iptables save即可。</p>
<p>当然也可以使用指令完成:</p>
<p>在网上找了一下，删除规则的方法：<br>
语法是： iptables -D chain rulenum [options]<br>
其中： chain 是链的意思，就是INPUT FORWARD 之类的<br>
rulenum 是规则的编号。从1 开始。可以使用  &ndash;line-numbers 列出规则的编号</p>
<h1 id="还有第二种方法第二种办法是--a-命令的映射不过用-d替换-a当你的链中规则很复杂而你不想计算它们的编号的时候这就十分有用了也就是说你如何用iptables--a-语句定义了一个规则则删除此规则时就用--d-来代替--a--其余的都不变即可">所以，例如上面要删除一个INPUT链的规则的话可以这样：iptables -D INPUT 3<br>
意思是删除第3条规则。<br>
还有第二种方法。第二种办法是 -A 命令的映射，不过用-D替换-A。当你的链中规则很复杂，而你不想计算它们的编号的时候这就十分有用了。也就是说，你如何用iptables -A&hellip;. 语句定义了一个规则，则删除此规则时就用 -D 来代替- A  其余的都不变即可。</h1>
<p>说一下上面的 &ndash;line-numbers 选项，如下面的命令：<br>
iptables -L INPUT &ndash;line-numbers   列出INPUT 链所有的规则<br>
num  target     prot opt source               destination         <br>
1    REJECT     tcp  &ndash;  anywhere             anywhere            tcp dpt:microsoft-ds reject-with icmp-port-unreachable<br>
2    REJECT     tcp  &ndash;  anywhere             anywhere            tcp dpt:135 reject-with icmp-port-unreachable<br>
3    REJECT     tcp  &ndash;  anywhere             anywhere            tcp dpt:netbios-ssn reject-with icmp-port-unreachable</p>
<p>&hellip;<br>
&hellip;<br>
删除指定行规则：<br>
[root@localhost rc.d]# iptables -D INPUT 4<br>
6.最后补充一下，如果想针对某IP进行单独开放端口可以如下配置：</p>
<p>如果我需要对内网某机器单独开放mysql端口，应该如下配置：<br>
iptables -A INPUT -s 192.168.2.6 -p tcp -m tcp &ndash;dport 3306 -j ACCEPT<br>
iptables -A OUTPUT -s 192.168.2.6 -p tcp -m tcp &ndash;sport 3306 -j ACCEPT<br>
7.彻底禁止某IP访问:</p>
<p>#屏蔽单个IP的命令是<br>
iptables -I INPUT -s 123.45.6.7 -j DROP<br>
#封整个段即从123.0.0.1到123.255.255.254的命令<br>
iptables -I INPUT -s 123.0.0.0/8 -j DROP<br>
#封IP段即从123.45.0.1到123.45.255.254的命令<br>
iptables -I INPUT -s 124.45.0.0/16 -j DROP<br>
#封IP段即从123.45.6.1到123.45.6.254的命令是<br>
iptables -I INPUT -s 123.45.6.0/24 -j DROP<br>
指令I是insert指令 但是该指令会insert在正确位置并不像A指令看你自己的排序位置，因此用屏蔽因为必须在一开始就要加载屏蔽IP，所以必须使用I命令加载，然后注意执行/etc/rc.d/init.d/iptables save进行保存后重启服务即可<br>
1、关闭所有的 INPUT FORWARD OUTPUT 只对某些端口开放。
下面是命令实现：</p>
<p>iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT DROP</p>
<p>再用命令 iptables -L -n 查看 是否设置好， 好看到全部 DROP 了
这样的设置好了，我们只是临时的， 重启服务器还是会恢复原来没有设置的状态
还要使用 service iptables save 进行保存
看到信息 firewall rules 防火墙的规则 其实就是保存在 /etc/sysconfig/iptables
可以打开文件查看 vi /etc/sysconfig/iptables
2、
下面我只打开22端口，看我是如何操作的，就是下面2个语句</p>
<p>iptables -A INPUT -p tcp &ndash;dport 22 -j ACCEPT
iptables -A OUTPUT -p tcp &ndash;sport 22 -j ACCEPT</p>
<p>再查看下 iptables -L -n 是否添加上去, 看到添加了</p>
<p>Chain INPUT (policy DROP)
target     prot opt source               destination
ACCEPT     tcp &ndash; 0.0.0.0/0            0.0.0.0/0           tcp dpt:22</p>
<p>Chain FORWARD (policy DROP)
target     prot opt source               destination</p>
<p>Chain OUTPUT (policy DROP)
target     prot opt source               destination
ACCEPT     tcp &ndash; 0.0.0.0/0            0.0.0.0/0           tcp spt:22</p>
<p>现在Linux服务器只打开了22端口，用putty.exe测试一下是否可以链接上去。
可以链接上去了，说明没有问题。</p>
<p>最后别忘记了保存 对防火墙的设置
通过命令：service iptables save 进行保存</p>
<p>iptables -A INPUT -p tcp &ndash;dport 22 -j ACCEPT
iptables -A OUTPUT -p tcp &ndash;sport 22 -j ACCEPT
针对这2条命令进行一些讲解吧
-A 参数就看成是添加一条 INPUT 的规则
-p 指定是什么协议 我们常用的tcp 协议，当然也有udp 例如53端口的DNS
到时我们要配置DNS用到53端口 大家就会发现使用udp协议的</p>
<p>而 &ndash;dport 就是目标端口 当数据从外部进入服务器为目标端口
反之 数据从服务器出去 则为数据源端口 使用 &ndash;sport</p>
<p>-j 就是指定是 ACCEPT 接收 或者 DROP 不接收
3、禁止某个IP访问
1台Linux服务器,2台windows xp 操作系统进行访问
Linux服务器ip 192.168.1.99
xp1 ip: 192.168.1.2
xp2 ip: 192.168.1.8</p>
<p>下面看看我2台xp 都可以访问的</p>
<p>192.168.1.2 这是 xp1 可以访问的，
192.168.1.8 xp2 也是可以正常访问的。</p>
<p>那么现在我要禁止 192.168.1.2 xp1 访问， xp2 正常访问，
下面看看演示</p>
<p>通过命令 iptables -A INPUT -p tcp -s 192.168.1.2 -j DROP
这里意思就是 -A 就是添加新的规则， 怎样的规则呢？ 由于我们访问网站使用tcp的，
我们就用 -p tcp , 如果是 udp 就写udp，这里就用tcp了， -s就是 来源的意思，
ip来源于 192.168.1.2 ，-j 怎么做 我们拒绝它 这里应该是 DROP</p>
<p>好，看看效果。好添加成功。下面进行验证 一下是否生效</p>
<p>一直出现等待状态 最后 该页无法显示 ，这是 192.168.1.2 xp1 的访问被拒绝了。</p>
<p>再看看另外一台 xp 是否可以访问， 是可以正常访问的 192.168.1.8 是可以正常访问的
4、如何删除规则
首先我们要知道 这条规则的编号，每条规则都有一个编号</p>
<p>通过 iptables -L -n &ndash;line-number 可以显示规则和相对应的编号
num target     prot opt source               destination
1    DROP       tcp &ndash; 0.0.0.0/0            0.0.0.0/0           tcp dpt:3306
2    DROP       tcp &ndash; 0.0.0.0/0            0.0.0.0/0           tcp dpt:21
3    DROP       tcp &ndash; 0.0.0.0/0            0.0.0.0/0           tcp dpt:80
多了 num 这一列， 这样我们就可以 看到刚才的规则对应的是 编号2</p>
<p>那么我们就可以进行删除了
iptables -D INPUT 2
删除INPUT链编号为2的规则。</p>
<p>再 iptables -L -n 查看一下 已经被清除了。
5、过滤无效的数据包
假设有人进入了服务器，或者有病毒木马程序，它可以通过22，80端口像服务器外传送数据。
它的这种方式就和我们正常访问22，80端口区别。它发向外发的数据不是我们通过访问网页请求
而回应的数据包。</p>
<p>下面我们要禁止这些没有通过请求回应的数据包，统统把它们堵住掉。</p>
<p>iptables 提供了一个参数 是检查状态的，下面我们来配置下 22 和 80 端口，防止无效的数据包。</p>
<p>iptables -A OUTPUT -p tcp &ndash;sport 22 -m state &ndash;state ESTABLISHED -j ACCEPT</p>
<p>可以看到和我们以前使用的：
iptables -A OUTPUT -p tcp &ndash;sport 22 -j ACCEPT
多了一个状态判断。</p>
<p>同样80端口也一样， 现在删掉原来的2条规则，
iptables -L -n &ndash;line-number    这个是查看规则而且带上编号。我们看到编号就可以
删除对应的规则了。</p>
<p>iptables -D OUTPUT 1     这里的1表示第一条规则。</p>
<p>当你删除了前面的规则， 编号也会随之改变。看到了吧。</p>
<p>好，我们删除了前面2个规则，22端口还可以正常使用，说明没问题了</p>
<p>下面进行保存，别忘记了，不然的话重启就会还原到原来的样子。</p>
<p>service iptables save    进行保存。</p>
<p>Saving firewall rules to /etc/sysconfig/iptables:          [ OK ]
其实就是把刚才设置的规则写入到 /etc/sysconfig/iptables 文件中。
6、DNS端口53设置
下面我们来看看如何设置iptables来打开DNS端口，DNS端口对应的是53</p>
<p>大家看到我现在的情况了吧，只开放22和80端口， 我现在看看能不能解析域名。</p>
<p>hostwww.google.com    输入这个命令后，一直等待，说明DNS不通</p>
<p>出现下面提示 ：
;; connection timed out; no servers could be reached</p>
<p>ping 一下域名也是不通
[root@localhost ~pingwww.google.com
ping: unknown hostwww.google.com</p>
<p>我这里的原因就是 iptables 限制了53端口。</p>
<p>有些服务器，特别是Web服务器减慢，DNS其实也有关系的，无法发送包到DNS服务器导致的。</p>
<p>下面演示下如何使用 iptables 来设置DNS 53这个端口，如果你不知道 域名服务端口号，你</p>
<p>可以用命令 : grep domain /etc/services</p>
<p>[root@localhost ~grep domain /etc/services
domain          53/tcp                          # name-domain server
domain          53/udp
domaintime      9909/tcp                        # domaintime
domaintime      9909/udp                        # domaintime</p>
<p>看到了吧， 我们一般使用 udp 协议。</p>
<p>好了， 开始设置。。。</p>
<p>iptables -A OUTPUT -p udp &ndash;dport 53 -j ACCEPT
这是我们 ping 一个域名，数据就是从本机出去，所以我们先设置 OUTPUT，
我们按照ping这个流程来设置。</p>
<p>然后 DNS 服务器收到我们发出去的包，就回应一个回来
iptables -A INPUT -p udp &ndash;sport 53 -j ACCEPT</p>
<p>同时还要设置
iptables -A INPUT -p udp &ndash;dport 53 -j ACCEPT
iptables -A OUTPUT -p udp &ndash;sport 53 -j ACCEPT</p>
<p>好了， 下面开始测试下， 可以用 iptables -L -n 查看设置情况，确定没有问题就可以测试了</p>
<p>[root@localhost ~iptables -L -n
Chain INPUT (policy DROP)
target     prot opt source               destination
ACCEPT     tcp &ndash; 0.0.0.0/0            0.0.0.0/0           tcp dpt:22
ACCEPT     tcp &ndash; 0.0.0.0/0            0.0.0.0/0           tcp dpt:80
ACCEPT     udp &ndash; 0.0.0.0/0            0.0.0.0/0           udp spt:53
ACCEPT     udp &ndash; 0.0.0.0/0            0.0.0.0/0           udp dpt:53</p>
<p>Chain FORWARD (policy DROP)
target     prot opt source               destination</p>
<p>Chain OUTPUT (policy DROP)
target     prot opt source               destination
ACCEPT     tcp &ndash; 0.0.0.0/0            0.0.0.0/0           tcp spt:22 state ESTABLISHED
ACCEPT     tcp &ndash; 0.0.0.0/0            0.0.0.0/0           tcp spt:80 state ESTABLISHED
ACCEPT     udp &ndash; 0.0.0.0/0            0.0.0.0/0           udp dpt:53
ACCEPT     udp &ndash; 0.0.0.0/0            0.0.0.0/0           udp spt:53</p>
<p>可以测试一下 是否 DNS 可以通过iptables 了。</p>
<p>[root@localhost ~hostwww.google.com
www.google.comis an alias forwww.l.google.com.
www.l.google.comis an alias for www-china.l.google.com.
www-china.l.google.com has address 64.233.189.104
www-china.l.google.com has address 64.233.189.147
www-china.l.google.com has address 64.233.189.99</p>
<p>正常可以解析 google 域名。</p>
<p>ping 方面可能还要设置些东西。</p>
<p>用 nslookup 看看吧</p>
<p>[root@localhost ~nslookup</p>
<blockquote>
<p><a href="http://www.google.com">www.google.com</a>
Server:         192.168.1.1
Address:        192.168.1.1#53</p>
</blockquote>
<p>Non-authoritative answer:
<a href="http://www.google.comcanonical">www.google.comcanonical</a> name =www.l.google.com.
<a href="http://www.l.google.com">www.l.google.com</a>        canonical name = www-china.l.google.com.
Name:   www-china.l.google.com
Address: 64.233.189.147
Name:   www-china.l.google.com
Address: 64.233.189.99
Name:   www-china.l.google.com
Address: 64.233.189.104</p>
<p>说明本机DNS正常， iptables 允许53这个端口的访问。
7、iptables对ftp的设置
现在我开始对ftp端口的设置，按照我们以前的视频，添加需要开放的端口
ftp连接端口有2个 21 和 20 端口，我现在添加对应的规则。</p>
<p>[root@localhost rootiptables -A INPUT -p tcp &ndash;dport 21 -j ACCEPT
[root@localhost rootiptables -A INPUT -p tcp &ndash;dport 20 -j ACCEPT
[root@localhost rootiptables -A OUTPUT -p tcp &ndash;sport 21 -j ACCEPT
[root@localhost rootiptables -A OUTPUT -p tcp &ndash;sport 20 -j ACCEPT</p>
<p>好，这样就添加完了，我们用浏览器访问一下ftp,出现超时。</p>
<p>所以我刚才说 ftp 是比较特殊的端口，它还有一些端口是 数据传输端口，
例如目录列表， 上传 ，下载 文件都要用到这些端口。</p>
<p>而这些端口是 任意 端口。。。 这个 任意 真的比较特殊。</p>
<p>如果不指定什么一个端口范围， iptables 很难对任意端口开放的，
如果iptables允许任意端口访问， 那和不设置防火墙没什么区别，所以不现实的。</p>
<p>那么我们的解决办法就是 指定这个数据传输端口的一个范围。</p>
<p>下面我们修改一下ftp配置文件。</p>
<p>我这里使用vsftpd来修改演示，其他ftp我不知道哪里修改，大家可以找找资料。</p>
<p>[root@localhost rootvi /etc/vsftpd.conf</p>
<p>在配置文件的最下面 加入</p>
<p>pasv_min_port=30001
pasv_max_port=31000</p>
<p>然后保存退出。</p>
<p>这两句话的意思告诉vsftpd, 要传输数据的端口范围就在30001到31000 这个范围内传送。</p>
<p>这样我们使用 iptables 就好办多了，我们就打开 30001到31000 这些端口。</p>
<p>[root@localhost rootiptables -A INPUT -p tcp &ndash;dport 30001:31000 -j ACCEPT
[root@localhost rootiptables -A OUTPUT -p tcp &ndash;sport 30001:31000 -j ACCEPT</p>
<p>[root@localhost rootservice iptables save</p>
<p>最后进行保存， 然后我们再用浏览器范围下 ftp。可以正常访问</p>
<p>用个账号登陆上去，也没有问题，上传一些文件上去看看。</p>
<p>看到了吧，上传和下载都正常。。 再查看下 iptables 的设置</p>
<p>[root@localhost rootiptables -L -n
Chain INPUT (policy DROP)
target     prot opt source               destination
ACCEPT     tcp &ndash; 0.0.0.0/0            0.0.0.0/0          tcp dpt:22
ACCEPT     tcp &ndash; 0.0.0.0/0            0.0.0.0/0          tcp dpt:21
ACCEPT     tcp &ndash; 0.0.0.0/0            0.0.0.0/0          tcp dpt:20
ACCEPT     tcp &ndash; 0.0.0.0/0            0.0.0.0/0          tcp dpts:30001:31000</p>
<p>Chain FORWARD (policy DROP)
target     prot opt source               destination</p>
<p>Chain OUTPUT (policy DROP)
target     prot opt source               destination
ACCEPT     tcp &ndash; 0.0.0.0/0            0.0.0.0/0          tcp spt:22
ACCEPT     tcp &ndash; 0.0.0.0/0            0.0.0.0/0          tcp spt:21
ACCEPT     tcp &ndash; 0.0.0.0/0            0.0.0.0/0          tcp spt:20
ACCEPT     tcp &ndash; 0.0.0.0/0            0.0.0.0/0          tcp spts:30001:31000</p>
<p>这是我为了演示ftp特殊端口做的简单规则，大家可以添加一些对数据包的验证
例如 -m state &ndash;state ESTABLISHED,RELATED 等等要求更加高的验证</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#998;font-style:italic">#Flush existing rules</span>
iptables -F
<span style="color:#998;font-style:italic"># Set up default DROP rule for eth0</span>
iptables -P INPUT DROP
<span style="color:#998;font-style:italic"># Allow existing connections to continue</span>
iptables -A INPUT -i eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT
<span style="color:#998;font-style:italic"># Accept everything from the 192.168.1.x network</span>
iptables -A INPUT -i eth0 -s 192.168.1.0/24 -j ACCEPT
<span style="color:#998;font-style:italic"># Allow connections from this host to 192.168.2.10</span>
iptables -A OUTPUT -o eth0 -d 192.168.2.10 -j ACCEPT

<span style="color:#998;font-style:italic">#(repeat this line as needed)</span>
iptables -I INPUT -s &lt;allowed_ip&gt; -j ACCEPT 
iptables -P INPUT DROP
</code></pre></td></tr></table>
</div>
</div><p>主动模式
1
iptables -A INPUT -m state &ndash;state RELATED,ESTABLISHED -j ACCEPT
  首先对自己主动发送的请求进行响应的报文放行，这里尤其注意是对自己已发送的报文进行响应，如果是其他客户端发送过来的请求连接这里不做处理，使用默认的或后续的匹配策略处理。
因为在iptables看来每个协议都有建立连接的概念，包括“udp”、“icmp”。state支持的状态有：NEW、ESTABLISHED、RELATED、INVALID、UNTRACKED。</p>
<p>NEW：就是双方进行通信时第一个到来的报文；
ESTABLISHED：state把NEW以后到来的报文都定义为ESTABLISHED状态，包括UDP等，所以说state是有类似于tcp三次握手建立连接的概念；
RELATED：在一个服务中，可能开启了两个进程，而且这两个进程都需要跟服务器进行通信，例如FTP有两个通信链路，命令链路和传输数据的链路，这两个链路就是存在关系的，所以他们属于RELATED状态；
INVALID：表示一个包不能被识别；
UNTRACKED：表示报文不能被追踪；
为SSH加固
1
iptables -A INPUT -p icmp &ndash;icmp-type 8 -m length &ndash;length 128 -m recent &ndash;set &ndash;name SSH &ndash;rsource -j ACCEPT
  length模块用于匹配报文长度，这里我们用ping报文的长度来充当芝麻开门的作用，recent模块功能很强，能将匹配到的报文信息记录下来，给后续规则做条件使用。它的几个参数为：</p>
<p>—name： 给用来记录报文的列表起名称；（这里应该是两个-）
—set： 表示将匹配到的报文记录下来；
—rsource: 表示记录源IP地址；
  这条指令的意思是：将ping报文长度为128的源IP地址记录到叫SSH的列表中去。这里需要注意的是ping报文头部长度就有28字节，所以实际的填充报文为：128-28=100。所以在Linux下使用ping -s 100 ip；在Windows下使用ping -l 100 ip来敲开服务器大门。</p>
<p>  相关的icmp报文的类型如下（因为ssh客户端是ping的请求方（发起方），所以这里要匹配类型为8的报文）：</p>
<table>
<thead>
<tr>
<th>类型代码</th>
<th>类型描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>响应应答（ECHO-REPLY）</td>
</tr>
<tr>
<td>3</td>
<td>不可到达</td>
</tr>
<tr>
<td>4</td>
<td>源抑制</td>
</tr>
<tr>
<td>5</td>
<td>重定向</td>
</tr>
<tr>
<td>8</td>
<td>响应请求（ECHO-REQUEST）</td>
</tr>
<tr>
<td>11</td>
<td>超时</td>
</tr>
<tr>
<td>12</td>
<td>参数失灵</td>
</tr>
<tr>
<td>13</td>
<td>时间戳请求</td>
</tr>
<tr>
<td>14</td>
<td>时间戳应答</td>
</tr>
<tr>
<td>15</td>
<td>信息请求（*已作废）</td>
</tr>
<tr>
<td>16</td>
<td>信息应答（*已作废）</td>
</tr>
<tr>
<td>17</td>
<td>地址掩码请求</td>
</tr>
<tr>
<td>18</td>
<td>地址掩码应答</td>
</tr>
</tbody>
</table>
<p>iptables -A INPUT -p tcp &ndash;dport 8888 -m state &ndash;state NEW -m recent &ndash;rcheck &ndash;seconds 20 &ndash;name SSH &ndash;rsource -j ACCEPT
  8888是ssh修改后的端口号，这里之所以匹配NEW状态是因为后面我们需要对INPUT使用白名单策略，而NEW之后的状态在前面已经放行，所以这里需要对NEW状态进行放行。这里再对recent的两个参数进行说明：</p>
<p>—rcheck： 检查源IP是否在列表中，以第一个匹配开始计算时间
—seconds： 记录的源IP地址的有效时间
  所以这一整句话是说对NEW（新建）状态下请求8888端口的源IP进行检查，看这个IP是否在名叫SSH的列表之中，有效时间是20秒，这里的有效时间是指上一条规则记录下源IP的时间离用户请求SSH服务器的时间间隔。所以用户必须在ping完的20秒内连接客户端，否则连接失败，重新ping。</p>
<p>PS： 如果是私有的git服务器的话，也同样适用这套规则，登陆或clone、push前都需要进行特殊的操作，这就能很好的保护数据和服务器的安全问题。不要以为这是弱智的问题，，这两天逛tools的时候就有人的git服务器被人攻破。。。
将INPUT策略改成白名单模式
  白名单是只接受自己信任的来源，而对非信任区来源采用拒绝策略；黑名单则只拒绝自己不信任的来源，接受信任或目的不明确的来源。所以采用白名单的策略系统的安全性较高，而黑名单难免会有疏忽。</p>
<p>  要使用白名单，只需将INPUT的默认策略从ACCEPT改成DROP。可以使用iptables -P DROP,但如果一不小心清空了ACCEPT的规则，那么服务器将按照默认drop的策略拒绝所有的连接，导致服务器失联。所以我们使用另一种较为安全的策略：</p>
<p>1
iptables -A INPUT -j DROP
  我们在INPUT链的最后一条上加上DROP规则，这样即使我们不小心iptables -F INPUT清除掉INPUT规则也不用担心服务器失联。</p>
<p>  值得一提的是，由于采用了DROP策略，所以ping只接收长度为100的报文，也就是说正常的ping是不会被服务器接收的，这就提供了保护主机的安全的方法，相当于把主机从公网中隐藏起来，只有知道口令的人才能找得到。</p>
<p>保存iptables配置
  笔者主机为：Ubuntu 16.04，首先安装：</p>
<p>1
2
apt install iptables-persistent
apt install netfilter-persistent    # ubuntu 14.04可以不用
  保存：</p>
<p>1
netfilter-persistent save
  在/etc/rc.local中添加开机时自动执行恢复操作：</p>
<p>1
netfilter-persistent reload
后言
  这里只是简单的在INPUT中加固了ssh连接，但对其他类似web的服务没有讲解，但这并不是说iptables对这些服务没有办法，相反，iptables能很好的加强系统安全。比如有些服务不想暴露给外部直接访问，只允许本地处理。这时我们就能使用类似于这样的规则：</p>
<p>1
iptables -I INPUT ! -s 127.0.0.1 -j DROP
  通过配置iptables还可以在有限程度上防止CC攻击、DDOS等攻击，它可用的一些模块还有：</p>
<p>string： 可以匹配链路中出现的特定字符；
time： 对链路的时间规则；
limit： 对IP的并发限制；</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#998;font-style:italic"># At first you should always flush to be sure whats already defined… nothing</span>

iptables -F

<span style="color:#998;font-style:italic"># Then set the default policy of the INPUT chain to DROP if the end is reached and no rule matched:</span>

iptables -P INPUT DROP

<span style="color:#998;font-style:italic"># To ensure the loopback is not affacted you should add</span>

iptables -A INPUT -i lo -p all -j ACCEPT
iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT

<span style="color:#998;font-style:italic"># to allow all traffic on the lo-if and every incomming traffic for connections </span>
<span style="color:#998;font-style:italic"># you etablished. After that add every rule you need for </span>
<span style="color:#998;font-style:italic"># your services (don&#39;t forget to open ssh if you need it! else you&#39;re out):</span>

iptables -A INPUT -p tcp -m tcp --dport <span style="color:#099">1962</span> -j ACCEPT 
iptables -A INPUT -p tcp -m tcp --dport <span style="color:#099">999</span> -j ACCEPT 
iptables -A INPUT -p tcp -m tcp --dport <span style="color:#099">12020</span> -j ACCEPT 

<span style="color:#998;font-style:italic"># A little trick I do to keep myself and others from accidentally drilling holes into the security I finally add:</span>

iptables -A INPUT -j DROP

<span style="color:#998;font-style:italic"># This line matches everything for the INPUT chain and the policy should not get anything. </span>
<span style="color:#998;font-style:italic"># advantage of this is even if you add an</span>
<span style="color:#998;font-style:italic"># ACCEPT-rule sometime after initializing your ruleset it will never become checked because </span>
<span style="color:#998;font-style:italic"># everything is droped before. so it ensures </span>
<span style="color:#998;font-style:italic"># you have to keep everything in one place.</span>

<span style="color:#998;font-style:italic"># For your question the whole thing looks like this in summary:</span>

iptables -F
iptables -P INPUT DROP
iptables -A INPUT -i lo -p all -j ACCEPT
iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A INPUT -p tcp -m tcp --dport <span style="color:#099">1962</span> -j ACCEPT 
iptables -A INPUT -p tcp -m tcp --dport <span style="color:#099">999</span> -j ACCEPT 
iptables -A INPUT -p tcp -m tcp --dport <span style="color:#099">12020</span> -j ACCEPT 
iptables -A INPUT -j DROP
</code></pre></td></tr></table>
</div>
</div><p>这在后续博文中可能有所涉及。</p>
</div>
<div class="disqus">
  <div id="disqus_thread"></div>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/disqusjs@1.2/dist/disqusjs.css">
<script src="https://cdn.jsdelivr.net/gh/sy123s/blog@master/js/disqus.js"></script>
<script>
var dsqjs = new DisqusJS({
    shortname: 'sy123-ml',
    siteName: 'zhili',
    identifier: '',
    url: '',
    title: '',
    api: 'https://disqus.gd2.workers.dev/api/',
    apikey: 'gZw0N3utfdxezjRheJwLz3xkiUcRWno3ruWSIROPHRcYNGmwBosRpnyb8MmiknVg',
    admin: 'disqus_wvCW9l8bmG',
    adminLabel: 'zhili'
});
</script>
                            
</div>

  </article>
</main>
<footer>
  <div>
    <div>
      2007-2020 zhili.</div>
  </div>
</footer>
</body>
</html>
